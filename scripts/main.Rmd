---
title: "Blood cell type deconvolution"
author: "Max J. Karlsson"
date: "2020 M01 17"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

#Setup

```{r setup, include=FALSE}

library(tidyverse)
require(magrittr)
require(viridis)
require(NOISeq)
require(broom)
require(quadprog)
require(patchwork)
require(pheatmap)
require(igraph)
require(ggalluvial)
require(ggdendro)
require(ggraph)
require(pcaMethods)
library(umap)
require(ggrepel)
require(ggbeeswarm)
require(mixOmics)
require(caret)
require(doParallel)
require(gganimate)
require(tidygraph)
library(dendextend)
plsda <- caret::plsda
splsda <- mixOmics::splsda
select <- dplyr::select
pca <- pcaMethods::pca

source("scripts/functions_classification.R")
source("scripts/functions_graphics.R")
source("scripts/functions_normalization.R")
source("scripts/functions_utility.R")
source("scripts/theme.R")
```

```{r}


# HPA data

gene_tissue_categories_HPA <- 
  read_delim("data/consensus_all_category_92.tsv", delim = "\t")

gene_blood_categories_HPA <- 
  read_delim("data/bloodcells_hpa_category_92.tsv", delim = "\t")

gene_blood_lineage_categories_HPA <- 
  read_delim("data/bloodcells_hpa_regional_category_92.tsv", delim = "\t")

blood_cell_hierarchy <- 
  read_delim("data/meta/blood_atlas_hierarchy.txt", delim = "\t")

gene_info92 <- 
  read_delim("data/geninfo_92.tsv", delim = "\t")

HPA_data <- 
  read_delim("data/HPA/rna_tissue_consensus_HPA19.tsv", delim = "\t")

HPA_consensus <- 
  read_delim("data/HPA/consensus_max_of_all_groups_92.tsv", delim = "\t")

###
CD_marker_list <- 
  read_delim("data/20180628 CD markers ProteinAtlas.tsv", delim = "\t")

cell_markers <- 
  read_delim("data/meta/20200702 Cell type markers.tsv", delim = "\t") %>% 
  select(tissue = 1, 
         cell_type_group = 2, 
         cell_type = 3,
         gene_name = 4) %>%
  left_join(gene_info92) %>%
  filter(!is.na(ensg_id)) %>%
  filter(gene_name == "IGF2" & ensg_id == "ENSG00000167244" | gene_name != "IGF2")

cell_markers %>% 
  group_by(cell_type) %>% 
  summarise(n = n_distinct(gene_name)) %>% 
  arrange(n) %>% 
  mutate(cell_type = factor(cell_type, cell_type)) %>% 
  ggplot(aes(n, cell_type)) + 
  geom_col() + 
  geom_text(aes(label = n), hjust = 0) + 
  stripped_theme +
  ggtitle("Number of markers per cell type")

max_cell_markers <- 
  read_csv("data/meta/20200313 cell markers max.csv") %>% 
  mutate(tissue = "General", 
         annotator = "Max") %>%
  select(tissue, 
         cell_type = marker_for, 
         gene_name, 
         ensg_id, 
         annotator)
 
cluster_norm_count <- 
  read_delim("data/cluster expression/20200628/sc_tissue_cluster_exp_0628.tab", delim = "\t") %>% 
  rename(ensg_id = ensembl_gene_id, 
         norm_count = exp)
  

dataset_map <- 
  c('breast' = 'Breast',
    'colon' = 'Colon',
    'colon2' = 'Colon',
    'eye' = 'Eye',
    'eye_macula' = 'Eye',
    'eye_peripheral' = 'Eye',
    'heart' = 'Heart muscle',
    'ileum' = 'Small intestine',
    'kidney' = 'Kidney',
    'liver1' = 'Liver',
    'lung' = 'Lung',
    'muscle' = 'Skeletal muscle',
    'placenta' = 'Placenta',
    'placenta2' = 'Placenta',
    'prostate' = 'Prostate',
    'prostate2' = 'Prostate',
    'prostate3' = 'Prostate',
    'testis1' = 'Testis',
    'testis2' = 'Testis',
    'testis3' = 'Testis',
    'testis4' = 'Testis',
    'rectum' = 'Rectum',
    'liver_hep_neg_cd45_neg' = 'Liver',
    'liver_hep_neg_cd45_pos' = 'Liver',
    'lymph_node_axillary' = 'Lymph node',
    'lymph_node_head_neck' = 'Lymph node',
    'nk_cell_blood' = 'Lymph node',
    'nk_cell_bone_marrow' = 'Lymph node',
    'pbmc1' = 'Lymph node') %>%
  enframe("dataset", "tissue_type") %>%
  left_join(cluster_norm_count %>% 
              select(tissue_id, dataset = tissue) %>% 
              distinct()) %>%
  # mutate(tissue_id = as.character(tissue_id)) %>%
  left_join(c('Breast' = 'breast',
              'Colon' = 'intestine',
              'Eye' = 'retina',
              'Heart muscle' = 'heart muscle',
              'Small intestine' = 'intestine',
              'Kidney' = 'kidney',
              'Liver' = 'liver',
              'Lung' = 'lung',
              'Skeletal muscle' = 'skeletal muscle',
              'Placenta' = 'placenta',
              'Prostate' = 'prostate',
              'Testis' = 'testis',
              'Rectum' = 'intestine',
              'Lymph node' = 'lymphoid tissue') %>% 
              enframe("tissue_type", "consensus_tissue"))

### Annotation

cluster_annotation <-
  read_delim("data/annotation/cell_type_annotation_200628_complete.tab", delim = "\t")  %>% 
  filter(!is.na(tissue_name)) %>%
    mutate(assay_id = as.numeric(assay_id)) %>%
  mutate(cell_type_name = trimws(cell_type_name),
         group_name = trimws(group_name)) %>%
  group_by(cell_type_name, tissue_name) %>%
    
  mutate(group_order = row_number(), 
         group_n = length(cell_type_name),
         cluster_name = ifelse(group_n == 1, 
                               paste(tissue_name, cell_type_name),
                               paste(tissue_name, cell_type_name, LETTERS[group_order]))) %>%
    select(-group_order, -group_n) %>%
  ungroup() %>%
    rename(tissue_id = assay_id) %>%
  filter(cell_type_name != "NULL") %>%
  
  mutate(cell_type_name = ifelse(cell_type_name == "Prostate glands, eptithelial cells",
                                 "Prostate glands, epithelial cells",
                                 cell_type_name)) %>% 
  mutate(cell_type_name = case_when(cell_type_name == "Prostate glands, epithelial cells" ~
                                      "Glandular cells",
                                    cell_type_name == "Prostate glands, basal cells" ~
                                      "Basal glandular cells",
                                    cell_type_name == "Renal tubules, proximal cells" ~
                                      "Proximal tubular cells",
                                    cell_type_name == "Renal tubules, distal cells" ~
                                      "Distal tubular cells",
                                    cell_type_name == "Basal keratinocytes (undifferentiated)" ~
                                      "Basal keratinocytes",
                                    cell_type_name == "Suprabasal keratinocytes (differentiated)" ~
                                      "Suprabasal keratinocytes",
                                    cell_type_name == "Ductal epithelial cells" ~
                                      "Ductal cells",
                                    cell_type_name == "B lymphocytes" ~
                                      "B-cells",
                                    cell_type_name == "T lymphocytes" ~
                                      "T-cells",
                                    cell_type_name == "Macrophages (Hofbauer cells)" ~
                                      "Hofbauer cells",
                                    cell_type_name == "Macrophages (Kupffer cells)" ~
                                      "Kupffer cells",
                                    cell_type_name == "Syncytotrophoblasts" ~
                                      "Syncytiotrophoblasts",
                                    cell_type_name == "Hepatic stellate cells" ~
                                      "Ito cells", 
                                    cell_type_name == "Islets of Langerhans" |
                                      cell_type_name == "islets of Langerhans" ~
                                      "Pancreatic endocrine cells", 
                                    cell_type_name == "Neuroendocrine cells" ~
                                      "Intestinal endocrine cells",
                                    cell_type_name == "Bronchial epithelium, Club cells" ~
                                      "Club cells", 
                                    cell_type_name == "Acinar cells" ~
                                      "Exocrine glandular cells",
                                    cell_type_name == "collecting duct cells" ~
                                      "Collecting duct cells",
                                    
                                    T ~ cell_type_name)) %>%
  left_join(readxl::read_excel("data/meta/20201013_cell_types.xlsx") %>% 
              select(cell_type_name = `New name`, group_name_new = `New group`) %>% 
              distinct()) %>%
  mutate(group_name = group_name_new)
# cluster_annotation$group_name1 %>% unique

cluster_marker_expression <- 
  cluster_norm_count %>%
  inner_join(cell_markers %>%
               select(ensg_id, gene_name, 
                      tissue_marker = tissue,
                      cell_type, 
                      cell_type_group), 
             by = "ensg_id") %>%
  left_join(dataset_map,
            by = c("tissue" = "dataset",
                   "tissue_id")) %>%
  filter(tissue_type == tissue_marker | tissue_marker == "_General") %>% 
  mutate(id = paste(tissue_id, cluster_id)) %>%
  left_join(cluster_annotation %>% 
              select(tissue_id, cluster_id, 
                     annotated_cell_type = cell_type_name,
                     mixed_cell_types,
                     reliability),
            by = c("tissue_id", "cluster_id"))


### Representative dataset

main_datasets <- 
  read_csv("data/meta/Main datasets.csv") %>%
  mutate(selected_dataset = tolower(Selected),
         dataset = tolower(gsub("-", "_", All)))

dataset_map %>% 
  pull(tissue_type) %>% 
  unique


cluster_annotation %>% 
  select(cell_type_name, group_name) %>% 
  group_by(group_name) %>% 
  summarise(cells = paste(sort(unique(cell_type_name)), collapse = ", ")) %>% 
  write_csv(savepath("Cell groups.csv"))

cell_type_palette %>% 
  enframe() %>%
  write_csv(savepath("cell type palette.csv"))
  
# library(tidyverse)
# library(magrittr)
# cell_type_palette <-
#   read_csv(savepath("cell type palette.csv")) %$%
#   set_names(value, name)
  
cell_colors <- 
  readxl::read_xlsx("data/meta/20201013_cell_types.xlsx") %>%
  rename(tissue = 1, 
         cell_type_name = 2, 
         group_name = 3,
         new_cell_type_name = 4, 
         new_group_name = 5, 
         color = 6)

cell_group_palette <- 
  cell_colors %>%
  select(color, new_group_name) %>% 
  distinct() %$%
  set_names(color, new_group_name) 
  

cell_type_palette <- 
  cell_colors %>%
  select(color, new_cell_type_name) %>% 
  distinct() %$%
  set_names(color, new_cell_type_name) 
  
# cluster_annotation <- 
#   cluster_annotation %>% 
#   left_join(cell_colors %>% 
#               select(cell_type_name,
#                      new_cell_type_name,
#                      new_group_name) %>%
#               distinct()) %>%View
#   mutate(cell_type_name = new_cell_type_name,
#          group_name = new_group_name)



```

#Data aggregation

```{r data_aggregation, echo=FALSE, message=FALSE, warning=FALSE}

annotated_norm_count <- 
  cluster_norm_count %>% 
  filter(tissue %in% main_datasets$dataset) %>%
  left_join(cluster_annotation) %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  filter(cell_type_name != "Neutrophils") %>%
  filter(!is.na(cell_type_name))

# annotated_norm_count %>%
# write_csv(savepath("annotated_norm_count.csv"))

annotated_norm_count_main <- 
  cluster_norm_count %>% 
  filter(tissue %in% main_datasets$selected_dataset) %>%
  left_join(cluster_annotation) %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  filter(cell_type_name != "Neutrophils") %>%
  filter(!is.na(cell_type_name))

annotated_norm_count_main %>%
  select(-cell_type_id, -other_cell_types, -internal_comment, -cluster_name, -tissue_id, -tissue) %>% 
  select(tissue_name, cluster_id, cell_type_name, group_name, 
         ensg_id, read_count, norm_count, everything()) %>% 
  write_csv(savepath("annotated_norm_count_main.csv"))

annotated_norm_count_clean <- 
  annotated_norm_count %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  filter(cell_type_name != "Neutrophils") %>%
  filter(mixed_cell_types == 0)

annotated_norm_count_clean_wide <- 
  annotated_norm_count_clean %>%
  mutate(id = paste(tissue_id, cluster_id, cell_type_name)) %>%
  select(id, norm_count, ensg_id) %>% 
  spread(ensg_id, norm_count)


cell_type_norm_count <- 
  annotated_norm_count %>% 
  group_by(ensg_id, cell_type_name) %>% 
  summarise(norm_count = median(norm_count))

cell_type_norm_count_main <- 
  annotated_norm_count_main %>% 
  group_by(ensg_id, cell_type_name) %>% 
  summarise(norm_count = median(norm_count))

cell_type_norm_count_clean <- 
  annotated_norm_count %>% 
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  filter(cell_type_name != "Neutrophils") %>%
  filter(mixed_cell_types == 0) %>%
  group_by(ensg_id, cell_type_name) %>% 
  summarise(norm_count = median(norm_count))


  
# cluster_annotation %>% 
#   select(-(1:4)) %>% 
#   select(-annotation2) %>%
#   unique() %>% View


cluster_id_map <- 
  annotated_norm_count %>% 
  select(tissue_id, tissue, cluster_id, cell_type_name, mixed_cell_types) %>%
  unique() %>%
  mutate(id = paste(tissue_id, cluster_id, cell_type_name)) 

all_clusters_map <- 
  cluster_norm_count %>%
  filter(tissue %in% main_datasets$dataset) %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  select(id, tissue_id, cluster_id, tissue) %>%
  unique() %>% 
  left_join(cluster_id_map %>% 
              select(tissue_id, cluster_id, cell_type_name, mixed_cell_types, full_id = id),
            by = c("tissue_id", "cluster_id")) %>%
  mutate(cell_type_name = ifelse(is.na(cell_type_name), "Not annotated", cell_type_name))

annotated_norm_count_wide <- 
  annotated_norm_count%>% 
  mutate(id = paste(tissue_id, cluster_id, cell_type_name)) %>%
  select(id, norm_count, ensg_id) %>% 
  spread(ensg_id, norm_count)



#####


annotated_tmm1 <-
  annotated_norm_count %>%
  unite(id, tissue, cluster_id, cell_type_name, sep = ";") %>%
  select(id, norm_count, ensg_id) %>% 
  spread(id, norm_count) %>% 
  column_to_rownames("ensg_id") %>%
  tmm_norm_median_ref(doWeighting = T,
                      logratioTrim = 0.3) %>% 
  as_tibble(rownames = "ensg_id") %>%
  gather(id, tmm, -1)  


annotated_tmm <-
  annotated_norm_count %>%
  select(tissue_id, tissue, cluster_id, ensg_id, cell_type_name, group_name, read_count,
         norm_count) %>%
  left_join(annotated_tmm1 %>% 
              separate(id, into = c("tissue", "cluster_id", "cell_type_name"), sep = ";") %>%
              mutate(cluster_id = as.numeric(cluster_id)))

annotated_tmm_main <- 
  annotated_tmm %>%
  filter(tissue %in% main_datasets$selected_dataset) %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  filter(cell_type_name != "Neutrophils") %>%
  filter(!is.na(cell_type_name))


cell_type_tmm_main <-
  annotated_tmm_main %>% 
  group_by(ensg_id, cell_type_name) %>% 
  summarise(tmm = median(tmm)) %>%
  ungroup()


#### Save data
# cell_markers %>%
#   write_csv(savepath("cell markers.csv"))
# 
# annotated_norm_count %>%
#   write_csv(savepath("annotated norm count.csv"))
# 
# annotated_tmm_main %>%
#   write_csv(savepath("annotated_tmm_main.csv"))
# 
# cell_type_tmm_main %>%
#   write_csv(savepath("cell_type_tmm_main.csv"))
# 
# 
# main_datasets %>%
#   write_csv(savepath("main datasets.csv"))
# 
# cell_type_norm_count %>%
#   write_csv(savepath("cell type norm count.csv"))


```


#Basic plots

```{r basic_plots, echo=FALSE, message=FALSE, warning=FALSE}

cell_colors %>% 
  select(group = new_group_name,
         color) %>% 
  distinct() %>%
  ggplot(aes(1, 1, color = group, label = group)) + 
  geom_point(size = 30,
             show.legend = F) +
  geom_text(color = "black",
            show.legend = F) +
  facet_wrap(~group) +
  scale_color_manual(values = cell_group_palette) +
  theme_void() +
  theme(strip.text = element_blank(),
        strip.background = element_blank())
ggsave(savepath("Suggested cell group color.pdf"), width = 8, height = 8)

#

data_stats <- 
  cluster_norm_count %>% 
  left_join(cluster_annotation) %>%
  group_by(cluster_id, tissue) %>% 
  summarise(median = median(norm_count),
            mean = mean(norm_count),
            IQR = IQR(norm_count),
            sum = sum(norm_count)) 
  
plot_data <- 
  data_stats %>%
  gather(metric, value, -(1:3)) 
  
##### Data distribution
# g <-
#   annotated_norm_count %>%
#   mutate(id = paste(tissue_id, cluster_id)) %>%
#   ggplot(aes(id, norm_count)) +
#   geom_violin(draw_quantiles = 0.5, scale = "width") +
#   scale_y_log10() +
#   theme_minimal()
# ggsave(savepath("Data distribution violins.pdf"), plot = g, width = 40, height = 6)
# 
# g <-
#   annotated_norm_count %>%
#   mutate(id = paste(tissue_id, cluster_id)) %>%
#   ggplot(aes(id, norm_count)) +
#   geom_boxplot(outlier.color = NA) +
#   scale_y_log10() +
#   theme_minimal()
# ggsave(savepath("Data distribution boxes.pdf"), plot = g, width = 20, height = 6)
```

```{r cluster_clustering}

annotated_norm_count_wide_2 <- 
  annotated_norm_count %>%
  select(tissue_id, tissue, cluster_id, ensg_id, norm_count, cell_type_name) %>% 
  group_by(ensg_id) %>%
  mutate(sd = sd(norm_count)) %>%
  ungroup() %>% 
  filter(sd > 0) %>%
  select(-sd) %>%
  spread(ensg_id, norm_count) %>%
  mutate(id = paste(tissue, cluster_id, cell_type_name, sep = ";")) %>% 
  select(id, everything())

annotated_norm_count_wide_id <- 
  annotated_norm_count_wide_2 %>%
  select(-tissue_id, -tissue, -cluster_id, -cell_type_name) %>% 
  column_to_rownames("id") 
  
cluster_cor <- 
  annotated_norm_count_wide_id %>%
  # {.[1:10, 1:10]} %>%
  {log10(. + 1)} %>%
  t() %>%
  cor(method = "spearman")

# Computationally expensive, uncomment if you want to run:
# cluster_propr <- 
#   annotated_norm_count_wide_id %>%
#   {. + 1} %>%
#   t() %>%
#   propr::propr()

# cluster_propr@matrix %>% pheatmap

cluster_spearman <-
  cluster_cor %>%
  {1 - .} %>%
  as.dist() %>% 
  hclust(method = "average") 

cluster_spearman %>%
  ggdendrogram(rotate = T) 
ggsave(savepath("Cluster total spearman dendrogram.pdf"), width = 10, height = 35)

cluster_propr <- 
  cluster_propr@matrix %>%
  dist() %>% 
  hclust(method = "ward.D2") 

cluster_propr %>%
  ggdendrogram(rotate = T) 
ggsave(savepath("Cluster total propr dendrogram.pdf"), width = 10, height = 35)

left_join(cluster_spearman %>%
            dendro_data() %$%
            labels %>%
            as_tibble,
          cluster_propr %>%
            dendro_data() %$%
            labels %>%
            as_tibble,
          by = "label", 
          suffix = c("_spearman", "_propr")) %>%
  separate(label, into = c("tissue", "cluster_id", "cell_type"), extra = "merge", sep = ";") %>%
  group_by(cell_type) %>% 
  mutate(cell_type_x_spearman = mean(x_spearman),
         cell_type_x_propr = mean(x_propr)) %>%

  ggplot(aes(x_spearman, x_propr, color = cell_type)) +
  geom_segment(aes(xend = cell_type_x_spearman,
                   yend = cell_type_x_propr)) + 
  geom_point() +
  scale_color_manual(values = cell_type_palette)

cluster_spearman_plots <-
  lapply(unique(annotated_norm_count_wide_2$tissue),
         function(tis_) {
           p_data <- 
             annotated_norm_count_wide_2 %>%
             filter(tissue == tis_) %>%
             select(-tissue_id, -tissue, -cluster_id, -cell_type_name) %>% 
             column_to_rownames("id") 
           
           p_data %>%
             t() %>%
             cor(method = "spearman") %>%
             {1 - .} %>%
             as.dist() %>% 
             hclust(method = "average") %>%
             ggdendrogram(rotate = T) +
             ggtitle(tis_)
         })
pdf(savepath("Cluster tissue-wise spearman dendrogram.pdf"), width = 6, height = 6)
cluster_spearman_plots
dev.off()

# ###
# cluster_plsda <-
#   annotation_model_scores %>%
#   left_join(dataset_map %>% 
#               select(tissue_id, dataset)) %>%
#   mutate(id = paste(dataset, cluster_id, Y, sep = " ")) %>% 
#   select(id, everything()) %>%
#   select(-Y, -tissue_id, -cluster_id, -class_id, -id1, -dataset) %>%
#   column_to_rownames("id") %T>%
#   pheatmap(cluster_cols = F,
#            clustering_method = "ward.D2") %>% 
#   dist() %>% 
#   hclust(method = "ward.D2")
#   
# cluster_plsda %>%
#   ggdendrogram(rotate = T) 
# ggsave(savepath("Cluster total plsda dendrogram.pdf"), width = 10, height = 35)
# 
# cluster_plsda_plots <-
#   lapply(sort(unique(annotation_model_scores$tissue_id)),
#          function(tis_id) {
#            p_data <- 
#              annotation_model_scores %>%
#              left_join(dataset_map %>% 
#                          select(tissue_id, dataset)) %>%
#              mutate(id = paste(dataset, cluster_id, Y, sep = " ")) %>% 
#              select(id, everything()) %>%
#              filter(tissue_id ==  tis_id)
#            
#            titl <- unique(p_data$dataset)
#            p_data %>%
#              select(-Y, -tissue_id, -cluster_id, -class_id, -id1, -dataset) %>%
#              column_to_rownames("id") %>% 
#              dist() %>% 
#              hclust(method = "ward.D2") %>%
#              ggdendrogram(rotate = T) +
#              ggtitle(titl)
#          })
# pdf(savepath("Cluster tissue-wise plsda dendrogram.pdf"), width = 6, height = 6)
# cluster_plsda_plots
# dev.off()
```

#Normalization

```{r}

if(file.exists("data/processed/gene_propr_high.Rdata")) {
  load("data/processed/gene_propr_high.Rdata")
} else {
  gene_propr <- 
    annotated_norm_count_wide_id %>%
    {. + 1} %>%
    # {.[1:10, 1:10]} %>%
    propr::propr(p = 10)
  
  gene_propr_high <- 
    gene_propr@matrix %>% 
    as_tibble(rownames = "ensg_id1") %>% 
    gather(ensg_id2, rho, -1) %>% 
    filter(rho > 0.9,
           ensg_id1 < ensg_id2)
  
  save(gene_propr_high,
       file = "data/processed/gene_propr_high.Rdata")
  
}

  
gene_prop_net <- 
  gene_propr_high %>% 
  as_tbl_graph() %>%
  left_join(components(.)$membership %>%
              enframe("name", "component")) %>%
  left_join(gene_info92 %>%
              select(ensg_id, gene_name),
            by = c("name" = "ensg_id")) %>%
  
  group_by(component) %>%
  mutate(component_n = n_distinct(name)) %>%
  ungroup() %>%
  filter(component_n >= 10) %>%
  arrange(component_n) %>%
  mutate(component = unclass(factor(component))) 
  
gene_prop_net %>% 
  as_tibble() %>%
  select(component, component_n) %>%
  distinct() %>%
  ggplot(aes(as_factor(component), component_n)) +
  geom_col()

library("enrichR")
gene_prop_net_enrichr <-
  gene_prop_net %>%
  as_tibble() %>%
  select(name,
         gene_name,
         component) %>% 
  distinct() %>%
  group_by(component) %>% 
  
  do({
    enrichr(.$gene_name,
            databases = c("GO_Biological_Process_2018")) %>%
      bind_rows(.id = "database")
  }) %>%
  as_tibble()


# library(rrvgo)
# library(treemapify)
# library(pbapply)
# 
# plot_data_all <- 
#   gene_prop_net_enrichr %>%
#   filter(Adjusted.P.value < 0.05) %>%
#   mutate(GO = str_extract(Term, "\\(.*\\)") %>%
#            gsub("\\(|\\)", "", .)) %>%
#   select(component, GO, P = Adjusted.P.value) 
# 
# plots <- 
#   pblapply(sort(unique(gene_prop_net_enrichr$component)),
#            function(i) {
#              cat(paste(i, "\n"))
#              plot_data <- 
#                plot_data_all %>% 
#                filter(component == i)
#              
#              if(nrow(plot_data) > 1) {
#                plot_mat <- 
#                  calculateSimMatrix(plot_data$GO, 
#                                     orgdb="org.Hs.eg.db",
#                                     ont="BP",
#                                     method="Rel") 
#                plot_mat2 <- 
#                  reduceSimMatrix(plot_mat, 
#                                  setNames(-log10(plot_data$P), plot_data$GO),
#                                  threshold=0.7,
#                                  orgdb="org.Hs.eg.db") 
#                
#                plot_mat2 %>% 
#                  as_tibble() %>%
#                  group_by(parentTerm) %>%
#                  mutate(n = row_number()) %>%
#                  ggplot(aes(area = size, subgroup = parentTerm)) +
#                  
#                  geom_treemap(aes(fill = parentTerm,
#                                   alpha = n), 
#                               color = "black",
#                               show.legend = F) +
#                  geom_treemap_subgroup_border(color = "black") +
#                  
#                  geom_treemap_text(aes(label = term),
#                                    colour = "black", 
#                                    place = "centre",
#                                    alpha = 0.4,
#                                    grow = TRUE) +
#                  
#                  geom_treemap_subgroup_text(place = "centre", 
#                                             grow = T, 
#                                             reflow = T,
#                                             alpha = 1, 
#                                             colour = "white", 
#                                             fontface = "bold",
#                                             min.size = 0) +
#                  scale_alpha_continuous(range = c(0.8, 1)) +
#                  scale_fill_manual(values = rep(ggthemes::tableau_color_pal(palette = "Hue Circle", 
#                                                                             type = c("regular"), 
#                                                                             direction = 1)(19),
#                                                 10)) +
#                  theme_void() +
#                  ggtitle(i)
#              } else {
#                ggplot() +
#                  theme_void() +
#                  ggtitle(i)
#              }
#              
#            })
# 
# 
# pdf(savepath("Propr cluster GSEA treemaps.pdf"), width = 8, height = 5)
# plots
# dev.off()




######
# 
# expand.grid(id = c("A", "B", "C"),
#             value = rnorm(100)) %>%
#   mutate(value = value + rep(c(0, 1, 2), 100),
#          ensg_id = rep(1:100, each = 3)) %>%
#   # inner_join(gene_prop_net %>%
#   #              as_tibble() %>%
#   #              filter(component == 7),
#   #                        by = c("ensg_id" = "name"))
#   ggplot(aes(value, id, fill = id)) +
#   geom_boxplot(outlier.color = NA) +
#   geom_line(aes(group = ensg_id))
# 
# annotated_norm_count %>% 
#   filter(ensg_id == ensg_id[1], 
#          tissue == tissue[1], 
#          cell_type_name == cell_type_name[1],
#          cluster_id == cluster_id[1]) 

g <-
  annotated_norm_count %>% 
  # filter(tissue == "colon2") %>%
  # inner_join(gene_prop_net %>% 
  #              as_tibble() %>% 
  #              filter(component == 7),
  #                        by = c("ensg_id" = "name"))
  ggplot(aes(paste(tissue, cluster_id, cell_type_name),norm_count, fill = group_name)) +
  geom_boxplot(outlier.color = NA) +
  geom_line(data = . %>% 
              inner_join(gene_prop_net %>% 
                           as_tibble() %>% 
                           filter(component == 7) ,
                         by = c("ensg_id" = "name")),
            aes(group = ensg_id),
            alpha = 0.4) +
  scale_fill_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ggtitle("PTPM") +
  
  annotated_tmm %>% 
  # filter(tissue == "colon2") %>%
  # inner_join(gene_prop_net %>% 
  #              as_tibble() %>% 
  #              filter(component == 7),
  #                        by = c("ensg_id" = "name"))
  ggplot(aes(paste(tissue, cluster_id, cell_type_name),tmm, fill = group_name)) +
  geom_boxplot(outlier.color = NA) +
  geom_line(data = . %>% 
              inner_join(gene_prop_net %>% 
                           as_tibble() %>% 
                           filter(component == 7) ,
                         by = c("ensg_id" = "name")),
            aes(group = ensg_id),
            alpha = 0.4) +
  scale_fill_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ggtitle("TMM") +
  plot_layout(ncol = 1)

ggsave(savepath("Data distribution normalization.pdf"), plot = g, width = 24, height = 16)



annotated_tmm %>% 
  inner_join(gene_prop_net %>% 
               as_tibble() %>% 
               filter(component == 7),
             by = c("ensg_id" = "name")) %>%
  mutate(id = paste(tissue, cluster_id, cell_type_name)) %>%
  group_by(id) %>% 
  mutate(median_tmm = median(tmm)) %>% 
  ungroup() %>% 
  arrange(median_tmm) %>%
  mutate(id = factor(id, unique(id))) %>%
  ggplot(aes(id, tmm)) +
  geom_line(aes(group = ensg_id),
            alpha = 0.4) +
  geom_point(data = . %>% 
               select(id, group_name, median_tmm) %>% 
               distinct(),
             aes(y = median_tmm, 
                 color = group_name)) +
  scale_color_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) 

# plots <- 
#   lapply((1:14)[-3],
#          function(i) {
#            
#            
#            annotated_tmm %>% 
#              # filter(tissue == "colon2") %>%
#              # inner_join(gene_prop_net %>% 
#              #              as_tibble() %>% 
#              #              filter(component == 7),
#              #                        by = c("ensg_id" = "name"))
#              ggplot(aes(paste(tissue, cluster_id, cell_type_name),tmm, fill = group_name)) +
#              geom_boxplot(outlier.color = NA) +
#              geom_line(data = . %>% 
#                          inner_join(gene_prop_net %>% 
#                                       as_tibble() %>% 
#                                       filter(component == i) ,
#                                     by = c("ensg_id" = "name")),
#                        aes(group = ensg_id),
#                        alpha = 0.4) +
#              scale_fill_manual(values = cell_group_palette) +
#              scale_y_log10() +
#              stripped_theme+
#              theme(axis.text.x = element_text(angle = 60, hjust = 1))
#            
#            
#          })
# 
# pdf(savepath("tmm distribution i.pdf"), width = 24, height = 8)
# plots
# dev.off()
```


#Annotation sanity check

##Marker expression

```{r marker_expression}



cluster_marker_expression_stats <- 
  cluster_marker_expression %>% 
  mutate(norm_count = ifelse(norm_count < 1, 0, norm_count)) %>%
  group_by(tissue, ensg_id) %>%
  mutate(mean = mean(norm_count),
         sd = sd(norm_count),
         maxexp = max(norm_count),
         outlier = norm_count > mean + 2 * sd)

cluster_marker_expression_stats_general_summary <- 
  cluster_marker_expression_stats %>%
  filter(tissue_marker == "_General") %>%
   group_by(tissue_marker,
            ensg_id,
            gene_name) %>% 
  summarise(mean = mean(norm_count),
            sd = sd(norm_count),
            maxexp = max(norm_count),
            n_outlier = length(which(norm_count > mean + 2 * sd)))

cluster_marker_expression_stats_summary <- 
  cluster_marker_expression_stats %>%
   group_by(tissue, 
            tissue_marker,
            ensg_id,
            gene_name,
            mean, 
            sd,
            maxexp) %>% 
  summarise(n_outlier = length(which(outlier)))

low_efficiency_markers <- 
  cluster_marker_expression_stats_summary %>%
  filter(tissue_marker != "_General") %>%
  filter(n_outlier == 0) %>%
  arrange(tissue, maxexp)
  
zero_exp_markers <- 
  cluster_marker_expression_stats_summary %>%
  filter(tissue_marker != "_General") %>%
  filter(maxexp == 0) %>%
  arrange(tissue, maxexp)

zero_exp_markers %>% 
  write_csv(savepath("Zero expression markers.csv"))
  
cluster_marker_expression_stats_general_summary %>%
  # arrange(n_outlier) 
  arrange(maxexp)
  
cluster_marker_expression_stats %>% 
  ungroup() %>% 
  inner_join(low_efficiency_markers %>% 
               select(1:4)) %>%
  mutate(gene_name = factor(gene_name, levels = {group_by(., gene_name) %>%
      summarise(maxexp = max(norm_count)) %$%
      gene_name[order(maxexp)]})) %>%
  ggplot(aes(norm_count, gene_name)) +
  geom_point() +
  scale_x_log10() +
  facet_wrap(~tissue)



cluster_marker_expression %>% 

  
  unique() %>%
  spread(id, norm_count) %>%
  column_to_rownames("gene_name")

heatmap_data <- 
  cluster_norm_count %>% 
  
  inner_join(cell_markers %>% 
               select(ensg_id, gene_name) %>% 
               unique) %>% 
  mutate(id = paste(tissue_id, cluster_id)) %>%
  select(gene_name, norm_count, id) %>% 
  unique() %>%
  spread(id, norm_count) %>%
  column_to_rownames("gene_name")
  

heatmap_data %>% 
{log10(. + 1)} %>% 
  pheatmap(clustering_method = "ward.D2",
           color = heatmap_palette,
           border_color = NA,
           annotation_row = heatmap_data %>% 
             rownames() %>% 
             enframe %>% 
             mutate(bad_marker = ifelse(value %in% low_efficiency_markers$gene_name,
                                        "yes", "no")) %>% 
             select(-name) %>% 
             column_to_rownames("value"),
           annotation_col = heatmap_data %>% 
             colnames() %>% 
             enframe("row", "id") %>% 
             left_join(cluster_annotation %>% 
                         mutate(id = paste(tissue_id, cluster_id)) %>% 
                         select(id, cell_type_name)) %>%
             select(-row) %>% 
             mutate(cell_type_name = ifelse(is.na(cell_type_name), "?", cell_type_name)) %>%
             separate(id, into = c("tissue_id", "cluster_id"), remove = F) %>%
             left_join(dataset_map) %>%
             select(id, cell_type_name, tissue_type) %>%
             column_to_rownames("id"),
           annotation_colors = list(cell_type_name = cell_type_palette,
                                    tissue_type = tissue_colors, 
                                    bad_marker = c("yes" = "red", "no" = "white")),
           filename = savepath("Total marker heatmap.pdf"),
           width = 32, 
           height = 48)
dev.off()
```


## Hierarchical Clustering
```{r}



cluster_hiear_cluster <- 
  annotated_norm_count_wide %>% 
  column_to_rownames("id") %>%
  {log10(. + 1)} %>%
  dist() %>% 
  hclust(method = "ward.D2")

plot_dendro <- dendro_data(cluster_hiear_cluster)

dendro_plot_data <- 
  left_join(plot_dendro$segments, 
            plot_dendro$labels, 
            by = c("x" = "x", "yend" = "y"))  %>% 
  left_join(cluster_id_map,
            by = c("label" = "id")) %>% 
  as_tibble()

 
plot_width = max(dendro_plot_data$y)
plot_height = max(dendro_plot_data$x)
rect_width = plot_width / 50
rect2_position = 1.8
label_position = 2.5

plot_x_lim <- 
  dendro_plot_data %$%
  c(min(x), max(x))

dataset_dendro_plot_data <-
  dendro_plot_data %>% 
  filter(!is.na(label)) %>% 
  group_by(tissue) %>% 
  summarise(x = median(x)) %>% 
  mutate(x = scales::rescale(rank(x, ties.method = "first"), plot_x_lim))


dendro_plot_data %>%
  left_join(dataset_dendro_plot_data,
            by = c("tissue"),
            suffix = c("", "_tissue")) %>%
  ggplot() +
  geom_segment(aes(x=y, y=x, xend=yend, yend=xend, group = label))+
  geom_rect(aes(xmin=0, ymin=x + 0.5, 
                xmax= -rect_width, ymax=xend - 0.5, 
                fill = cell_type_name), 
            show.legend = F) +
  geom_rect(aes(xmin= -rect_width, ymin=x + 0.5, 
                xmax= -rect_width * 2, ymax=xend - 0.5, 
                fill = as_factor(mixed_cell_types)), 
            show.legend = F) +
  geom_text(aes(x=yend - rect_width * 2, y=x, label = label), 
            hjust = 0) +
  
  geom_rect(aes(xmin= - plot_width*rect2_position, ymin=x + 0.5, 
                xmax= - plot_width*rect2_position - rect_width, ymax=xend - 0.5, 
                fill = cell_type_name), 
            show.legend = F) +
  
  geom_text(data = dataset_dendro_plot_data,
            aes(x=-plot_width * label_position, y = x, label = tissue), 
            hjust = 0) +
  
  geom_segment(aes(x = - plot_width*rect2_position - rect_width, xend = -plot_width * label_position,
                   y = x, yend = x_tissue, color = cell_type_name),
               show.legend = F,
               alpha = 0.5) +
  
  
  scale_color_manual(values = c("1" = "red", "0" = "white", cell_type_palette))+
  scale_fill_manual(values = c("1" = "red", "0" = "white", cell_type_palette))+
  scale_x_reverse(expand = expansion(mult = c(0.05, 0.5)), position = "top") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05))) +
  
  annotate("text", x = -2 * rect_width, y = plot_height + 0.5, label = "Mixed",
           hjust = 0, 
           vjust = 0,
           angle = 60) +
  
  theme(axis.text.y = element_blank(), 
        axis.title = element_blank(), 
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(1,1,1,1), units = "mm"), 
        panel.background = element_blank()) 
ggsave(savepath("Cluster annotation dendro.pdf"), width = 10, height = 20)



```

##Retinagram

```{r}

cell_type_tmm_main %>% 
  spread(ensg_id, tmm) %>%
  # head %>%
  column_to_rownames("cell_type_name") %>%
  t() %>%
  cor(method = "spearman") %>%
  {1 - .} %>%
  as.dist() %>% 
  hclust(method = "ward.D2") %>%
  
circular_dendrogram_retinastyle_2(color_mapping = cell_type_palette %>% 
                                    enframe(), 
                                  label_col = "name", 
                                  color_col = "value", 
                                  scale_expansion = c(0.5, 0.5), 
                                  text_size = 3, 
                                  width_range = c(1.5, 6), 
                                  arc_strength = 1, 
                                  default_color = "gray80") 
ggsave(savepath("Cell type retinagram4.pdf"), width = 8, height = 8)

plot_clust <- 
  cell_type_tmm_main %>% 
  spread(ensg_id, tmm) %>%
  # head %>%
  column_to_rownames("cell_type_name") %>%
  t() %>%
  cor(method = "spearman") %>%
  {1 - .} %>%
  as.dist() %>% 
  hclust(method = "ward.D2") 

plots <- 
  lapply((1:100)/10,
         function(rot) {
           circular_dendrogram_retinastyle_3(plot_clust, 
                                             color_mapping = cell_type_palette %>% 
                                               enframe(), 
                                             label_col = "name", 
                                             color_col = "value", 
                                             scale_expansion = c(0.5, 0.5), 
                                             text_size = 3, 
                                             width_range = c(1.5, 6), 
                                             arc_strength = 0.8, 
                                             default_color = "gray80", 
                                             rotate_circle = rot,
                                             shrink_circle = 2)
         })

pdf(savepath("Cell type half retina.pdf"), width = 8, height = 8)
plots 
dev.off()

plot_settings <- 
  expand.grid(shrink = c(2),
              width_min = seq(1, 1.5, length.out = 3),
              width_max = c(6, 8, 10))

plots <- 
  lapply(1:nrow(plot_settings),
         function(i) {
           # print(i)
           circular_dendrogram_retinastyle_3(plot_clust, 
                                             color_mapping = cell_type_palette %>% 
                                               enframe(), 
                                             label_col = "name", 
                                             color_col = "value", 
                                             scale_expansion = c(0.5, 0.5), 
                                             text_size = 3, 
                                             width_range = c(plot_settings$width_min[i],
                                                             plot_settings$width_max[i]), 
                                             arc_strength = 0.8, 
                                             default_color = "gray80", 
                                             rotate_circle = 5.6,
                                             shrink_circle = plot_settings$shrink[i]) + 
             ggtitle(paste("Shrink:", plot_settings$shrink[i], 
                           "\nWidth:", plot_settings$width_min[i], ",",
                           plot_settings$width_max[i]))
         })

pdf(savepath("Cell type half retina final degrees.pdf"), width = 8, height = 8)
plots 
dev.off()





plots <- 
  lapply((1:100)/10,
         function(rot) {
           circular_dendrogram_retinastyle_3(plot_clust, 
                                             color_mapping = cell_type_palette %>% 
                                               enframe(), 
                                             label_col = "name", 
                                             color_col = "value", 
                                             scale_expansion = c(0.5, 0.5), 
                                             text_size = 3, 
                                             width_range = c(1.5, 6), 
                                             arc_strength = 0.8, 
                                             default_color = "gray80", 
                                             rotate_circle = rot,
                                             shrink_circle = 1.5)
         })

pdf(savepath("Cell type half retina 2.pdf"), width = 8, height = 8)
plots 
dev.off()

circular_dendrogram_retinastyle_3(plot_clust, 
                                  color_mapping = cell_type_palette %>% 
                                    enframe(), 
                                  label_col = "name", 
                                  color_col = "value", 
                                  scale_expansion = c(0.5, 0.5), 
                                  text_size = 3, 
                                  width_range = c(1.25, 6), 
                                  arc_strength = 0.8, 
                                  default_color = "gray80", 
                                  rotate_circle = 5.6,
                                  shrink_circle = 2, 
                                  flip_text = T, 
                                  text_vjust = 0.4)
ggsave(savepath("Cell type half retina final.pdf"), width = 8, height = 8, useDingbats = F)
```


## Spearman correlation

```{r}

annotated_cluster_cor <- 
  annotated_norm_count_wide %>% 
  column_to_rownames("id") %>%
  t() %>%
  cor(method = "spearman")


row_ann <- 
  colnames(annotated_cluster_cor) %>%
  enframe() %>%
  separate(value, into = c("tissue_id", "cluster_id", "annotation"), extra = "merge", remove = F) %>%
  select(value, annotation) %>% 
  column_to_rownames("value")

annotated_cluster_cor %>%
  pheatmap(color = heatmap_palette,
           border_color = NA,
           annotation_row = row_ann,
           annotation_colors = list(annotation = cell_type_palette),
           annotation_legend = F,
           clustering_method = "ward.D2",
           show_colnames = F,
           filename = savepath("All cluster spearman heatmap long .pdf"),
           width = 8,
           height = 36)


annotated_cluster_cor %>%
  pheatmap(color = heatmap_palette,
           border_color = NA,
           annotation_row = row_ann,
           annotation_colors = list(annotation = cell_type_palette),
           annotation_legend = F,
           clustering_method = "ward.D2",
           show_colnames = F,
           show_rownames = F,
           filename = savepath("All cluster spearman heatmap.pdf"),
           width = 8,
           height = 8)
# 
# annotated_cluster_cor %>%
#   as_tibble(rownames = "id1") %>% 
#   gather(id2, cor, -1) %>% 
#   left_join(cluster_id_map,
#             by = c("id1" = "id")) %>% 
#   left_join(cluster_id_map,
#             by = c("id2" = "id"),
#             suffix = c("1", "2")) %>% 
#   filter(cell_type_name1 == cell_type_name2) %>%
#   ggplot(aes(id1, id2, fill = cor)) + 
#   geom_tile() +
#   facet_wrap(~cell_type_name1, scales = "free")


```


## PCA & UMAP

### Data

```{r}

# ensg_sd <-
#   annotated_norm_count_clean_wide %>%
#   column_to_rownames("id") %>%
#   apply(MARGIN = 2, sd) %>% 
#   enframe("ensg_id", "sd") %>%
#   filter(sd > 0)


PCA_data <-
  annotated_tmm %>% 
  select(1:6, tmm) %>%
  unite(id, 1:3, 5:6, sep = ";") %>%
  spread(ensg_id, tmm) %>%
  column_to_rownames("id") %>%
  {log10(. + 1)}
  


```


### PCA

```{r}

annotated_clusters_pca <- 
  pca_calc(PCA_data, 200)


annotated_clusters_pca$scores %>% 
  as_tibble(rownames = "id") %>% 
  left_join(cluster_id_map) %>% 
  ggplot(aes(PC1, PC2, color = cell_type_name, shape = as.factor(mixed_cell_types))) + 
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            size = 2, 
            alpha = 0.4) +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme
ggsave(savepath("PCA annotated clusters.pdf"), width = 14, height = 6)


# Transform un-annotated clusters:
unannotated_PCA_data <- 
  cluster_norm_count %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") %>%
  {log10(. + 1)} %>%
  scale(scale = sqrt(ensg_sd$sd), center = T)
 


unannotated_PCA_transormed <- 
  pca_transform(unannotated_PCA_data, annotated_clusters_pca$loadings)

 

unannotated_PCA_transormed %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map, 
            by = "id") %>% 
  ggplot(aes(PC1, PC2, color = cell_type_name)) + 
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            size = 2, 
            alpha = 0.4) +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme
ggsave(savepath("PCA all clusters.pdf"), width = 14, height = 6)



```

###UMAP

```{r}
set.seed(42)
annotated_clusters_umap <- 
  umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

g1 <-
  annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  separate(id, into = c('tissue_id','tissue','cluster_id','cell_type_name','group_name'), sep = ";") %>%
  # left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")

g1
ggsave(savepath("Annotated clusters UMAP.pdf"), width = 20, height = 12)


annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  
  separate(id, into = c('tissue_id','tissue','cluster_id','cell_type_name','group_name'), sep = ";") %>%
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  
  geom_segment(aes(xend = mean_V1, yend = mean_V2),
               show.legend = F) +
  geom_point(size = 1, 
             alpha = 1,
             show.legend = F) + 
  # geom_text_repel(data = . %>%
  #                   select(mean_V1, mean_V2, cell_type_name) %>% 
  #                   distinct(),
  #                 aes(x = mean_V1, y = mean_V2, label = cell_type_name),
  #                 inherit.aes = F, 
  #                 size = 2,
  #                 alpha = 0.6,
  #                 fontface = "bold") +
  scale_color_manual(values = cell_type_palette, name = "") + 
  scale_fill_manual(values = cell_type_palette) + 
  
  stripped_theme

ggsave(savepath("Annotated clusters UMAP cell types.pdf"), width = 4, height = 4)

annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  
  separate(id, into = c('tissue_id','tissue','cluster_id','cell_type_name','group_name'), sep = ";") -> a

plot_data <- 
  annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  
  separate(id, into = c('tissue_id','tissue','cluster_id','cell_type_name','group_name'), sep = ";") %>%
  mutate(label = case_when(group_name %in% c("Blood & immune cells") ~ group_name,
                           tissue == "skin" ~ "",
                           cell_type_name %in% c("Neuroendocrine cells",
                                                 "Undifferentiated cells",
                                                 "Paneth cells",
                                                 "Enterocytes",
                                                 "Mucus-secreting cells") ~ "Intestinal cells",
                           cell_type_name %in% c("Hepatic stellate cells",
                                                 "Leydig cells",
                                                 "Sertoli cells", 
                                                 "Smooth muscle cells",
                                                 "Fibroblasts",
                                                 "Endothelial cells",
                                                 "Collecting duct cells") ~ "",
                           cell_type_name %in% c("Club cells",
                                                 "Ciliated cells",
                                                 "Alveolar cells type 1",
                                                 "Alveolar cells type 2") ~ "Pulmonary cells",
                           group_name == "Germ cells" ~ "Male germ cells",
                           grepl("Renal tubule", cell_type_name) ~ "Renal tubules",
                           grepl("trophoblast", cell_type_name) ~ "Trophoblasts",
                           grepl("Prostate", cell_type_name) |
                             cell_type_name == "Urothelial cells" ~ "Urethral epithelia",
                           # grepl("photoreceptor", cell_type_name) ~ "Photoreceptor cells",
                           group_name == "Neuronal cells" ~ "Neuronal cells",
                           
                           T ~ cell_type_name)) %>%
  group_by(label) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2))
# %>% 
#   select(4:5) %>% 
#   distinct() %>%
#   mutate(label = case_when(group_name %in% c("Blood & immune cells") ~ group_name,
#                            T ~ cell_type_name))

plot_data %>% 
  ggplot(aes(V1, V2, color = group_name)) + 
  
  # geom_segment(aes(xend = mean_V1, yend = mean_V2),
  #              show.legend = F) +
  geom_point(size = 1, 
             alpha = 1,
             show.legend = T) + 
  geom_text_repel(data = . %>%
                    filter(label != "") %>%
                    select(mean_V1, mean_V2, label) %>%
                    distinct(),
                  aes(x = mean_V1, y = mean_V2, label = label),
                  inherit.aes = F,
                  size = 2,
                  # point.padding = unit(3, "mm"),
                  box.padding = unit(3, "mm"),
                  alpha = 0.6) +
  scale_color_manual(values = cell_group_palette, name = "") + 
  scale_fill_manual(values = cell_group_palette) + 
  coord_fixed() +
  stripped_theme

ggsave(savepath("Annotated clusters UMAP cell types 2.pdf"), width = 7, height = 4)

annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  
  separate(id, into = c('tissue_id','tissue','cluster_id','cell_type_name','group_name'), sep = ";") %>%
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = gsub("\\d", "", tissue))) + 
  
  geom_segment(aes(xend = mean_V1, yend = mean_V2),
               show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = T) + 
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              distinct(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = tissue_colors, name = "") + 
  scale_fill_manual(values = cell_type_palette) + 
  stripped_theme

ggsave(savepath("Annotated clusters UMAP tissues.pdf"), width = 13, height = 12)

```


#Classification

##Global classification
```{r class, echo=FALSE, message=FALSE, warning=FALSE}

cell_type_class <- 
  cell_type_tmm_main %>% 
  hpa_gene_classification(expression_col = "tmm", 
                          tissue_col = "cell_type_name", 
                          gene_col = "ensg_id", 
                          enr_fold = 4, 
                          max_group_n = 10, 
                          det_lim = 1)

cell_type_class %>% 
  left_join(gene_info92,
            by = c("gene" = "ensg_id")) %>%
  select(ensg_id = gene, gene_name, gene_description,
         spec_category, dist_category, 
         spec_score, enriched_tissues) %>%
  write_csv(savepath("cell_type_classification.csv"))

cell_type_class %>%
  mutate(spec_category = str_to_sentence(spec_category),
         dist_category = str_to_sentence(dist_category)) %>%
  
  multi_alluvial_plot(vars = c("Specificity" = "spec_category", 
                               "Distribution" = "dist_category"), 
                      chunk_levels = c('Tissue enriched', 'Group enriched', 
                                       'Tissue enhanced', 'Low tissue specificity', 
                                       'Detected in single',
                                       'Detected in some', 
                                       'Detected in many', 
                                       'Detected in all',
                                       'Not detected'), 
                      pal = c(gene_category_pal, elevation_identity_pal), 
                      color_by = c(1, 1)) 
ggsave(savepath("single class comb n_genes alluvial.pdf"), width = 4, height = 6, useDingbats = F)


class_table_temp <-
  cell_type_class %>%
  select(gene, spec_category, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>%
  mutate(spec_category = factor(spec_category, levels = rev(spec_category_levels)),
         enriched_tissues = (enriched_tissues))
  

cell_type_cor <- 
  cell_type_norm_count %>%
  
  spread(cell_type_name, norm_count) %>% 
  column_to_rownames("ensg_id") %>%
  cor(method = "spearman")

cell_type_cor %>% 
  pheatmap(clustering_method = "ward.D2",
           filename = savepath("cell type spearman heatmap.pdf"),
           border_color = NA,
           width = 10,
           height = 9,
           annotation_row = colnames(cell_type_cor) %>% 
             enframe() %>% 
             mutate(cell_type = value) %>% 
             select(-1) %>% 
             column_to_rownames("value"), 
           annotation_legend = F,
           annotation_color = list(cell_type = cell_type_palette))

plot_dendro <-
  cell_type_cor %>%
  {1 - .} %>%
  as.dist() %>% 
  hclust(method = "average") %>%
  dendro_data()
  
  
dendro_plot_data <- 
  left_join(plot_dendro$segments, 
            plot_dendro$labels, 
            by = c("x" = "x", "yend" = "y")) 

left_plot <- 
  dendro_plot_data %>%
  ggplot() +
  geom_segment(aes(x=y, y=x, xend=yend, yend=xend, group = label))+
  geom_rect(aes(xmin=0, ymin=x + 0.5, 
                xmax=-0.02, ymax=xend - 0.5, 
                fill = label), 
            show.legend = F) +
  scale_color_manual(values = cell_type_palette)+
  scale_fill_manual(values = cell_type_palette)+
  scale_x_reverse(expand = expand_scale(mult = 0.25), position = "top")+
  scale_y_continuous(expand = expansion(0)) +
  
  theme(axis.text.y = element_blank(), 
        axis.title = element_blank(), 
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(1,1,1,1), units = "mm"), 
        panel.background = element_blank()) 

right_plot <- 
  class_table_temp %>%
  filter(!is.na(enriched_tissues)) %>%
  group_by(enriched_tissues, spec_category) %>%
  summarise(n_genes = n()) %>% 
  ungroup() %>%
  mutate(enriched_tissues = factor(enriched_tissues, levels = plot_dendro$labels$label)) %>% 
  ggplot(aes(n_genes, enriched_tissues, fill = spec_category)) +
  geom_col(width = 0.8, size = 0.1) +
  simple_theme +
  scale_fill_manual(values = gene_category_pal, name = "Specificity") +
  
  xlab("Number of genes") +
  # scale_y_continuous(position = "bottom", expand = c(0,0)) + 
  
  theme(axis.text.y = element_text(hjust = 0.5), 
        
        axis.title.y = element_blank(),
        panel.border = element_blank())

left_plot + right_plot 

ggsave(savepath("N enr genes per tissue + dendro 2.pdf"), width = 7, height = 6)


cell_type_class %>% 
  group_by(spec_category) %>%
  count %>%
  ungroup %>% 
  arrange(match(spec_category, (spec_category_levels))) %>% 
  mutate(y_stack = cumsum(n) - n/2,
         frac = n / sum(n),
         spec_category = factor(spec_category, rev(spec_category_levels))) %>% 
         {ggplot(., aes(1, n, fill = spec_category, group = spec_category, 
                        label = paste0(spec_category, "\n", n, "\n", round(frac * 100, 1), "%"))) +
             geom_col(show.legend = F, 
                      color = "white", 
                      width = 1) + 
             geom_segment(aes(x = 1.5 + 0.1, xend = 1.5, 
                              y = y_stack, yend = y_stack), size = 0.5) +
             geom_text_repel(aes(x = 1.5 + 0.1, y = y_stack), 
                             color = "black", nudge_x = 0.1, 
                             segment.size = 0.5) +
             scale_fill_manual(values = gene_category_pal) + 
             coord_polar("y") +
             theme_void() + 
             scale_x_continuous(expand = expansion(c(0,0.8)))} +
  
  cell_type_class %>% 
  group_by(dist_category) %>%
  count %>%
  ungroup %>% 
  arrange(match(dist_category, rev(c("not detected",
                                     "detected in all",
                                     "detected in many",
                                     "detected in some",
                                     "detected in single")))) %>% 
  mutate(y_stack = cumsum(n) - n/2,
         frac = n / sum(n),
         dist_category = factor(dist_category, c("not detected",
                                                 "detected in all",
                                                 "detected in many",
                                                 "detected in some",
                                                 "detected in single"))) %>% 
                                                 {ggplot(., aes(1, n, fill = dist_category, group = dist_category, 
                                                                label = paste0(dist_category, "\n", n, "\n", round(frac * 100, 1), "%"))) +
                                                     geom_col(show.legend = F, 
                                                              color = "white", 
                                                              width = 1) + 
                                                     geom_segment(aes(x = 1.5 + 0.1, xend = 1.5, 
                                                                      y = y_stack, yend = y_stack), size = 0.5) +
                                                     geom_text_repel(aes(x = 1.5 + 0.1, y = y_stack), 
                                                                     color = "black", nudge_x = 0.1, 
                                                                     segment.size = 0.5) +
                                                     scale_fill_manual(values = gene_category_pal) + 
                                                     coord_polar("y") +
                                                     theme_void() + 
                                                     scale_x_continuous(expand = expansion(c(0,0.8)))}

ggsave(savepath("Classification pie spec and dist.pdf"), 
       width = 8, height = 4)


```

### Network

```{r class_network_2_whole_groups, echo=FALSE, message=FALSE, warning=FALSE}


class_network_celltype_enriched <- 
  classification_network_plot_2(class_table = cell_type_class,
                                gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "group enriched"),
                                pal = c(cell_type_palette, gene_category_pal),
                                savename = "Celltype enriched",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 3,
                                node_filter_n_show = 5, 
                                scale_factor = 1)

ggsave(savepath("Celltype enriched.pdf"), plot = class_network_celltype_enriched,
       width = 25, height = 16, useDingbats = F)


class_network_celltype_elevated <- 
  classification_network_plot_2(class_table = cell_type_class,
                                gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enhanced", 
                                                "tissue enriched", 
                                                "group enriched"),
                                pal = c(cell_type_palette, gene_category_pal),
                                savename = "Celltype elevated",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 3,
                                node_filter_n_show = 5, 
                                scale_factor = 0.5)
                              
ggsave(savepath("Celltype elevated.pdf"), plot = class_network_celltype_elevated, 
       width = 25, height = 16, useDingbats = F)

```


#### Zoom-in networks

```{r}

plot_data <-
  cell_type_class %>%
  select(1, 2, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>% 
  left_join(cluster_annotation %>%
              select(cell_type_name, group_name) %>%
              distinct(),
            by = c("enriched_tissues" = "cell_type_name")) %>%
  group_by(gene) %>%
  mutate(not_cell = any(group_name != "Epithelial cells")) %>%
  ungroup() %>%
  filter(!not_cell) %>%
  # filter(group_name == "Epithelial cells") %>%
  group_by(gene, spec_category) %>%
  summarise(enriched_tissues = paste(enriched_tissues, collapse = ";")) %>%
  ungroup() 

class_network_epithelial_enriched <-
  plot_data %>%
  classification_network_plot_2(gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "group enriched"),
                                pal = c(cell_type_palette, gene_category_pal),
                                savename = "Epithelial cells",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 2,
                                node_filter_n_show = 5, 
                                scale_factor = 1)

ggsave(savepath("Epithelial cells enriched.pdf"), 
       plot = class_network_epithelial_enriched,
       width = 16, height = 10, useDingbats = F)


# Blood

plot_data <-
  cell_type_class %>%
  select(1, 2, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>% 
  left_join(cluster_annotation %>%
              select(cell_type_name, group_name) %>%
              distinct(),
            by = c("enriched_tissues" = "cell_type_name")) %>%
  group_by(gene) %>%
  mutate(not_cell = any(group_name != "Immune cells")) %>%
  ungroup() %>%
  filter(!not_cell) %>%
  # filter(group_name == "Epithelial cells") %>%
  group_by(gene, spec_category) %>%
  summarise(enriched_tissues = paste(enriched_tissues, collapse = ";")) %>%
  ungroup() 

class_network_immune_enriched <-
  plot_data %>%
  classification_network_plot_2(gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "group enriched"),
                                pal = c(cell_type_palette, gene_category_pal),
                                savename = "Immune cells",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 2,
                                node_filter_n_show = 5, 
                                scale_factor = 1)

ggsave(savepath("Immune cells enriched.pdf"), 
       plot = class_network_immune_enriched,
       width = 16, height = 10, useDingbats = F)

# Germ cells

plot_data <-
  cell_type_class %>%
  select(1, 2, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>% 
  left_join(cluster_annotation %>%
              select(cell_type_name, group_name) %>%
              distinct(),
            by = c("enriched_tissues" = "cell_type_name")) %>%
  group_by(gene) %>%
  mutate(not_cell = any(group_name != "Germ cells")) %>%
  ungroup() %>%
  filter(!not_cell) %>%
  # filter(group_name == "Epithelial cells") %>%
  group_by(gene, spec_category) %>%
  summarise(enriched_tissues = paste(enriched_tissues, collapse = ";")) %>%
  ungroup() 

class_network_germ_enriched <-
  plot_data %>%
  classification_network_plot_2(gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "group enriched"),
                                pal = c(cell_type_palette, gene_category_pal),
                                savename = "Germ cells",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 2,
                                node_filter_n_show = 5, 
                                scale_factor = 1)

ggsave(savepath("Germ cells enriched.pdf"), 
       plot = class_network_germ_enriched,
       width = 16, height = 10, useDingbats = F)

```


### Heatmap

```{r}



cell_type_norm_count_main %>% 
  ungroup() %>%
  inner_join(cell_type_class %>% 
               filter(spec_category == "tissue enriched"),
             by = c("ensg_id" = "gene")) %>% 
  select(ensg_id, cell_type_name, norm_count) %>% 
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("cell_type_name") %>%
  {log10(. + 1)} %>%
  scale() %>% 
  pheatmap(show_colnames = F,
           clustering_method = "ward.D2",
           border_color = NA, 
           filename = savepath("Cell enriched cell exp heatmap.pdf"),
           width = 10, height = 6)

cell_type_norm_count_main %>% 
  ungroup() %>%
  inner_join(cell_type_class %>% 
               filter(spec_category == "group enriched"),
             by = c("ensg_id" = "gene")) %>% 
  select(ensg_id, cell_type_name, norm_count) %>% 
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("cell_type_name") %>%
  {log10(. + 1)} %>%
  scale() %>% 
  pheatmap(show_colnames = F,
           clustering_method = "ward.D2",
           border_color = NA, 
           filename = savepath("Group enriched cell exp heatmap.pdf"),
           width = 10, height = 6)


cell_type_norm_count_main %>% 
  ungroup() %>%
  inner_join(cell_type_class %>% 
               filter(spec_category == "tissue enhanced"),
             by = c("ensg_id" = "gene")) %>% 
  select(ensg_id, cell_type_name, norm_count) %>% 
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("cell_type_name") %>%
  {log10(. + 1)} %>%
  scale() %>% 
  pheatmap(show_colnames = F,
           clustering_method = "ward.D2",
           border_color = NA, 
           filename = savepath("Cell enhanced cell exp heatmap.pdf"),
           width = 10, height = 6)

cell_type_norm_count_main %>% 
  ungroup() %>%
  inner_join(cell_type_class %>% 
               filter(spec_category == "low tissue specificity"),
             by = c("ensg_id" = "gene")) %>% 
  select(ensg_id, cell_type_name, norm_count) %>% 
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("cell_type_name") %>%
  {log10(. + 1)} %>%
  scale() %>% 
  pheatmap(show_colnames = F,
           clustering_method = "ward.D2",
           border_color = NA, 
           filename = savepath("Low spec cell exp heatmap.pdf"),
           width = 10, height = 6)


```


##Overlap enrichment tissue and blood cats

### Generate data

```{r compare_with_tissue_class, echo=FALSE, message=FALSE, warning=FALSE}

joined_cats_single_tissue <- 
  cell_type_class %>%
  
  left_join(gene_tissue_categories_HPA,
            by = c("gene" = "ensg_id"))  %>%
  select(ensg_id = gene, 
         2, 3, 
         enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>%
  full_join(gene_tissue_categories_HPA %>%
              select(ensg_id, 
                     spec_category = specificity_category,
                     dist_category = distribution_category, 
                     enriched_tissues = enhanced_tissues) %>%
              mutate(enriched_tissues = gsub(", ", "_", enriched_tissues),
                     enriched_tissues = gsub(",", ";", enriched_tissues),
                     enriched_tissues = gsub("_", ", ", enriched_tissues),
                     enriched_tissues = trimws(enriched_tissues)) %>%
              separate_rows(enriched_tissues, sep = ";"),
            by = c("ensg_id"),
            suffix = c("_single", "_tissue")) 

joined_cats_single_blood <- 
  cell_type_class %>%
  left_join(cell_type_class %>%
              select(1, enriched_tissues) %>%
              separate_rows(enriched_tissues, sep = ";") %>% 
              left_join(cluster_annotation %>%
                          select(cell_type_name, group_name) %>%
                          distinct(),
                        by = c("enriched_tissues" = "cell_type_name")) %>%
              group_by(gene) %>%
              mutate(not_cell = any(group_name != "Immune cells")) %>%
              ungroup() %>%
              filter(!not_cell) %>%
              group_by(gene) %>%
              summarise(enriched_tissues = paste(enriched_tissues, collapse = ";")) %>%
              ungroup(),
            by = "gene",
            suffix = c("_ori", "")) %>%
  select(ensg_id = gene, 
         2, 3, 
         enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>%
  full_join(gene_blood_lineage_categories_HPA %>%
              select(ensg_id, 
                     spec_category = specificity_category,
                     dist_category = distribution_category, 
                     enriched_tissues = enhanced_tissues) %>%
              mutate(enriched_tissues = gsub(", ", "_", enriched_tissues),
                     enriched_tissues = gsub(",", ";", enriched_tissues),
                     enriched_tissues = gsub("_", ", ", enriched_tissues),
                     enriched_tissues = trimws(enriched_tissues)) %>%
              separate_rows(enriched_tissues, sep = ";"),
            by = c("ensg_id"),
            suffix = c("_single", "_tissue")) 

HPA_top_expressing_tissues <- 
  HPA_data %>% 
  group_by(Gene) %>%
  top_n(1, NX) %>% 
  filter(NX > 1) %>%
  select(gene = Gene, 
         gene_name = `Gene name`,
         tissue = Tissue, 
         nx = NX)

joined_maxexp_single_class <- 
  cell_type_class %>%
  
  left_join(HPA_top_expressing_tissues,
            by = c("gene" = "gene"))  %>%
  select(ensg_id = gene, 
         gene_name, 
         2, 3, 
         enriched_tissues,
         tissue) %>%
  separate_rows(enriched_tissues, sep = ";") 

```

###Alluvials

```{r}

joined_cats_single_tissue %>%
  select(ensg_id, spec_category_single, spec_category_tissue) %>% 
  mutate(spec_category_single = tolower(spec_category_single),
         spec_category_tissue = tolower(spec_category_tissue)) %>%
  distinct() %>%
  multi_alluvial_plot(vars = c("Single cell type" = "spec_category_single", 
                               "Tissue" = "spec_category_tissue"), 
                      chunk_levels = c('tissue enriched', 'group enriched', 
                                       'tissue enhanced', 'low tissue specificity', 
                                       'not detected'), 
                      pal = c(gene_category_pal, elevation_identity_pal), 
                      color_by = c(1, 2)) 
ggsave(savepath("Enrichment class cell-tissue alluvial.pdf"), width = 6, height = 8)


unique_tissues <- 
  joined_cats_single_tissue %>% 
  select(enriched_tissues_tissue) %>%
  distinct() %>%
  filter(!is.na(enriched_tissues_tissue)) %>%
  pull(1)

unique_cells <- 
  joined_cats_single_tissue %>% 
  select(enriched_tissues_single) %>%
  distinct() %>%
  filter(!is.na(enriched_tissues_single)) %>%
  pull(1)

# Tissue elevated - cell elevated
alluvial_tissue_elev_cell_elev_plots <- 
  lapply(unique_tissues,
         function(tis_){
           print(tis_)
           joined_cats_single_tissue %>%
             filter(enriched_tissues_tissue == tis_) %>%
             group_by(enriched_tissues_single) %>%
             mutate(n = n()) %>%
             ungroup() %>%
             arrange(n) %>%
             mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
                                                     "not enriched",
                                                     enriched_tissues_single),
                    enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
                                                     "not enriched",
                                                     enriched_tissues_tissue)) %>%
             mutate(enriched_tissues_single = factor(as.character(enriched_tissues_single),
                                                     unique(enriched_tissues_single))) %>%
             mutate(spec_category_single = tolower(spec_category_single),
                    spec_category_tissue = tolower(spec_category_tissue)) %>%
             
             # {.[c(292, 293, 294)]}
             multi_alluvial_plot(vars = set_names(c("spec_category_tissue",
                                                    "enriched_tissues_single"), 
                                                  c(tis_, 
                                                    "Elevated in cell type")), 
                                 chunk_levels = c('tissue enriched', 'group enriched', 
                                                  'tissue enhanced', 'low tissue specificity', 
                                                  'not detected', 
                                                  rev(levels(.$enriched_tissues_single))), 
                                 pal = c(gene_category_pal, 
                                         elevation_identity_pal, cell_type_palette), 
                                 color_by = c(1, 2)) 
         })
pdf(savepath("Alluvial overlap tissue elevated - cell elevated.pdf"),
    width = 8, height = 12)
alluvial_tissue_elev_cell_elev_plots
dev.off()
# 
# # Tissue elevated - cell enriched
# alluvial_tissue_elev_cell_enr_plots <- 
#   lapply(unique_tissues,
#          function(tis_){
#            print(tis_)
#            joined_cats_single_tissue %>%
#              filter(enriched_tissues_tissue == tis_) %>%
#              filter(spec_category_single %in% c("tissue enriched", "group enriched")) %>%
#              group_by(enriched_tissues_single) %>%
#              mutate(n = n()) %>%
#              ungroup() %>%
#              arrange(n) %>%
#              mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
#                                                      "not enriched",
#                                                      enriched_tissues_single),
#                     enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
#                                                      "not enriched",
#                                                      enriched_tissues_tissue)) %>%
#              mutate(enriched_tissues_single = factor(as.character(enriched_tissues_single),
#                                                      unique(enriched_tissues_single))) %>%
#              mutate(spec_category_single = tolower(spec_category_single),
#                     spec_category_tissue = tolower(spec_category_tissue)) %>%
#              
#              # {.[c(292, 293, 294)]}
#              multi_alluvial_plot(vars = set_names(c("spec_category_tissue",
#                                                     "enriched_tissues_single"), 
#                                                   c(tis_, 
#                                                     "Enriched in cell type")), 
#                                  chunk_levels = c('tissue enriched', 'group enriched', 
#                                                   'tissue enhanced', 'low tissue specificity', 
#                                                   'not detected', 
#                                                   rev(levels(.$enriched_tissues_single))), 
#                                  pal = c(gene_category_pal, 
#                                          elevation_identity_pal, cell_type_palette), 
#                                  color_by = c(1, 2)) 
#          })
# pdf(savepath("Alluvial overlap tissue elevated - cell enriched.pdf"),
#     width = 8, height = 12)
# alluvial_tissue_elev_cell_enr_plots
# dev.off()

# Tissue elevated - single cell enriched
# alluvial_tissue_elev_singlecell_enr_plots <- 
#   lapply(unique_tissues,
#          function(tis_){
#            print(tis_)
#            joined_cats_single_tissue %>%
#              filter(enriched_tissues_tissue == tis_) %>%
#              filter(spec_category_single %in% c("tissue enriched")) %>%
#              group_by(enriched_tissues_single) %>%
#              mutate(n = n()) %>%
#              ungroup() %>%
#              arrange(n) %>%
#              mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
#                                                      "not enriched",
#                                                      enriched_tissues_single),
#                     enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
#                                                      "not enriched",
#                                                      enriched_tissues_tissue)) %>%
#              mutate(enriched_tissues_single = factor(as.character(enriched_tissues_single),
#                                                      unique(enriched_tissues_single))) %>%
#              mutate(spec_category_single = tolower(spec_category_single),
#                     spec_category_tissue = tolower(spec_category_tissue)) %>%
#              
#              # {.[c(292, 293, 294)]}
#              multi_alluvial_plot(vars = set_names(c("spec_category_tissue",
#                                                     "enriched_tissues_single"), 
#                                                   c(tis_, 
#                                                     "Enriched in single cell type")), 
#                                  chunk_levels = c('tissue enriched', 'group enriched', 
#                                                   'tissue enhanced', 'low tissue specificity', 
#                                                   'not detected', 
#                                                   rev(levels(.$enriched_tissues_single))), 
#                                  pal = c(gene_category_pal, 
#                                          elevation_identity_pal, cell_type_palette), 
#                                  color_by = c(1, 2)) 
#          })
# pdf(savepath("Alluvial overlap tissue elevated - single cell enriched.pdf"),
#     width = 8, height = 12)
# alluvial_tissue_elev_singlecell_enr_plots
# dev.off()


######

# cell elevated - tissue elevated
alluvial_cell_elev_tissue_elev_plots <- 
  lapply(unique_cells,
         function(tis_){
           print(tis_)
           joined_cats_single_tissue %>%
             filter(enriched_tissues_single == tis_) %>%
             group_by(enriched_tissues_tissue) %>%
             mutate(n = n()) %>%
             ungroup() %>%
             arrange(n) %>%
             mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
                                                     "not enriched",
                                                     enriched_tissues_single),
                    enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
                                                     "not enriched",
                                                     enriched_tissues_tissue)) %>%
             mutate(enriched_tissues_tissue = factor(as.character(enriched_tissues_tissue),
                                                     unique(enriched_tissues_tissue))) %>%
             mutate(spec_category_single = tolower(spec_category_single),
                    spec_category_tissue = tolower(spec_category_tissue)) %>%
             
             # {.[c(292, 293, 294)]}
             multi_alluvial_plot(vars = set_names(c("spec_category_single",
                                                    "enriched_tissues_tissue"), 
                                                  c(tis_, 
                                                    "Elevated in tissue")), 
                                 chunk_levels = c('tissue enriched', 'group enriched', 
                                                  'tissue enhanced', 'low tissue specificity', 
                                                  'not detected', 
                                                  rev(levels(.$enriched_tissues_tissue))), 
                                 pal = c(gene_category_pal, 
                                         elevation_identity_pal, tissue_colors), 
                                 color_by = c(1, 2)) 
         })
pdf(savepath("Alluvial overlap cell elevated - tissue elevated.pdf"),
    width = 8, height = 12)
alluvial_cell_elev_tissue_elev_plots
dev.off()

```

####Final main alluvial

```{r}
width = 0.1

alluv_1 <-
  
  joined_cats_single_tissue %>%
  select(ensg_id, spec_category_single, spec_category_tissue) %>% 
  distinct() %>%
  # multi_alluvial_plot(vars = c("Single cell type" = "spec_category_single", 
  #                              "Tissue" = "spec_category_tissue"), 
  #                     chunk_levels = c('tissue enriched', 'group enriched', 
  #                                      'tissue enhanced', 'low tissue specificity', 
  #                                      'not detected'), 
  #                     pal = c(gene_category_pal, elevation_identity_pal), 
  #                     color_by = c(1, 2))  %>%
   mutate(single = str_to_sentence(spec_category_single),
          tissue = str_to_sentence(spec_category_tissue)) %>%
  select(single,
         tissue) %>%
  mutate(row_n = row_number()) %>%
  gather(bar, chunk, -row_n) %>%
  mutate(color_vars = 1) %>%
  group_by(row_n) %>%
  mutate(chunk_color = chunk[match(c("single",
                                     "tissue")[color_vars], bar)]) %>% 
  ungroup() %>%
  
  
  mutate(chunk = factor(chunk, levels = c('Tissue enriched', 'Group enriched', 
                                          'Tissue enhanced', 'Low tissue specificity', 
                                          'Not detected')),
         bar = factor(bar, levels = c("tissue",
                                      "single"))) %>%
  
  
  ggplot(aes(x = bar, stratum = chunk, alluvium = row_n,
             y = 1)) +
  
  geom_flow(aes(fill = chunk_color), 
            show.legend = F, width = width,
            knot.pos = 1/6) +
  geom_stratum(aes(fill = chunk), 
               show.legend = F, color = NA, width = width) +
  
  scale_x_discrete(expand = c(.1, .1), position = "top") +
  scale_fill_manual(values = c(gene_category_pal, elevation_identity_pal)) + 
  
  
  theme(axis.text.y = element_text(size = 18, face = "bold"),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank(), 
        panel.background = element_blank(), 
        axis.title = element_blank()) +
  coord_flip()

# alluv_1
flow_data <-
  ggplot_build(alluv_1)$data[[1]] %>%
  as_tibble() %>%
  {
    if("side" %in% names(.)) {
      .
    } else{
      mutate(.,
             side = case_when(contact == "back" ~ "start",
                              contact == "front" ~ "end"))
    }}

stratum_data <- 
  ggplot_build(alluv_1)$data[[2]]

flow_data_labels <-
  flow_data %>% 
  as_tibble() %>% 
  select(x, stratum, group, side, ymin, ymax) %>% 
  multispread(c(side), c(x, stratum, ymin, ymax)) %>% 
  mutate_at(c("end_x", "end_ymax", "end_ymin", "start_x", "start_ymax", "start_ymin"), as.numeric) %>% 
  group_by(start_stratum, end_stratum, start_x, end_x) %>%
  summarise(end_y = (min(end_ymin) + max(end_ymax)) / 2, 
            start_y = (min(start_ymin) + max(start_ymax)) / 2, 
            size = max(start_ymax) - min(start_ymin))

alluv_2 <- 
  alluv_1 +
  geom_text(data = flow_data_labels,
            aes(x = start_x + width/2,
                y = start_y, 
                label = size), 
            inherit.aes = F, 
            size = 3,
            angle = -90,
            hjust = 1,
            vjust = 0.5) +
  geom_text(data = flow_data_labels,
            aes(x = end_x - width/2,
                y = end_y, 
                label = size), 
            inherit.aes = F, 
            size = 3, 
            angle = -90,
            hjust = 0,
            vjust = 0.5) +
  
  # Stratum label
  
  geom_text(data = stratum_data %>%
              filter(x == 1),
            aes(x = x - width/2,
                y = y,
                label = stratum),
            size = 4, 
            vjust = 1.5,
            inherit.aes = F) + 
  geom_text(data = stratum_data %>%
              filter(x == 2),
            aes(x = x + width/2,
                y = y,
                label = stratum),
            size = 4, 
            vjust = -0.5,
            inherit.aes = F) + 
  
  geom_text(data = stratum_data,
            aes(x = x, 
                y = y,
                label = ymax - ymin), 
            size = 4, 
            fontface = "bold",
            color = "white",
            inherit.aes = F)


# alluv_2

ggsave(savepath("Final Alluvial.pdf"), plot = alluv_2, width = 7, height = 2.5, useDingbats = F)
```


###Tissue enriched overlap network


```{r}

net_data_genes <- 
  joined_cats_single_tissue %>%
  
  filter(spec_category_tissue %in% c("Tissue enriched", "Group enriched") |
           spec_category_single %in% c("tissue enriched", "group enriched")) %>% 
  
  
  mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
                                          "not cell enriched", 
                                          enriched_tissues_single),
         enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
                                          "not tissue enriched", 
                                          enriched_tissues_tissue)) %>%
  
  
  
  filter(enriched_tissues_tissue %in% c("intestine", "retina", "heart muscle", 
                                        "kidney", "liver", "lung", "placenta",
                                        "prostate", "testis", "blood", "lymphoid tissues",
                                        "pancreas", "skin",
                                        "not tissue enriched")) %>%
  
  select(-dist_category_single, -dist_category_tissue) %>% 
  
  left_join(gene_info92 %>% 
              select(1:2)) %>%
  filter(enriched_tissues_single != "not cell enriched" &
           enriched_tissues_tissue != "not tissue enriched")

net_data <-
  net_data_genes %>%
  
  group_by(ensg_id) %>%
  mutate(cells = paste(sort(unique(enriched_tissues_single)), collapse = ";"),
         tissues = paste(sort(unique(enriched_tissues_tissue)), collapse = ";"),
         edge_id = paste(cells, tissues)) %>%
  group_by(enriched_tissues_single,
           enriched_tissues_tissue, 
           cells, tissues,
           edge_id) %>% 
  summarise(n = n()) %>%
  ungroup() %>%
  gather(node_type, node, 1:2) %>% 
  mutate(node_type = gsub("enriched_tissues_", "", node_type),
         enrich_type = ifelse(grepl(";", edge_id), "group enriched", "tissue enriched")) %>%
  select(node, enrich_node = edge_id, 
         n, node_type, enrich_type) %>% 
  mutate(enrich_node = paste("EN", enrich_node))  %>%
  group_by(enrich_node) %>%
  mutate(n_connections = length(enrich_node)) %>%
  group_by(node) %>%
  mutate(rank = rank(-n, ties.method = "min")) %>%
    group_by(enrich_node) %>%
    mutate(min_rank = min(rank)) %>%
    ungroup() %>%
    filter((min_rank <= 3 | n >= 8) & n >= 4)
  # filter(n > 3) %>%
    # filter(n_connections < 10)

nodes_meta <-
  net_data %$%
  tibble(node_id = c(node, enrich_node), 
         type = c(node_type, enrich_type), 
         label = c(node, n)) %>% 
  distinct() 

net_graph <- 
  net_data %>%
  
  as_tbl_graph() %>%
  
  mutate(Centrality = centrality_pagerank(),
         
         name = fct_reorder(name, -Centrality)) %>%
  
  activate(nodes) %>%
  left_join(nodes_meta,
            by = c("name" = "node_id")) %>%
  mutate(size = case_when(type == "single" ~ max(sqrt(as.numeric(label)), 
                                                 na.rm = T) * 0.7,
                          type == "tissue" ~ max(sqrt(as.numeric(label)), 
                                                 na.rm = T),
                          type %in% c("tissue enriched", 
                                      "group enriched") ~ sqrt(as.numeric(label))),
         fill = case_when(type == "single" ~ name,
                          type == "tissue" ~ name,
                          type %in% c("tissue enriched", 
                                      "group enriched") ~ type))



plots <- 
  lapply(c("kk", "stress", "lgl", "graphopt"),
         function(lyot) {
           net_graph %>%
             
             ggraph(layout = lyot,
                    circular = F) +
             
             geom_edge_arc(color = "gray", 
                           strength = 0, 
                           alpha = 0.5,
                           show.legend = F) + 
             
             
             geom_node_point(aes(size = size, 
                                 fill = fill, 
                                 shape = type), 
                             stroke = 0,
                             show.legend = T)+
             
             geom_node_text(aes(label = label),
                            size = 4) +
             
             scale_edge_alpha_continuous(range = c(0.3, 1)) +
             scale_edge_width_continuous(range = c(1, 3)) +
             scale_shape_manual(values = c("single" = 21, "tissue" = 22, "group enriched" = 21, 
                                           "tissue enriched" = 21)) +
             scale_size_continuous(range = c(5, 10), guide = F) +
             scale_fill_manual(values = c(gene_category_pal, cell_type_palette, tissue_colors,
                                          "not cell enriched" = "gray",
                                          "not tissue enriched" = "gray"), guide = F) +
             
             theme_void() +
             ggtitle(lyot)
         })




pdf(savepath("Tissue - celltype enrichment overlap network.pdf"), width = 16, height = 10)
plots
dev.off()

net_graph %>% 
  as_tibble %>% 
  mutate(id = row_number()) %>% 
  select(id, name, type, label, size) %>% 
  write_csv(savepath("Tissue-single network nodes.csv"))

net_graph %>% 
  activate(edges) %>%
  as_tibble %>%
  select(from, to, n)  %>%
  distinct() %>%
  write_csv(savepath("Tissue-single network edges.csv"))

net_graph %>% 
  as_tibble %>%
  mutate(id = row_number()) %>% 
  select(id, name, type) %>%
  left_join(c(gene_category_pal, cell_type_palette, tissue_colors) %>% 
              enframe("name", "color")) %>% 
  mutate(color = case_when(type == "tissue enriched" ~ "#e41a1c",
                           type == "group enriched" ~ "#FF9D00",
                           T ~color)) %>%
  write_csv(savepath("Tissue-single network colors.csv"))

```


###Blood enriched overlap network


```{r}

net_data_genes <- 
  joined_cats_single_blood %>%
  
  filter(spec_category_tissue %in% c("Tissue enriched", "Group enriched") |
           (spec_category_single %in% c("tissue enriched", "group enriched") & !is.na(enriched_tissues_single))) %>%
  
  
  mutate(enriched_tissues_single = ifelse(is.na(enriched_tissues_single), 
                                          "not cell atlas enriched", 
                                          enriched_tissues_single),
         enriched_tissues_tissue = ifelse(is.na(enriched_tissues_tissue), 
                                          "not blood atlas enriched", 
                                          enriched_tissues_tissue)) %>%
  
  
  
  # filter(enriched_tissues_tissue %in% c("intestine", "retina", "heart muscle", 
  #                                       "kidney", "liver", "lung", "placenta",
  #                                       "prostate", "testis", "blood", "lymphoid tissues",
  #                                       "not tissue enriched")) %>%
  
  select(-dist_category_single, -dist_category_tissue) %>% 
  
  left_join(gene_info92 %>% 
              select(1:2))

net_data <-
  net_data_genes %>%
  
  group_by(ensg_id) %>%
  mutate(cells = paste(sort(unique(enriched_tissues_single)), collapse = ";"),
         tissues = paste(sort(unique(enriched_tissues_tissue)), collapse = ";"),
         edge_id = paste(cells, tissues)) %>%
  group_by(enriched_tissues_single,
           enriched_tissues_tissue, 
           cells, tissues,
           edge_id) %>% 
  summarise(n = n()) %>%
  ungroup() %>%
  gather(node_type, node, 1:2) %>% 
  mutate(node_type = gsub("enriched_tissues_", "", node_type),
         enrich_type = ifelse(grepl(";", edge_id), "group enriched", "tissue enriched")) %>%
  select(node, enrich_node = edge_id, 
         n, node_type, enrich_type) %>% 
  mutate(enrich_node = paste("EN", enrich_node))  %>%
  group_by(enrich_node) %>%
  mutate(n_connections = length(enrich_node)) %>%
  group_by(node) %>%
  mutate(rank = rank(-n, ties.method = "min")) %>%
    group_by(enrich_node) %>%
    mutate(min_rank = min(rank)) %>%
    ungroup() %>%
    filter((min_rank <= 3 | n >= 8) & n >= 3)
  # filter(n > 3) %>%
    # filter(n_connections < 10)

nodes_meta <-
  net_data %$%
  tibble(node_id = c(node, enrich_node), 
         type = c(node_type, enrich_type), 
         label = c(node, n)) %>% 
  distinct() 

net_graph <- 
  net_data %>%
  
  as_tbl_graph() %>%
  
  mutate(Centrality = centrality_pagerank(),
         
         name = fct_reorder(name, -Centrality)) %>%
  
  activate(nodes) %>%
  left_join(nodes_meta,
            by = c("name" = "node_id")) %>%
  mutate(size = case_when(type == "single" ~ max(sqrt(as.numeric(label)), 
                                                 na.rm = T) * 0.7,
                          type == "tissue" ~ max(sqrt(as.numeric(label)), 
                                                 na.rm = T),
                          type %in% c("tissue enriched", 
                                      "group enriched") ~ sqrt(as.numeric(label))),
         fill = case_when(type == "single" ~ name,
                          type == "tissue" ~ name,
                          type %in% c("tissue enriched", 
                                      "group enriched") ~ type))




net_graph %>%
  
  ggraph(layout = "kk",
         circular = F) +
  
  geom_edge_arc(color = "gray", 
                strength = 0, 
                alpha = 0.5,
                show.legend = F) + 
  
  
  geom_node_point(aes(size = size, 
                      fill = fill, 
                      shape = type), 
                  stroke = 0,
                  show.legend = T)+
  
  geom_node_text(aes(label = label),
                 size = 4) +
  
  scale_edge_alpha_continuous(range = c(0.3, 1)) +
  scale_edge_width_continuous(range = c(1, 3)) +
  scale_shape_manual(values = c("single" = 21, "tissue" = 22, "group enriched" = 21, 
                                "tissue enriched" = 21)) +
  scale_size_continuous(range = c(5, 10), guide = F) +
  scale_fill_manual(values = c(gene_category_pal, cell_type_palette, tissue_colors,
                               "not cell enriched" = "gray",
                               "not cell atlas enriched" = "gray", 
                               "not blood atlas enriched" = "gray",
                               "not tissue enriched" = "gray"), guide = F) +
  
  theme_void()


ggsave(savepath("Blood - celltype enrichment overlap network.pdf"), width = 16, height = 10)
```

### Enrichment overlap plot 2

```{r enriched_overlap_barplot2, echo=FALSE, message=FALSE, warning=FALSE}
joined_maxexp_single_class %>%
  group_by(enriched_tissues, tissue) %>% 
  summarise(n = n()) %>%
  filter(!is.na(enriched_tissues)) %>%
  ggplot(aes(enriched_tissues, n, fill = tissue)) + 
  geom_col(color = "black") +
  
  scale_fill_manual(values = c(tissue_colors, "Not tissue enriched" = "black", "cervix, uterine" = "lightpink", "intestine" = "#1280C4", "heart muscle" = "#DE6C7D")) +
  
  coord_flip() +
  
  stripped_theme

ggsave(savepath("number enriched overlap.pdf"), width = 7, height = 6)


plot_data <- 
  joined_maxexp_single_class %>%
  filter(spec_category %in% c("tissue enriched", "group enriched")) %>%

  group_by(enriched_tissues, tissue) %>% 
  summarise(n = n()) %>%
  ungroup() %>%
  filter(!is.na(enriched_tissues)) 

plot_dendro <- 
  plot_data %>% 
  spread(tissue, n, fill = 0) %>% 
  column_to_rownames("enriched_tissues") %>% 
  dist() %>%
  hclust(method = "ward.D2")

plot_y_order <- 
  plot_dendro %>% 
  dendro_data()


left_plot <- 
  left_join(plot_y_order$segments, 
            plot_y_order$labels, 
            by = c("x" = "x", "yend" = "y")) %>%
  ggplot() +
  geom_segment(aes(x=y, y=x, xend=yend, yend=xend, group = label))+
  geom_rect(aes(xmin=0, ymin=x + 0.5, 
                xmax=-0.02, ymax=xend - 0.5, 
                fill = label), 
            show.legend = F) +
  # scale_color_manual(values = celltype_pal)+
  # scale_fill_manual(values = celltype_pal)+
  scale_x_reverse(expand = expand_scale(mult = 0.25), position = "top")+
  
  theme(axis.text.y = element_blank(), 
        axis.title = element_blank(), 
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(1,1,1,1), units = "mm"), 
        panel.background = element_blank()) 

plot_ordered <- 
  plot_data %>% 
  ungroup() %>%   # As a precaution / handle in a separate .grouped_df method
  arrange(enriched_tissues, -n) %>%   # arrange by facet variables and continuous values
  mutate(.r = row_number(), 
         enriched_tissues = factor(enriched_tissues, 
                                          levels = rev(plot_y_order$labels$label))) %>%
  group_by(enriched_tissues) %>%
  mutate(rank = rank(-n),
         label = ifelse(rank < 3 & tissue !=  "Not tissue enriched", tissue, NA))

plot_palette <- 
  plot_ordered %>% 
  left_join(tissue_colors %>% enframe(),
            by = c("tissue" = "name")) %>%
  select(.r, value) %>% 
  unique() %$% 
  set_names(value, .r)

right_plot <- 
  plot_ordered %>%
  
  ggplot(aes(n, enriched_tissues, fill = as.factor(.r), label = label)) + 
  geom_col(color = "black", 
           show.legend = F, 
           size = 0.1) +
  geom_text(position = "stack",
            hjust = 1, 
            color = "white", 
            size = 2) + 
  
  facet_wrap(~ enriched_tissues, ncol = 1, scales = "free_y", strip.position = "left") +
  
  scale_y_discrete(expand = expansion(0.025)) +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
  scale_fill_manual(values = plot_palette, 
                    breaks = plot_ordered$.r,     # notice need to reuse data frame
                      labels = plot_ordered$x) +
  
  ggtitle("Number of cell enriched genes elevated in tissues") +
  xlab("Number of genes") +
  stripped_theme +
  theme(strip.text = element_blank(),
        strip.background = element_blank(),
        panel.spacing = unit(0, "mm"), 
        axis.title.y = element_blank())

left_plot + right_plot

ggsave(savepath("number enriched - which tissue maxexp.pdf"), width = 12, height = 6)


```

### Enrichment overlap tissue - cell

```{r}

tissue_enriched_cell_overlap <-
  gene_tissue_categories_HPA %>%
  filter(specificity_category %in% c("Tissue enriched", "Group enriched")) %>%
  mutate(enhanced_tissues = gsub(", ", "_", enhanced_tissues)) %>%
  separate_rows(enhanced_tissues, sep = ",") %>%
  mutate(enhanced_tissues = gsub("_", ", ", enhanced_tissues)) %>%
  left_join(cell_type_class %>%
              select(gene, spec_category, dist_category, enriched_tissues) %>%
              separate_rows(enriched_tissues, sep = ";"),
            by = c("ensg_id" = "gene")) %>%
  mutate(enriched_tissues = ifelse(is.na(enriched_tissues), "Not cell enriched", enriched_tissues)) %>%
  rename(enriched_cells = enriched_tissues)

# tissue_enriched_cell_overlap <- 
#   gene_tissue_categories_HPA %>% 
#   filter(specificity_category %in% c("Tissue enriched", "Group enriched")) %>%
#   mutate(enhanced_tissues = gsub(", ", "_", enhanced_tissues)) %>%
#   separate_rows(enhanced_tissues, sep = ",") %>% 
#   mutate(enhanced_tissues = gsub("_", ", ", enhanced_tissues)) %>%
#   left_join(cell_type_class %>%
#               filter(spec_category %in% c("tissue enriched", "group enriched")) %>%
#               select(gene, spec_category, dist_category, enriched_tissues) %>%
#               mutate(all_enriched_cells = enriched_tissues) %>%
#               separate_rows(enriched_tissues, sep = ";"),
#             by = c("ensg_id" = "gene")) %>%
#   mutate(enriched_tissues = ifelse(is.na(enriched_tissues), "Not cell enriched", enriched_tissues)) %>%
#   rename(enriched_cells = enriched_tissues)

plot_data <- 
  tissue_enriched_cell_overlap %>% 
  group_by(enhanced_tissues, enriched_cells) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>%
  mutate(sum_n = sum(n),
         fract = n/sum_n) %>%
  ungroup() 

plot_dendro <- 
  plot_data %>% 
  select(1:2, fract) %>%
  spread(enriched_cells, fract, fill = 0) %>% 
  column_to_rownames("enhanced_tissues") %>% 
  dist() %>%
  hclust(method = "ward.D2")

plot_y_order <- 
  plot_dendro %>% 
  dendro_data()


#1
plot_ordered <- 
  plot_data %>% 
  arrange(enhanced_tissues, -n) %>%   # arrange by facet variables and continuous values
  mutate(.r = row_number(), 
         enhanced_tissues = factor(enhanced_tissues, 
                                          levels = rev(plot_y_order$labels$label))) %>%
  group_by(enhanced_tissues) %>%
  mutate(rank = rank(-n),
         label = ifelse(rank < 3 & enriched_cells !=  "Not cell enriched", enriched_cells, NA)) %>%
  ungroup()

plot_palette <- 
  plot_ordered %>% 
  left_join(cell_type_palette %>% enframe(),
            by = c("enriched_cells" = "name")) %>%
  select(.r, value) %>% 
  unique() %$% 
  set_names(value, .r)

plot_ordered %>%
  
  ggplot(aes(n, enhanced_tissues, fill = as.factor(.r), label = label)) + 
  geom_col(color = "black", 
           show.legend = F, 
           size = 0.1) +
  geom_text(position = "stack",
            hjust = 1, 
            color = "white", 
            size = 2) + 
  
  facet_wrap(~ enhanced_tissues, ncol = 1, scales = "free_y", strip.position = "left") +
  
  scale_y_discrete(expand = expansion(0.025)) +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
  scale_fill_manual(values = plot_palette, 
                    breaks = plot_ordered$.r,     # notice need to reuse data frame
                      labels = plot_ordered$x) +
  
  ggtitle("Tissue enriched genes and their cell type elevation") +
  xlab("Number of genes") +
  stripped_theme +
  theme(strip.text = element_blank(),
        strip.background = element_blank(),
        panel.spacing = unit(0, "mm"), 
        axis.title.y = element_blank())


ggsave(savepath("number tissue enriched - which cell overlap.pdf"), width = 6, height = 6)

#2

plot_ordered %>%
  
  ggplot(aes(fract, enhanced_tissues, fill = as.factor(.r), label = label)) + 
  geom_col(color = "black", 
           show.legend = F, 
           size = 0.1) +
  geom_text(position = "stack",
            hjust = 1, 
            color = "white", 
            size = 2) + 
  
  facet_wrap(~ enhanced_tissues, ncol = 1, scales = "free_y", strip.position = "left") +
  
  scale_y_discrete(expand = expansion(0.025)) +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
  scale_fill_manual(values = plot_palette, 
                    breaks = plot_ordered$.r,     # notice need to reuse data frame
                      labels = plot_ordered$x) +
  
  ggtitle("Tissue enriched genes and their cell type elevation") +
  xlab("Number of genes") +
  stripped_theme +
  theme(strip.text = element_blank(),
        strip.background = element_blank(),
        panel.spacing = unit(0, "mm"), 
        axis.title.y = element_blank())


ggsave(savepath("number tissue enriched - which cell overlap 2.pdf"), width = 6, height = 6)
```

##Compare not detected to tissue

```{r}
cell_type_class %>% 
  filter(spec_category == "not detected") %>% 
  left_join(gene_tissue_categories_HPA,
            by = c("gene" = "ensg_id")) %>%
  select(gene,  specificity_category, enhanced_tissues) %>%
  separate_rows(enhanced_tissues, sep = ",") %>% 
  group_by(enhanced_tissues) %>% 
  count %>%
  arrange(-n) %>% 
  ungroup() %>%
  mutate(enhanced_tissues = factor(enhanced_tissues, unique(enhanced_tissues))) %>%
  ggplot(aes(n, enhanced_tissues, label = n)) +
  geom_col() +
  geom_text()


```


#Compare with blood atlas

```{r}

plot_data <- 
  annotated_tmm_main %>%
  filter(group_name == "Blood & immune cells") %>%
  inner_join(gene_blood_lineage_categories_HPA %>% 
               filter(specificity_category %in% c("Tissue enriched", "Group enriched")) %>% 
               # group_by(enhanced_tissues) %>% 
               # top_n(10, ts_score) %>% 
               ungroup()) %>%
  mutate(id = paste(tissue, cluster_id, cell_type_name)) %>%
  mutate(log_tmm = log10(tmm + 1)) %>%
  group_by(ensg_id) %>% 
  mutate(sd_tmm = sd(log_tmm),
         max_tmm = tmm / max(tmm)) %>%
  ungroup() %>%
  filter(sd_tmm > 0)
  
  
row_ann <- 
  plot_data %>% 
  select(id, cell_type_name) %>%
  distinct %>%
  mutate(cell_type_name = gsub(" \\(.*\\)", "", cell_type_name)) %>%
  rename(`Cell type` = cell_type_name) %>%
  column_to_rownames("id")

col_ann <-
  plot_data %>%
  select(ensg_id, Marker = enhanced_tissues) %>%
  
  distinct() %>%
  separate_rows(Marker, sep = ",") %>%
  mutate(yes = "1") %>% 
  spread(Marker, yes, fill = "0") %>% 
  column_to_rownames("ensg_id")

col_clust <- 
  col_ann %>% 
  dist() %>% 
  hclust(method = "ward.D2")

plot_data %>% 
  
  select(id, ensg_id, log_tmm) %>% 
  spread(ensg_id, log_tmm) %>% 
  column_to_rownames("id") %>% 
  
  pheatmap(color = heatmap_palette,
           annotation_row = row_ann, 
           annotation_col = col_ann,
           annotation_colors = list("T-cells" = c("0" = "white", 
                                                  "1" = "red"),
                                    "NK-cells" = c("0" = "white", 
                                                   "1" = "red"),
                                    "B-cells" = c("0" = "white", 
                                                  "1" = "red"),
                                    "monocytes" = c("0" = "white", 
                                                    "1" = "red"),
                                    "granulocytes" = c("0" = "white", 
                                                       "1" = "red"),
                                    "dendritic cells" = c("0" = "white", 
                                                          "1" = "red"),
                                    "Cell type" = cell_type_palette_old), 
           # cluster_cols = col_clust,
           clustering_method = "ward.D2", 
           show_colnames = F, 
           annotation_legend = F,
           # legend = F,
           filename = savepath("Blood marker heatmap.pdf"),
           width = 10, 
           height = 6)


# plot_data %>% 
#   
#   select(id, ensg_id, max_tmm) %>% 
#   spread(ensg_id, max_tmm) %>% 
#   column_to_rownames("id") %>% 
#   
#   pheatmap(color = heatmap_palette,
#            annotation_row = row_ann, 
#            annotation_col = col_ann,
#            annotation_colors = list("T-cells" = c("0" = "white", 
#                                                   "1" = "red"),
#                                     "NK-cells" = c("0" = "white", 
#                                                    "1" = "red"),
#                                     "B-cells" = c("0" = "white", 
#                                                   "1" = "red"),
#                                     "monocytes" = c("0" = "white", 
#                                                     "1" = "red"),
#                                     "granulocytes" = c("0" = "white", 
#                                                        "1" = "red"),
#                                     "dendritic cells" = c("0" = "white", 
#                                                           "1" = "red"),
#                                     "Cell type" = cell_type_palette_old),
#            clustering_method = "ward.D2", 
#            show_colnames = F)





```

#Make UMAP cluster borders

```{r}
umap_coords <- 
  read_delim("data/sc_umap_coordinates.tab", delim = "\t", 
             col_types = cols("tissue_name" = col_character(),
                              "assay_id" = col_character(),
                              "cell_id" = col_character(),
                              "cluster_id" = col_character()))




library(ggalt)
library(sf)
library(concaveman)

plot_data_hulls <-
  umap_coords %>% 
  # filter(assay_id == assay_id[1]) %>%
  
  # Remove alone outlier points  
  left_join(group_by(., assay_id, cluster_id) %>%
              do({
                
                select(., cell_id, x, y) %>% 
                  column_to_rownames("cell_id") %>% 
                  dist() %>%
                  as.matrix() %>% 
                  apply(MARGIN = 1,
                        function(x) {
                          min(x[x > 0])
                        }) %>%
                  enframe("cell_id", "min_dist")
              })) %>%
  mutate(cluster_mean = mean(min_dist), 
         cluster_sd = sd(min_dist)) %>%
  ungroup() %>%
  filter(min_dist < cluster_mean + 1.5 * cluster_sd) %>%
  
  # Remove outlier points based on center
  group_by(assay_id, cluster_id) %>% 
  mutate(mean_x = mean(x),
         mean_y = mean(y),
         center_dist = sqrt((mean_x - x)^2 + (mean_y - y)^2),
         mean_center_dist = mean(center_dist),
         sd_center_dist = sd(center_dist)) %>%
  ungroup() %>%
  filter(center_dist < mean_center_dist + 1.5 * sd_center_dist) %>%
  
  
  # Calculate hulls
  group_by(assay_id, cluster_id) %>% 
  do({
    st_as_sf(., coords=c('x','y')) %>%
      concaveman(concavity = 2, length_threshold = .1) %$%
      st_coordinates(polygons) %>% 
      as_tibble()
  }) %>%
  ungroup()
  
  

plot_data <- 
  umap_coords 
  
plot_data_clusters <-
  plot_data_hulls

plot_data %>%
  ggplot(aes(x,y, color = factor(cluster_id))) +
  geom_point() +
  geom_polygon(data = plot_data_clusters,
               aes(X, Y, fill = factor(cluster_id),
                   color = factor(cluster_id)),
               
               alpha = 0.2,
               size = 0.4, 
               # color = "black",
               show.legend = F) +
  facet_wrap(~ assay_id) +
  stripped_theme_facet
ggsave(savepath("UMAP hulls 2.pdf"), width = 45, height = 45)


plot_data %>%
  ggplot(aes(x,y, color = factor(cluster_id))) +
  # geom_point() +
  geom_polygon(data = plot_data_clusters,
               aes(X, Y, fill = factor(cluster_id),
                   color = factor(cluster_id)),
               
               alpha = 0.2,
               size = 0.4, 
               # color = "black",
               show.legend = F) +
  facet_wrap(~ assay_id) +
  stripped_theme_facet
ggsave(savepath("UMAP only hulls 2.pdf"), width = 45, height = 45)

```


#Generate external figures

##Hex scatter

```{r}

plot_data1 <- 
  list.files("data/processed/scatter", full.names = T) %>%
  set_names(., .) %>%
  lapply(function(file_name) read_delim(file_name, delim = "\t") ) %>% 
  bind_rows(.id = "file") %>%
  mutate(tissue = file %>% 
           gsub("^.*_", "", .) %>% 
           gsub(".txt$", "", .) %>%
           str_to_sentence()) %>%
  group_by(tissue) %>% 
  mutate(scEXP = 1e6 * scEXP / sum(scEXP)) %>%
  ungroup()

# plot_data1 %>% group_by(tissue) %>% summarise(sc = sum(scEXP), hpa = sum(hpaEXP))

plot_data2 <- 
  plot_data1 %>% 
  group_by(tissue) %>% 
  summarise(cor = cor(scEXP, hpaEXP, method = "spearman"))

plot_order <- 
  plot_data2 %>% 
  arrange(cor) %>% 
  pull(tissue)

plot_limits <- 
  c(1, max(c(plot_data1$scEXP, plot_data1$hpaEXP)))
    
plot_data1 %>%
  mutate(tissue = factor(tissue, plot_order)) %>%
  ggplot(aes(scEXP + 1, hpaEXP + 1)) +
  geom_abline(slope = 1, intercept = 0, 
              color = "gray40") +
  geom_hex(aes(fill = stat(log10(count))),
           bins = 50) +
  geom_text(data = plot_data2 %>%
              mutate(tissue = factor(tissue, plot_order)),
            aes(10, 1e5, label = round(cor, 3)),
            size = 5, 
            fontface = "bold") +
  facet_wrap(~tissue) +
  scale_fill_viridis_c() +
  scale_x_log10(limits = plot_limits) +
  scale_y_log10(limits = plot_limits) +
  stripped_theme_facet +
  coord_fixed() +
  ylab("Whole tissue pTPM + 1") +
  xlab("Single cell pseudo-bulk pTPM + 1") +
  theme(legend.position = "top")
ggsave(savepath("Tisse Single cell hex scatter all.pdf"), width = 8, height = 8)  

plot_data1 %>%
  filter(tissue == "Lung") %>%
  ggplot(aes(scEXP + 1, hpaEXP + 1)) +
  geom_abline(slope = 1, intercept = 0, 
              color = "gray40") +
  geom_hex(aes(fill = stat(log10(count))),
           bins = 50) +
  geom_text(data = plot_data2 %>%
              filter(tissue == "Lung") %>%
              mutate(tissue = factor(tissue, plot_order)),
            aes(10, 1e5, label = round(cor, 3)),
            size = 5, 
            fontface = "bold") +
  scale_fill_viridis_c() +
  scale_x_log10(limits = plot_limits) +
  scale_y_log10(limits = plot_limits) +
  stripped_theme_facet +
  coord_fixed() +
  ylab("Whole tissue pTPM + 1") +
  xlab("Single cell pseudo-bulk pTPM + 1") +
  theme(legend.position = "top")
ggsave(savepath("Tisse Single cell hex scatter lung.pdf"), width = 3, height = 3)  



plot_data1 <- 
  read_delim("data/processed/scatter/dataForScatter_cortex.txt", delim = "\t") 

# plot_data1 %>% group_by(tissue) %>% summarise(sc = sum(scEXP), hpa = sum(hpaEXP))

plot_data2 <- 
  plot_data1 %>% 
  summarise(cor = cor(scEXP, hpaEXP, method = "spearman"))

plot_limits <- 
  c(1, max(c(plot_data1$scEXP, plot_data1$hpaEXP)))
    
plot_data1 %>%
  # filter(tissue == "Lung") %>%
  ggplot(aes(scEXP + 1, hpaEXP + 1)) +
  geom_abline(slope = 1, intercept = 0, 
              color = "gray40") +
  geom_hex(aes(fill = stat(log10(count))),
           bins = 50) +
  geom_text(data = plot_data2,
            aes(10, 1e4, label = round(cor, 3)),
            size = 5, 
            fontface = "bold") +
  scale_fill_viridis_c() +
  scale_x_log10(limits = plot_limits) +
  scale_y_log10(limits = plot_limits) +
  stripped_theme_facet +
  coord_fixed() +
  ylab("Whole tissue pTPM + 1") +
  xlab("Single cell pseudo-bulk pTPM + 1") +
  theme(legend.position = "top")
ggsave(savepath("Tisse Single cell hex scatter Cortex.pdf"), width = 3, height = 3)  

```

##Hyper heatmaps

```{r}

p_lim = 0.05

#####

plot_data1 <- 
  read_delim("data/processed/heatmaps/hgPvalueMatrix_supp.txt", delim = "\t") %>% 
  rename(tissue2 = X1) %>%
  mutate(tissue2 = ifelse(tissue2 == "cervix", 
                          "cervix, uterine", 
                          tissue2)) %>% 
  filter(tissue2 != " uterine")

p_min <-
  plot_data1[,-1] %>%
  unlist %>% 
  unique() %>% 
  enframe() %>% 
  filter(value > 0) %>%
  pull(value) %>% 
  min()

plot_data <- 
  plot_data1 %>% 
  gather(tissue1, p_val, -1) %>% 
  mutate(p_val = ifelse(p_val == 0, p_min, p_val),
         adj_p = p.adjust(p_val, method = "BH"),
         log_p = -log10(adj_p),
         log_p = case_when(log_p < -log10(p_lim) ~ 0,
                           T ~ log_p)) %>%
  mutate(tissue1 = ifelse(tissue1 == "Prostate glands, eptithelial cells",
                                 "Prostate glands, epithelial cells",
                                 tissue1)) %>% 
  mutate(tissue1 = case_when(tissue1 == "Prostate glands, epithelial cells" ~
                                      "Glandular cells",
                                    tissue1 == "Prostate glands, basal cells" ~
                                      "Basal glandular cells",
                                    tissue1 == "Renal tubules, proximal cells" ~
                                      "Proximal tubular cells",
                                    tissue1 == "Renal tubules, distal cells" ~
                                      "Distal tubular cells",
                                    tissue1 == "Basal keratinocytes (undifferentiated)" ~
                                      "Basal keratinocytes",
                                    tissue1 == "Suprabasal keratinocytes (differentiated)" ~
                                      "Suprabasal keratinocytes",
                                    tissue1 == "Ductal epithelial cells" ~
                                      "Ductal cells",
                                    tissue1 == "B lymphocytes" ~
                                      "B-cells",
                                    tissue1 == "T lymphocytes" ~
                                      "T-cells",
                                    tissue1 == "Macrophages (Hofbauer cells)" ~
                                      "Hofbauer cells",
                                    tissue1 == "Macrophages (Kupffer cells)" ~
                                      "Kupffer cells",
                                    tissue1 == "Syncytotrophoblasts" ~
                                      "Syncytiotrophoblasts",
                                    tissue1 == "Hepatic stellate cells" ~
                                      "Ito cells", 
                                    tissue1 == "Islets of Langerhans" |
                                      tissue1 == "islets of Langerhans" ~
                                      "Pancreatic endocrine cells", 
                                    tissue1 == "Neuroendocrine cells" ~
                                      "Intestinal endocrine cells",
                                    tissue1 == "Bronchial epithelium, Club cells" ~
                                      "Club cells", 
                                    tissue1 == "Acinar cells" ~
                                      "Exocrine glandular cells",
                                    tissue1 == "collecting duct cells" ~
                                      "Collecting duct cells",
                                    
                                    T ~ tissue1))
  
plot_data_p <- 
  plot_data


plot_data2 <- 
  plot_data %>%
  select(tissue1, tissue2, log_p) %>%
  spread(tissue2, log_p) %>% 
  column_to_rownames("tissue1")

plot_clus1 <- 
  plot_data2 %>% 
  dist(method = "binary") %>% 
  hclust(method = "ward.D2")

plot_clus2 <- 
  plot_data2 %>% 
  t() %>%
  dist(method = "binary") %>% 
  hclust(method = "ward.D2")


ggplot() + 
  theme_void() +
  
  #####
  ggdendrogram(plot_clus1, 
               labels = F, 
               leaf_labels = F) + 
  scale_x_continuous(expand = expansion(0, 0.5)) +
  theme_void() +
  theme(panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm")) +
  ####
  ggdendrogram(plot_clus2, rotate = T) + 
  scale_y_reverse() +
  scale_x_continuous(expand = expansion(0, 0.5)) +
  theme_void() +
  theme(panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm")) +
  #####
  plot_data %>% 
  ungroup() %>%
  mutate(tissue1 = factor(tissue1, labels(plot_clus1)),
         tissue2 = factor(tissue2, labels(plot_clus2))) %>%
  ggplot(aes(tissue1, tissue2, fill = log_p, size = log_p)) +
  geom_blank() +
  geom_point(data = . %>% 
               filter(adj_p < p_lim),
             shape = 21, 
             alpha = 0.8,
             stroke = 0.2,
             color = "black") + 
  # scale_color_viridis(option = "E", direction = 1, 
  #                    name = "Adjusted p-value") + 
  scale_fill_gradientn(colors = ggsci::rgb_material(palette = "deep-orange")) +
  scale_size_continuous(range = c(1, 4)) +
  scale_y_discrete(position = "right") +
  stripped_theme +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.2),
        legend.position = "bottom", 
        panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm"),
        panel.grid.major = element_line(color = "gray80", size = 0.3),
        axis.title.y = element_blank()) +
  xlab("Cell type") +
  
  ####
  plot_layout(widths = c(0.1, 1), 
              heights = c(0.2, 1))

ggsave(savepath("Hyper heatmap full.pdf"), width = 8, height = 20, useDingbats = F) 

#####

plot_data <- 
  read_delim("data/processed/heatmaps/hgPvalueMatrix.txt", delim = "\t") %>% 
  rename(tissue2 = X1) %>% 
  gather(tissue1, p_val, -1) %>% 
  mutate(p_val = ifelse(p_val == 0, p_min, p_val)) %>% 
  left_join(plot_data_p %>% 
              select(-p_val))
  
plot_data2 <- 
  plot_data %>%
  select(tissue1, tissue2, log_p) %>%
  spread(tissue2, log_p) %>% 
  column_to_rownames("tissue1")

plot_clus1 <- 
  plot_data2 %>% 
  dist(method = "binary") %>% 
  hclust(method = "ward.D2")

plot_clus2 <- 
  plot_data2 %>% 
  t() %>%
  dist(method = "binary") %>% 
  hclust(method = "ward.D2")


ggplot() + 
  theme_void() +
  
  #####
  ggdendrogram(plot_clus1, 
               labels = F, 
               leaf_labels = F) + 
  scale_x_continuous(expand = expansion(0, 0.5)) +
  theme_void() +
  theme(panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm")) +
  ####
  ggdendrogram(plot_clus2, rotate = T) + 
  scale_y_reverse() +
  scale_x_continuous(expand = expansion(0, 0.5)) +
  theme_void() +
  theme(panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm")) +
  #####
  plot_data %>% 
  ungroup() %>%
  mutate(tissue1 = factor(tissue1, labels(plot_clus1)),
         tissue2 = factor(tissue2, labels(plot_clus2))) %>%
  ggplot(aes(tissue1, tissue2, fill = log_p, size = log_p)) +
  geom_blank() +
  geom_point(data = . %>% 
               filter(adj_p < p_lim),
             shape = 21, 
             alpha = 0.8,
             stroke = 0.2,
             color = "black") + 
  # scale_color_viridis(option = "E", direction = 1, 
  #                    name = "Adjusted p-value") + 
  scale_fill_gradientn(colors = ggsci::rgb_material(palette = "deep-orange")) +
  scale_size_continuous(range = c(1, 4)) +
  scale_y_discrete(position = "right") +
  stripped_theme +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.2),
        legend.position = "bottom", 
        panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm"),
        panel.grid.major = element_line(color = "gray80", size = 0.3),
        axis.title.y = element_blank()) +
  xlab("Cell type") +
  
  ####
  plot_layout(widths = c(0.1, 1), 
              heights = c(0.2, 1))

ggsave(savepath("Hyper heatmap main 1.pdf"), width = 8, height = 8)  


#####

plot_data1 <- 
  read_delim("data/processed/heatmaps/hgPvalueMatrix.txt", delim = "\t") %>% 
  rename(tissue2 = X1) 



plot_data <- 
  plot_data1 %>%
  gather(tissue1, p_val, -1) %>% 
  mutate(p_val = ifelse(p_val == 0, p_min, p_val)) %>% 
  left_join(plot_data_p %>% 
              select(-p_val))
  




plot_data %>% 
  ungroup() %>%
  mutate(tissue1 = factor(tissue1, colnames(plot_data1)[-1]),
         tissue2 = factor(tissue2, rev(plot_data1$tissue2))) %>%
  ggplot(aes(tissue1, tissue2, fill = log_p, size = log_p)) +
  geom_blank() +
  geom_point(data = . %>% 
               filter(adj_p < p_lim),
             shape = 21, 
             alpha = 0.8,
             stroke = 0.2,
             color = "black") + 
  # scale_color_viridis(option = "E", direction = 1, 
  #                    name = "Adjusted p-value") + 
  scale_fill_gradientn(colors = ggsci::rgb_material(palette = "deep-orange")) +
  scale_size_continuous(range = c(1, 4)) +
  scale_y_discrete(position = "right") +
  stripped_theme +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.2),
        legend.position = "bottom", 
        panel.spacing = unit(0, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm"),
        panel.grid.major = element_line(color = "gray80", size = 0.3),
        axis.title.y = element_blank()) +
  xlab("Cell type") 

ggsave(savepath("Hyper heatmap main 2.pdf"), width = 8, height = 8)  

#####


plot_data %>% 
  ungroup() %>%
  mutate(tissue1 = factor(tissue1, colnames(plot_data1)[-1]),
         tissue2 = factor(tissue2, rev(plot_data1$tissue2)),
         type = case_when(tissue2 %in% c('lung',
                                         'kidney',
                                         'prostate',
                                         'skin',
                                         'liver',
                                         'pancreas',
                                         'intestine',
                                         'retina',
                                         'heart muscle',
                                         'placenta',
                                         'testis',
                                         'blood') ~ "Tissue",
                          tissue2 %in% c('B-cells',
                                         'NK-cells',
                                         'T-cells',
                                         'dendritic cells',
                                         'granulocytes',
                                         'monocytes') ~ "Blood cell",
                          tissue2 %in% c('Hep G2',
                                         'CACO-2',
                                         'SH-SY5Y',
                                         'RH-30',
                                         'BEWO',
                                         'TIME',
                                         'U-698',
                                         'MOLT-4',
                                         'U-937',
                                         'K-562') ~ "Cell line"),
         type = factor(type, c("Tissue", "Blood cell", "Cell line"))) %>%
  ggplot(aes(tissue1, tissue2, fill = log_p, size = log_p)) +
  geom_blank() +
  geom_point(data = . %>% 
               filter(adj_p < p_lim),
             shape = 21, 
             alpha = 0.8,
             stroke = 0.2,
             color = "black") + 
  # scale_color_viridis(option = "E", direction = 1, 
  #                    name = "Adjusted p-value") + 
  scale_fill_gradientn(colors = ggsci::rgb_material(palette = "deep-orange")) +
  scale_size_continuous(range = c(1, 4)) +
  scale_y_discrete(position = "right") +
  facet_grid(type ~ ., scales = "free_y", space = "free") +
  stripped_theme_facet +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.2), 
        strip.placement = "outside",
        legend.position = "bottom", 
        panel.spacing = unit(1, "mm"),
        plot.margin = unit(c(0,0,0,0), "mm"),
        panel.grid.major = element_line(color = "gray80", size = 0.3),
        axis.title.y = element_blank()) +
  xlab("Cell type") 

ggsave(savepath("Hyper heatmap main 3.pdf"), width = 8, height = 8)  

```









#Cluster data on markers

```{r}

A <- 
  uppsala_cell_markers %>% 
  filter(!is.na(gene_name)) %>%
  separate_rows(gene_name, sep = ", ") %>%
  left_join(gene_info92 %>% 
              select(gene_name, ensg_id)) %>%
  select(tissue, cell_type, gene_name, ensg_id, annotator)

B <- 
  max_cell_markers %>% 
  separate_rows(cell_type, sep = ", ") 

A %>% 
  select(cell_type, gene_name)  %>% 
  unique() %>% 
  full_join(B %>% 
  select(cell_type, gene_name)  %>% 
  unique(), 
  by = c("gene_name")) %>% mutate(same = cell_type.y == cell_type.x) 

all_cell_markers <- 
  uppsala_cell_markers %>% 
  filter(!is.na(gene_name)) %>%
  separate_rows(gene_name, sep = ", ") %>%
  left_join(gene_info92 %>% 
              select(gene_name, ensg_id)) %>%
  select(tissue, cell_type, gene_name, ensg_id, annotator) %>% 
  bind_rows(max_cell_markers %>% 
              separate_rows(cell_type, sep = ", ") )
  
all_cell_markers %>%
  group_by(cell_type) %>% 
  summarise(gene_names = paste(gene_name, collapse = ", ")) %>% 
  write_csv(savepath("All cell markers.csv"))

all_cell_markers %>% 
  select(gene_name, cell_type) %>% 
  unique() %>%
  mutate(yes = 1) %>% 
  spread(gene_name, yes, fill = 0) %>% 
  column_to_rownames("cell_type") %>% 
  pheatmap(clustering_method = "ward.D2")

plot_clust1 <- 
  all_cell_markers %>% 
  select(gene_name, cell_type) %>% 
  unique() %>%
  mutate(yes = 1) %>% 
  spread(gene_name, yes, fill = 0) %>% 
  column_to_rownames("cell_type") %>% 
  t() %>%
  dist() %>%
  hclust(method = "ward.D2")

plot_clust2 <- 
  all_cell_markers %>% 
  select(gene_name, cell_type) %>% 
  unique() %>%
  mutate(yes = 1) %>% 
  spread(gene_name, yes, fill = 0) %>% 
  column_to_rownames("cell_type") %>% 
  dist() %>%
  hclust(method = "ward.D2")

all_cell_markers %>% 
  select(gene_name, cell_type) %>% 
  unique() %>% 
  mutate(y1 = scales::rescale(unclass(factor(gene_name,
                                             levels = plot_clust1 %>% 
                                               dendro_data() %$% 
                                               labels %>% 
                                               pull(label))), c(0,1)),
         y2 = scales::rescale(unclass(factor(cell_type,
                                             levels = plot_clust2 %>% 
                                               dendro_data() %$% 
                                               labels %>% 
                                               pull(label))), c(0,1))) %>% 
  ggplot() + 
  geom_text(data = . %>% 
              select(y1, gene_name) %>% 
              unique(), 
            aes(x = 1, y = y1, label = gene_name), 
            hjust = 1) + 
  geom_text(data = . %>% 
              select(y2, cell_type) %>% 
              unique(), 
            aes(x = 2, y = y2, label = cell_type, color = cell_type),
            hjust = 0,
            size = 8,
            show.legend = F) + 
  geom_segment(aes(x = 1, xend = 2, 
                   y = y1, yend = y2, 
                   color = cell_type),
               show.legend = F) + 
  scale_x_continuous(expand = expansion(c(0.2, 1))) + 
  scale_color_manual(values = cell_type_palette) +
  theme_void() 
ggsave(savepath("Marker connections.pdf"), width = 15, height = 20)


all_cell_markers

cluster_annotation_id <- 
  cluster_annotation %>% 
  mutate(unique_cluster_id = paste(dataset_id, gsub("Cluster-", "", cluster_id)))

cluster_marker_pca_data <- 
  cluster_norm_count %>% 
  filter(ensg_id %in% all_cell_markers$ensg_id) %>% 
  left_join(cluster_annotation_id,
            by = c("dataset", "cluster_id")) %>% 
  select(unique_cluster_id, ensg_id, norm_count) %>%
  group_by(ensg_id) %>% 
  mutate(norm_count = log10(norm_count + 1)) %>%
  spread(unique_cluster_id, norm_count) %>% 
  column_to_rownames("ensg_id") %>% 
  t()

cluster_marker_pca <- 
  cluster_marker_pca_data %>% 
  pca_calc(npcs = 10)

PC1_lims <- 
  cluster_marker_pca$scores[,"PC1"] %>%
  {c(min(.), max(.))}

PC2_lims <- 
  cluster_marker_pca$scores[,"PC2"] %>%
  {c(min(.), max(.))}

cluster_annotation_id %>%
  select(cell_type) %>% 
  unique() %>% 
  arrange(cell_type) %>% 
  mutate() %>% 
  pull(cell_type) %>%
  paste(collapse = "' = '',\n'") %>%
  cat
  

plot_data <- 
  cluster_marker_pca$scores %>% 
  as_tibble(rownames = "unique_cluster_id") %>% 
  left_join(cluster_annotation_id) %>% 
  mutate(cell_type = ifelse(is.na(cell_type), 
                            "Unknown",
                            cell_type))

g1 <- 
  plot_data %>% 
  ggplot(aes(PC1, PC2, color = cell_type)) + 
  stat_density_2d(data = . %>%
                    group_by(cell_type) %>% 
                    mutate(n = n()) %>% 
                    ungroup() %>% 
                    filter(n > 1),
                  geom = "polygon", 
                  aes(PC1, PC2, 
                      fill = cell_type,
                      alpha = as.factor(..level..)),
                  inherit.aes = F,
                  bins = 20, 
                  show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7, 
             show.legend = F) + 
  geom_text(aes(label = paste(dataset_id, str_extract(cluster_id, "\\d*$"))),
            color = "black") +
  scale_color_manual(values = cell_type_palette) +
  scale_fill_manual(values = cell_type_palette) +
  scale_alpha_discrete(range = c(0, 0.05)) + 
  
  geom_text(data = cluster_marker_pca$loadings %>% 
              as_tibble(rownames = "ensg_id") %>% 
              left_join(gene_info92) %>% 
              select(1:3, gene_name) %>% 
              mutate(PC1 = scales::rescale(PC1, PC1_lims),
                     PC2 = scales::rescale(PC2, PC2_lims),
                     len = sqrt(PC1^2 + PC2^2)) %>% 
              arrange(-len) %>% 
              head(150),
            aes(PC1, PC2, label = gene_name ),
            inherit.aes = F, 
            alpha = 0.5) + 
  stripped_theme

ggsave(savepath("Marker PCA.pdf"), plot = g1, width = 10, height = 10) 

plot_data %>% 
  filter(is.na(cell_type))


plots <- 
  lapply(unique(plot_data$cell_type),
         function(cell_) {
           plot_data %>% 
             mutate(cell_type = ifelse(cell_type == cell_,
                                       cell_type, 
                                       " "),
                    unique_cluster_id = ifelse(cell_type == " ",
                                               "", 
                                               unique_cluster_id)) %>%
             ggplot(aes(PC1, PC2, color = cell_type)) + 
             stat_density_2d(data = . %>%
                               group_by(cell_type) %>% 
                               mutate(n = n()) %>% 
                               ungroup() %>% 
                               filter(n > 1),
                             geom = "polygon", 
                             aes(PC1, PC2, 
                                 fill = cell_type,
                                 alpha = as.factor(..level..)),
                             inherit.aes = F,
                             bins = 20, 
                             show.legend = F, h = c(4, 4)) +
             geom_point(size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             
             scale_color_manual(values = cell_type_palette) +
             scale_fill_manual(values = cell_type_palette) +
             scale_alpha_discrete(range = c(0, 0.05)) + 
             
             geom_text(data = cluster_marker_pca$loadings %>% 
                         as_tibble(rownames = "ensg_id") %>% 
                         left_join(gene_info92) %>% 
                         select(1:3, gene_name) %>% 
                         mutate(PC1 = scales::rescale(PC1, PC1_lims),
                                PC2 = scales::rescale(PC2, PC2_lims),
                                len = sqrt(PC1^2 + PC2^2)) %>% 
                         arrange(-len) %>% 
                         head(150),
                       aes(PC1, PC2, label = gene_name ),
                       inherit.aes = F, 
                       alpha = 0.5) + 
             geom_point(data = . %>% 
                          filter(cell_type != " "),
                        size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             geom_text(aes(label = unique_cluster_id),
                       color = "black") +
             stripped_theme + 
             ggtitle(cell_)
         })

pdf(savepath("PCA each cell type highlighted.pdf"), width = 10, height = 10, useDingbats = F)
plots
dev.off()


plots <- 
  lapply(unique(plot_data$cell_type),
         function(cell_) {
           g1 + plot_data %>% 
             mutate(cell_type = ifelse(cell_type == cell_,
                                       cell_type, 
                                       " "),
                    unique_cluster_id = ifelse(cell_type == " ",
                                               "", 
                                               unique_cluster_id)) %>%
             ggplot(aes(PC1, PC2, color = cell_type)) + 
             stat_density_2d(data = . %>%
                               group_by(cell_type) %>% 
                               mutate(n = n()) %>% 
                               ungroup() %>% 
                               filter(n > 1),
                             geom = "polygon", 
                             aes(PC1, PC2, 
                                 fill = cell_type,
                                 alpha = as.factor(..level..)),
                             inherit.aes = F,
                             bins = 20, 
                             show.legend = F, h = c(4, 4)) +
             geom_point(size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             
             scale_color_manual(values = cell_type_palette) +
             scale_fill_manual(values = cell_type_palette) +
             scale_alpha_discrete(range = c(0, 0.05)) + 
             
             geom_text(data = cluster_marker_pca$loadings %>% 
                         as_tibble(rownames = "ensg_id") %>% 
                         left_join(gene_info92) %>% 
                         select(1:3, gene_name) %>% 
                         mutate(PC1 = scales::rescale(PC1, PC1_lims),
                                PC2 = scales::rescale(PC2, PC2_lims),
                                len = sqrt(PC1^2 + PC2^2)) %>% 
                         arrange(-len) %>% 
                         head(150),
                       aes(PC1, PC2, label = gene_name ),
                       inherit.aes = F, 
                       alpha = 0.5) + 
             geom_point(data = . %>% 
                          filter(cell_type != " "),
                        size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             geom_text(aes(label = unique_cluster_id),
                       color = "black") +
             stripped_theme + 
             ggtitle(cell_)
         })

pdf(savepath("PCA each cell type highlighted with full PCA.pdf"), width = 20, height = 10, useDingbats = F)
plots
dev.off()

#### UMAP
cluster_marker_umap <- 
  cluster_marker_pca_data %>% 
  umap_calc(npcs = 2, n_neighbors = 200)

plot_data <- 
  cluster_marker_umap$layout %>% 
  as_tibble(rownames = "unique_cluster_id") %>% 
  left_join(cluster_annotation_id) %>% 
  mutate(cell_type = ifelse(is.na(cell_type), 
                            "Unknown",
                            cell_type))


g1 <- 
  plot_data %>% 
  ggplot(aes(V1, V2, color = cell_type)) + 
  stat_density_2d(data = . %>%
                    group_by(cell_type) %>% 
                    mutate(n = n()) %>% 
                    ungroup() %>% 
                    filter(n > 1),
                  geom = "polygon", 
                  aes(V1, V2, 
                      fill = cell_type,
                      alpha = as.factor(..level..)),
                  inherit.aes = F,
                  bins = 20, 
                  show.legend = F, h = c(2, 2)) +
  geom_point(size = 5, 
             alpha = 0.7, 
             show.legend = F) + 
  geom_text(aes(label = paste(dataset_id, str_extract(cluster_id, "\\d*$"))),
            color = "black") +
  scale_color_manual(values = cell_type_palette) +
  scale_fill_manual(values = cell_type_palette) +
  scale_alpha_discrete(range = c(0, 0.05)) + 
  
  stripped_theme
g1
ggsave(savepath("Marker UMAP.pdf"), plot = g1, width = 10, height = 10) 

plots <- 
  lapply(unique(plot_data$cell_type),
         function(cell_) {
           plot_data %>% 
             mutate(cell_type = ifelse(cell_type == cell_,
                                       cell_type, 
                                       " "),
                    unique_cluster_id = ifelse(cell_type == " ",
                                               "", 
                                               unique_cluster_id)) %>%
             ggplot(aes(V1, V2, color = cell_type)) + 
             stat_density_2d(data = . %>%
                               group_by(cell_type) %>% 
                               mutate(n = n()) %>% 
                               ungroup() %>% 
                               filter(n > 1),
                             geom = "polygon", 
                             aes(V1, V2, 
                                 fill = cell_type,
                                 alpha = as.factor(..level..)),
                             inherit.aes = F,
                             bins = 20, 
                             show.legend = F, h = c(2, 2)) +
             geom_point(size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             scale_color_manual(values = cell_type_palette) +
             scale_fill_manual(values = cell_type_palette) +
             scale_alpha_discrete(range = c(0, 0.05)) + 
             geom_point(data = . %>% 
                          filter(cell_type != " "),
                        size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             geom_text(aes(label = unique_cluster_id),
                       color = "black") +
             stripped_theme + 
             ggtitle(cell_)
             
         })

pdf(savepath("UMAP each cell type highlighted.pdf"), width = 10, height = 10, useDingbats = F)
plots
dev.off()


plots <- 
  plots <- 
  lapply(unique(plot_data$cell_type),
         function(cell_) {
           g1 + plot_data %>% 
             mutate(cell_type = ifelse(cell_type == cell_,
                                       cell_type, 
                                       " "),
                    unique_cluster_id = ifelse(cell_type == " ",
                                               "", 
                                               unique_cluster_id)) %>%
             ggplot(aes(V1, V2, color = cell_type)) + 
             stat_density_2d(data = . %>%
                               group_by(cell_type) %>% 
                               mutate(n = n()) %>% 
                               ungroup() %>% 
                               filter(n > 1),
                             geom = "polygon", 
                             aes(V1, V2, 
                                 fill = cell_type,
                                 alpha = as.factor(..level..)),
                             inherit.aes = F,
                             bins = 20, 
                             show.legend = F, h = c(2, 2)) +
             geom_point(size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             scale_color_manual(values = cell_type_palette) +
             scale_fill_manual(values = cell_type_palette) +
             scale_alpha_discrete(range = c(0, 0.05)) + 
             geom_point(data = . %>% 
                          filter(cell_type != " "),
                        size = 5, 
                        alpha = 0.7, 
                        show.legend = F) + 
             geom_text(aes(label = unique_cluster_id),
                       color = "black") +
             stripped_theme + 
             ggtitle(cell_)
             
         })

pdf(savepath("UMAP each cell type highlighted with full PCA.pdf"), width = 20, height = 10, useDingbats = F)
plots
dev.off()
```

##Prostate

```{r}
prostate_cell_markers <- 
  uppsala_cell_markers %>% 
  filter(tissue == "Prostate") %>% 
  filter(!is.na(gene_name)) %>%
  separate_rows(gene_name, sep = ", ") %>%
  left_join(gene_info92 %>% 
              select(gene_name, ensg_id)) %>%
  select(tissue, cell_type, gene_name, ensg_id, annotator) 




prostate_marker_pca_data <- 
  cluster_norm_count %>% 
  filter(grepl("Prostate", dataset)) %>%
  filter(ensg_id %in% prostate_cell_markers$ensg_id) %>% 
  left_join(cluster_annotation_id,
            by = c("dataset", "cluster_id")) %>% 
  select(unique_cluster_id, ensg_id, norm_count) %>%
  group_by(ensg_id) %>% 
  mutate(norm_count = log10(norm_count + 1)) %>%
  spread(unique_cluster_id, norm_count) %>% 
  column_to_rownames("ensg_id") %>% 
  t()

prostate_marker_pca <- 
  prostate_marker_pca_data %>% 
  pca_calc(npcs = 10)

PC1_lims <- 
  prostate_marker_pca$scores[,"PC1"] %>%
  {c(min(.), max(.))}

PC2_lims <- 
  prostate_marker_pca$scores[,"PC2"] %>%
  {c(min(.), max(.))}


plot_data <- 
  prostate_marker_pca$scores %>% 
  as_tibble(rownames = "unique_cluster_id") %>% 
  left_join(cluster_annotation_id) %>% 
  mutate(cell_type = ifelse(is.na(cell_type), 
                            "Unknown",
                            cell_type))

g1 <- 
  plot_data %>% 
  ggplot(aes(PC1, PC2, color = cell_type)) + 
  # stat_density_2d(data = . %>%
  #                   group_by(cell_type) %>% 
  #                   mutate(n = n()) %>% 
  #                   ungroup() %>% 
  #                   filter(n > 1),
  #                 geom = "polygon", 
  #                 aes(PC1, PC2, 
  #                     fill = cell_type,
  #                     alpha = as.factor(..level..)),
  #                 inherit.aes = F,
  #                 bins = 20, 
  #                 show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7, 
             show.legend = T) + 
  geom_text(aes(label = paste(dataset_id, str_extract(cluster_id, "\\d*$"))),
            color = "black") +
  scale_color_manual(values = cell_type_palette) +
  scale_fill_manual(values = cell_type_palette) +
  scale_alpha_discrete(range = c(0, 0.05)) + 
  
  geom_text(data = prostate_marker_pca$loadings %>% 
              as_tibble(rownames = "ensg_id") %>% 
              left_join(gene_info92) %>% 
              select(1:3, gene_name) %>% 
              mutate(PC1 = scales::rescale(PC1, PC1_lims),
                     PC2 = scales::rescale(PC2, PC2_lims),
                     len = sqrt(PC1^2 + PC2^2)) %>% 
              arrange(-len) %>% 
              head(150),
            aes(PC1, PC2, label = gene_name ),
            inherit.aes = F, 
            alpha = 0.5) + 
  stripped_theme
g1
ggsave(savepath("Prostate marker PCA.pdf"), plot = g1, width = 10, height = 10) 


cluster_norm_count %>% 
  filter(grepl("Prostate", dataset)) %>%
  filter(ensg_id %in% prostate_cell_markers$ensg_id) %>% 
  left_join(cluster_annotation_id,
            by = c("dataset", "cluster_id")) %>% 
  left_join(gene_info92) %>%
  mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
  select(row_id, gene_name, norm_count) %>%
  group_by(gene_name) %>% 
  mutate(norm_count = log10(norm_count + 1)) %>%
  spread(row_id, norm_count) %>% 
  filter(gene_name != "KRT10") %>%
  column_to_rownames("gene_name") %>% 
  t() %>%
  scale(center = F, scale = apply(., MARGIN = 2, 
                                  function(x) sqrt(sd(x)))) %>%
  # t( ) %>%
  pheatmap(clustering_method = "ward.D2", 
           color = heatmap_palette,
           border_color = NA,
           annotation_row = cluster_annotation_id %>% 
             mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
             filter(grepl("Prostate", dataset)) %>%
             select(cell_type, row_id, dataset) %>%
             column_to_rownames("row_id"),
           annotation_col = prostate_cell_markers %>%
             select(cell_type, gene_name) %>%
             mutate(yes = "yes") %>%
             spread(cell_type, yes, fill = "no") %>%
             column_to_rownames("gene_name"),
           annotation_colors = list("acinary" = c("yes" = "red", "no" = "white"),
                                    "B cells" = c("yes" = "red", "no" = "white"),             
                                    "Basal" = c("yes" = "red", "no" = "white"),
                                    "Endothelial cells" = c("yes" = "red", "no" = "white"),
                                    "Epithelial cells" = c("yes" = "red", "no" = "white"),
                                    "Fibroblasts" = c("yes" = "red", "no" = "white"),
                                    "Inflammatory cells" = c("yes" = "red", "no" = "white"),
                                    "Macrophages" = c("yes" = "red", "no" = "white"),
                                    "Smooth muscle cells" = c("yes" = "red", "no" = "white"),
                                    "T cells" = c("yes" = "red", "no" = "white"),
                                    "Urothelium" = c("yes" = "red", "no" = "white"),
                                    "Vesicula seminalis" = c("yes" = "red", "no" = "white"),
                                    "cell_type" = cell_type_palette),
           annotation_legend = F, 
           filename = savepath("Prostate marker heatmap.pdf"),
           width = 10, height = 10)
dev.off()

```

#Cluster same annotation differences

```{r}

cluster_diff_data <- 
  annotated_norm_count %>% 
  filter(tissue == "prostate") %>%
  select(cluster_id, ensg_id, norm_count, cell_type_name) %>%
  mutate(norm_count = ifelse(norm_count < 1, 1, norm_count)) %>%
  left_join(., .,
            by = c("cell_type_name", "ensg_id"),
            suffix = c("1", "2")) %>%
  filter(cluster_id1 != cluster_id2) %>%
  left_join(gene_info92) 
  
cluster_diff_res <- 
  cluster_diff_data %>%
  mutate(diff = norm_count2 - norm_count1,
         mean = (norm_count2 + norm_count1) / 2,
         ratio = norm_count2 / norm_count1) %>%
  filter(mean > 1) %>%
  arrange(-abs(ratio)) %>% 
  
  select(cluster_id1, cluster_id2, cell_type_name, ensg_id, gene_name, ratio, 
         ptpm1 = norm_count1, 
         ptpm2 = norm_count2) %>%
  filter(ratio >= 4)

top_genes <- 
  cluster_diff_res %>%
  group_by(cell_type_name) %>% 
  top_n(50, ratio)
  # filter(ratio > 100)

write_csv(top_genes, savepath("Top diff prostate genes.csv"))

plot_data <- 
  annotated_norm_count %>%
  filter(tissue == "prostate") %>%
  filter(ensg_id %in% top_genes$ensg_id) %>% 
  mutate(id = paste(cluster_id, cell_type_name)) %>%
  # mutate(id = factor(id, ))
  left_join(gene_info92)  

plots <- 
  lapply(unique(plot_data$gene_name),
         function(gene_) {
           plot_data %>% 
             filter(gene_name == gene_) %>%
             ggplot(aes(id, norm_count, fill = cell_type_name)) +
             geom_col(show.legend = F) +
             facet_grid(gene_name ~ cell_type_name, scales = "free", shrink = F) +
             
             scale_fill_manual(values = cell_type_palette) +
             theme_minimal() +
             theme(panel.spacing.x = unit(0, "mm"),
                   axis.text.x = element_text(angle = 60, hjust = 1),
                   axis.title = element_blank()) +
             ggtitle(gene_)
         })
  
pdf(savepath("Prostate highest cluster diff genes.pdf"), width = 10, height = 5)  
plots
dev.off()
```


# Heatmaps per tissue type

```{r}

cluster_annotation_latest <- 
  cluster_annotation_id %>% 
  mutate(cell_type = case_when(!is.na(annotation3) ~ annotation3,
                               T ~ cell_type))



# All
cluster_norm_count %>% 
  # filter(grepl("Prostate", dataset)) %>%
  filter(ensg_id %in% all_cell_markers$ensg_id) %>% 
  left_join(cluster_annotation_latest,
            by = c("dataset", "cluster_id")) %>% 
  left_join(gene_info92) %>%
  mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
  select(row_id, gene_name, norm_count) %>%
  group_by(gene_name) %>% 
  mutate(norm_count = norm_count / max(norm_count)) %>%
  spread(row_id, norm_count) %>% 
  filter(gene_name != "KRT10") %>%
  column_to_rownames("gene_name") %>% 
  t() %>%
  # scale(center = F, scale = apply(., MARGIN = 2, 
  #                                 function(x) sqrt(sd(x)))) %>%
  # t( ) %>%
  pheatmap(clustering_method = "ward.D2", 
           color = heatmap_palette,
           border_color = NA,
           annotation_row = cluster_annotation_latest %>% 
             mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
             
             select(cell_type, row_id, dataset) %>%
             column_to_rownames("row_id"),
           annotation_col = all_cell_markers %>%
             select(cell_type, gene_name) %>%
             mutate(yes = "yes") %>%
             unique() %>%
             spread(cell_type, yes, fill = "no") %>%
             column_to_rownames("gene_name"),
           annotation_colors = list('Macrophages' = c('yes' = 'red', 'no' = 'white'),
                                    'T cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Smooth muscle cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Fibroblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Endothelial cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Granulocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Type II pneumocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Type I pneumocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Bronchial epithelium, ciliated cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Bronchial epithelium, mucus-secreting cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Extravillous trophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Syncytotrophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Epithelial cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Basal' = c('yes' = 'red', 'no' = 'white'),
                                    'acinary' = c('yes' = 'red', 'no' = 'white'),
                                    'Inflammatory cells' = c('yes' = 'red', 'no' = 'white'),
                                    'B cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Vesicula seminalis' = c('yes' = 'red', 'no' = 'white'),
                                    'Urothelium' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell' = c('yes' = 'red', 'no' = 'white'),
                                    'Monocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell myeloid' = c('yes' = 'red', 'no' = 'white'),
                                    'Erythrocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell plasmacytoid' = c('yes' = 'red', 'no' = 'white'),
                                    'Basophils' = c('yes' = 'red', 'no' = 'white'),
                                    'NK cells' = c('yes' = 'red', 'no' = 'white'),
                                    'MAIT' = c('yes' = 'red', 'no' = 'white'),
                                    'Neutrophils' = c('yes' = 'red', 'no' = 'white'),
                                    'Neuroendocrine cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Cytotrophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Decidual cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Hofbauer cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Goblet cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Enterocytes' = c('yes' = 'red', 'no' = 'white'),
                                    "cell_type" = cell_type_palette),
           annotation_legend = F, 
           filename = savepath("All marker heatmap.pdf"),
           width = 18, height = 40)
dev.off()



dataset_map2 <- 
  c('Axillary lymph nodes' = 'Lymphatic system',
    'Breast' = 'Breast',
    'Colon' = 'GI',
    'Colon 2' = 'GI',
    'Eyes' = 'Eyes',
    'Eyes macula' = 'Eyes',
    'Eyes peripheral' = 'Eyes',
    'Head and neck lymph nodes' = 'Lymphatic system',
    'Heart' = 'Muscle',
    'Ileum' = 'GI',
    'Kidney' = 'Kidney',
    'Liver' = 'Liver',
    'Liver hep- CD45-' = 'Liver',
    'Liver hep- CD45+' = 'Liver',
    'Lung' = 'Lung',
    'Muscle' = 'Muscle',
    'NK cells blood' = 'Lymphatic system',
    'NK cells bone marrow' = 'Lymphatic system',
    'PBMCs' = 'Lymphatic system',
    'Placenta' = 'Placenta',
    'Placenta blood' = 'Placenta',
    'Prostate' = 'Prostate',
    'Prostate 2' = 'Prostate',
    'Prostate 3' = 'Prostate',
    'Rectum' = 'GI',
    'Testis' = 'Testis',
    'Testis 2' = 'Testis',
    'Testis 3' = 'Testis') %>%
  enframe("dataset", "tissue") %>%
  left_join(cluster_norm_count %>% 
              select(tissue_id, tissue) %>% 
              distinct())


unique_tissues <- 
  dataset_map %>% 
  pull(tissue) %>% 
  unique()
  

lapply(unique_tissues,
       function(tis_) {
         cat(tis_)
         tis_cell_markers <- 
           uppsala_cell_markers %>% 
           filter(tissue %in% c("General", tis_)) %>% 
           filter(!is.na(gene_name)) %>%
           separate_rows(gene_name, sep = ", ") %>%
           left_join(gene_info92 %>% 
                       select(gene_name, ensg_id)) %>%
           select(tissue, cell_type, gene_name, ensg_id, annotator) 
         
         cluster_norm_count %>% 
           left_join(dataset_map) %>%
           filter(grepl(tis_, tissue)) %>%
           filter(ensg_id %in% tis_cell_markers$ensg_id) %>% 
           left_join(cluster_annotation_latest,
                     by = c("dataset", "cluster_id")) %>% 
           left_join(gene_info92) %>%
           mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
           select(row_id, gene_name, norm_count) %>%
           group_by(gene_name) %>% 
           
           mutate(norm_count = norm_count / max(norm_count)) %>%
           filter(!is.na(norm_count)) %>%
           spread(row_id, norm_count) %>% 
           column_to_rownames("gene_name") %>% 
           
           t() %>%
           pheatmap(clustering_method = "ward.D2", 
                    color = heatmap_palette,
                    border_color = NA,
                    annotation_row = cluster_annotation_latest %>% 
                      mutate(row_id = paste(unique_cluster_id, cell_type)) %>%
                      
                      select(cell_type, row_id, dataset) %>%
                      column_to_rownames("row_id"),
                    annotation_col = tis_cell_markers %>%
                      select(cell_type, gene_name) %>%
                      mutate(yes = "yes") %>%
                      unique() %>%
                      spread(cell_type, yes, fill = "no") %>%
                      column_to_rownames("gene_name"),
                    annotation_colors = list('Macrophages' = c('yes' = 'red', 'no' = 'white'),
                                    'T cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Smooth muscle cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Fibroblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Endothelial cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Granulocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Type II pneumocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Type I pneumocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Bronchial epithelium, ciliated cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Bronchial epithelium, mucus-secreting cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Extravillous trophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Syncytotrophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Epithelial cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Basal' = c('yes' = 'red', 'no' = 'white'),
                                    'acinary' = c('yes' = 'red', 'no' = 'white'),
                                    'Inflammatory cells' = c('yes' = 'red', 'no' = 'white'),
                                    'B cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Vesicula seminalis' = c('yes' = 'red', 'no' = 'white'),
                                    'Urothelium' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell' = c('yes' = 'red', 'no' = 'white'),
                                    'Monocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell myeloid' = c('yes' = 'red', 'no' = 'white'),
                                    'Erythrocytes' = c('yes' = 'red', 'no' = 'white'),
                                    'Dendritic cell plasmacytoid' = c('yes' = 'red', 'no' = 'white'),
                                    'Basophils' = c('yes' = 'red', 'no' = 'white'),
                                    'NK cells' = c('yes' = 'red', 'no' = 'white'),
                                    'MAIT' = c('yes' = 'red', 'no' = 'white'),
                                    'Neutrophils' = c('yes' = 'red', 'no' = 'white'),
                                    'Neuroendocrine cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Cytotrophoblasts' = c('yes' = 'red', 'no' = 'white'),
                                    'Decidual cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Hofbauer cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Goblet cells' = c('yes' = 'red', 'no' = 'white'),
                                    'Enterocytes' = c('yes' = 'red', 'no' = 'white'),
                                    "cell_type" = cell_type_palette),
                    annotation_legend = F, 
                    main = tis_,
                    filename = savepath(paste(tis_, "marker heatmap.pdf")),
                    width = 12, height = 10)
         
         })




dev.off()
```


#Single cell example

```{r}

n_cell <- 1000
example_data <- 
  tibble(celltype = rep(LETTERS[1:3], each = n_cell),
         x = c(rnorm(n_cell, 1, 1),
               rnorm(n_cell, 1, 1),
               rnorm(n_cell, 2.5, 1.4)),
         y = c(rnorm(n_cell, 1, 0.5),
               rnorm(n_cell, 5, 1.2),
               rnorm(n_cell, 5, 1.2)),
         z = c(rnorm(n_cell, 3, 0.5),
               rnorm(n_cell, 3, 0.5),
               rnorm(n_cell, 3, 0.5)),
         a = c(rnorm(n_cell, 6, 2),
               rnorm(n_cell, 4, 2),
               rnorm(n_cell, 5, 1)),
         b = c(rnorm(n_cell, 2, 1),
               rnorm(n_cell, 2, 1),
               rnorm(n_cell, 1, 0.2)),
         c = c(rnorm(n_cell, 1, 0.5),
               rnorm(n_cell, 1.5, 0.3),
               rnorm(n_cell, 5, 0.1)),
         col = c(rnorm(n_cell, 1, 0.5),
                 rnorm(n_cell, 1.8, 0.5),
                 rnorm(n_cell, 10, 1.2))) %>% 
  mutate(cell_id = row_number())

example_umap <- 
  example_data %>% 
  select(-celltype) %>% 
  column_to_rownames("cell_id") %>% 
  umap()


g1 <- 
  example_umap$layout %>%
  as_tibble(rownames = "cell_id") %>% 
  mutate(cell_id = as.integer(cell_id)) %>%
  left_join(example_data) %>%
  ggplot(aes(V1, V2, color = celltype, alpha = col)) + 
  geom_point() + 
  stripped_theme

g2 <- 
  example_umap$layout %>%
  as_tibble(rownames = "cell_id") %>% 
  mutate(cell_id = as.integer(cell_id)) %>%
  left_join(example_data) %>%
  ggplot(aes(V1, V2, alpha = col)) + 
  geom_hex(aes(fill = celltype,
               alpha = stat(log10(count))),
           bins = 50) + 
  stripped_theme

g1 + g2
ggsave(savepath("Example HPA single cell.pdf"), width = 10, height = 6)
```


```{r}

prostate_coordinates <- 
  read_delim("data/clustering/ClusterCoordinates.txt", delim = "\t") %>% 
  set_names(c("cell_id", colnames(.)[-6]))

prostate_counts <- 
  read_delim("data/clustering/count.txt", delim = "\t") %>% 
  set_names(c("cell_id", colnames(.)[-6]))

prostate_coordinates %>% 
  ggplot(aes(X_umap, Y_umap, color = louvain, alpha = X_tsne)) + 
  geom_point() + 
  stripped_theme +
  scale_color_manual(values = cell_type_palette)

prostate_coordinates %>% 
  ggplot(aes(X_umap, Y_umap, z = X_tsne)) + 
  stat_summary_hex(aes(fill = louvain,
                       alpha = ..value..),
                   bins = 50,
                   fun = function(z) {mean(z)}) + 
  stripped_theme +
  scale_fill_manual(values = cell_type_palette)

prostate_coordinates %>% 
  ggplot(aes(X_tsne, Y_tsne, color = louvain, alpha = X_umap)) + 
  geom_point() + 
  stripped_theme +
  scale_color_manual(values = cell_type_palette) +
  
  prostate_coordinates %>% 
  ggplot(aes(X_tsne, Y_tsne, z = X_umap)) + 
  stat_summary_hex(aes(fill = louvain,
                       alpha = ..value..),
                   bins = 60,
                   fun = function(z) {mean(z)}) + 
  stripped_theme +
  scale_fill_manual(values = cell_type_palette)
                      
ggsave(savepath("Prostate hex example.pdf"), width = 14, height = 6)

prostate_coordinates %>% 
  ggplot(aes(X_tsne, Y_tsne, color = louvain, alpha = X_umap)) + 
  geom_point() + 
  stripped_theme +
  scale_color_manual(values = cell_type_palette) +
  
  prostate_coordinates %>% 
  ggplot(aes(X_tsne, Y_tsne, z = X_umap)) + 
  stat_summary_hex(aes(fill = louvain,
                       alpha = ..value..),
                   bins = 60,
                   fun = function(z) {mean(z)}) + 
  stripped_theme +
  scale_fill_manual(values = cell_type_palette)
                      
ggsave(savepath("Prostate hex example.pdf"), width = 14, height = 6)
```


#Heatmap examples

```{r}

liver_cell_markers <- 
  cell_markers %>% 
  filter(tissue %in% c("_General", "Eye")) %>%
  filter(!is.na(gene_name))

heatmap_data <- 
  annotated_norm_count %>% 
  filter(tissue == "eye") %>% 
  left_join(gene_info92) %>%
  filter(gene_name %in% liver_cell_markers$gene_name) %>%
  select(gene_name, cluster_id, norm_count, cell_type_name) %>%
  mutate(norm_count = ifelse(norm_count < 1, 0, norm_count)) %>%
  group_by(gene_name) %>% 
  mutate(max_count = max(norm_count),
         maxnorm_count = norm_count / max_count,
         lognorm_count = log10(norm_count + 1)) %>%
  filter(max_count >= 1) %>%
  ungroup() %>%
  mutate(id = paste0("c-", cluster_id, " ", cell_type_name)) 
  
row_cluster  <- 
  heatmap_data %>% 
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  column_to_rownames("id") %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_cluster  <- 
  heatmap_data %>% 
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  column_to_rownames("id") %>% 
  t() %>%
  dist() %>% 
  hclust(method = "ward.D2")

col_annotation <-
  liver_cell_markers %>%
  select(cell_type, gene_name) %>%
  mutate(yes = "1") %>%
  unique() %>%
  spread(cell_type, yes, fill = "0") %>%
  column_to_rownames("gene_name")
  
annotation_cluster <- 
  col_annotation %>% 
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")

colors_annotation <-
  col_annotation %>% 
  names() %>%
  {set_names(rep(list(c('1' = 'red', '0' = 'white')), length(.)), .)}


# 1: original
heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("1 - Original.pdf"),
           width = 18, 
           height = 13)

# 2: flipped 

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  t() %>%
  pheatmap(color = heatmap_palette,
           border_color = NA,
           cluster_rows = col_cluster,
           cluster_cols = row_cluster,
           annotation_row = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("2 - Flipped.pdf"),
           width = 13, 
           height = 18)

# 3: Log scale

heatmap_data %>% 
  
  select(gene_name, id, lognorm_count) %>% 
  spread(gene_name, lognorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("3 - Log scale.pdf"),
           width = 18, 
           height = 13)

# 4: Log scale with own clustering

heatmap_data %>% 
  
  select(gene_name, id, lognorm_count) %>% 
  spread(gene_name, lognorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           border_color = NA,
           # cluster_rows = row_cluster,
           # cluster_cols = col_cluster,
           clustering_method = "ward.D2",
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("4 - Log scale cluster by log.pdf"),
           width = 18, 
           height = 13)


# 5: Cluster marker heatmap

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation %>% 
             as_tibble(rownames = "row") %>%
             select(row, levels(dendro_data(annotation_cluster)$labels$label)) %>% 
             column_to_rownames("row"),
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("5 - Cluster markers.pdf"),
           width = 18, 
           height = 13)

# 6: Other palettes
heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = rev(c(viridis::inferno(20), "white")),
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("6 - Palette including white.pdf"),
           width = 18, 
           height = 13)

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = rev(c(viridis::viridis(20), "white")),
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("7 - Other palette.pdf"),
           width = 18, 
           height = 13)

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = viridis::cividis(20),
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("8 - Other palette.pdf"),
           width = 18, 
           height = 13)

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>% 
  pheatmap(color = rev(viridis::magma(20)),
           border_color = NA,
           cluster_rows = row_cluster,
           cluster_cols = col_cluster,
           annotation_col = col_annotation,
           annotation_colors = colors_annotation,
           annotation_legend = F,
           filename = savepath("9 - Other palette.pdf"),
           width = 18, 
           height = 13)

#####
A_levels <- 
  liver_cell_markers %>%
  filter(cell_type %in% heatmap_data$cell_type_name) %>%
  arrange(cell_type) %>% 
  pull(gene_name) %>%
  unique() 

B_levels <- 
  heatmap_data %>%
  arrange(cell_type_name) %>% 
  pull(id) %>% 
  unique()


heatmap_data %>%
  filter(gene_name %in% A_levels) %>%
  mutate(gene_name = factor(gene_name, A_levels),
         id = factor(id, B_levels)) %>%
  
  ggplot(aes(gene_name, id, fill = maxnorm_count)) + 
  geom_tile() + 
  
  scale_fill_viridis_c(option = "B", direction = -1) +
  
  stripped_theme + 
  theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))
  
ggsave(savepath("Heatmap example 1.pdf"), width = 6, height = 3)

heatmap_data %>%
  filter(gene_name %in% A_levels) %>%
  mutate(gene_name = factor(gene_name, A_levels),
         id = factor(id, B_levels)) %>%
  group_by(gene_name) %>%
  mutate(log_count = log10(norm_count + 1),
         sd = sd(log_count),
         mean = mean(log_count),
         z_score = (log_count - mean) / sd) %>%
  ggplot(aes(gene_name, id, fill = z_score)) + 
  geom_tile() + 
  
  scale_fill_gradientn(colors = pals::ocean.balance(20)) +
  
  stripped_theme + 
  theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))


ggsave(savepath("Heatmap example 2.pdf"), width = 6, height = 3)
#####

row_cluster %>% 
  dendro_data() %$% 
  left_join(segments, 
            labels,
            by = c("xend" = "x", "yend" = "y")) %>%
  write_delim(savepath("row cluster.tsv"), delim = "\t")

col_cluster %>% 
  dendro_data() %$% 
  left_join(segments, 
            labels,
            by = c("xend" = "x", "yend" = "y")) %>%
  write_delim(savepath("col cluster.tsv"), delim = "\t")

heatmap_data %>% 
  
  select(gene_name, id, maxnorm_count) %>% 
  spread(gene_name, maxnorm_count) %>% 
  
  column_to_rownames("id") %>%
  {.[row_cluster %>% 
       dendro_data() %$% 
       labels$label %>% 
       levels(),
     col_cluster %>% 
       dendro_data() %$% 
       labels$label %>%
       levels()]} %>%
  as_tibble(rownames = "cell_type") %>% 
  write_delim(savepath("heatmap data.tsv"), delim = "\t")

```


# Experimental

```{r different_group_n}

cell_type_class_all <- 
  tibble(group_n = 2:20) %>%
  group_by(group_n) %>%
  do({group_n <- .$group_n;cell_type_norm_count_clean %>% 
    hpa_gene_classification(expression_col = "norm_count", 
                            tissue_col = "cell_type_name", 
                            gene_col = "ensg_id", 
                            enr_fold = 4, 
                            max_group_n = group_n, 
                            det_lim = 1)})
  

cell_type_class_all %>%
  group_by(group_n, spec_category) %>%
  summarise(n = n()) %>%
  ggplot(aes(group_n, n, color = spec_category, label = n)) +
  geom_line() +
  geom_vline(xintercept = 10) +
  scale_color_manual(values = gene_category_pal) + 
  theme_minimal()
ggsave(savepath("N genes per spec cat per group n.pdf"), width = 5, height = 5)

class_table_temp <-
  cell_type_class_all %>%
  select(group_n, gene, spec_category, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>%
  mutate(spec_category = factor(spec_category, levels = rev(spec_category_levels)),
         enriched_tissues = (enriched_tissues))

plot_order <- 
  class_table_temp %>%
  filter(!is.na(enriched_tissues)) %>%
  group_by(group_n, enriched_tissues, spec_category, .drop = T) %>%
  summarise(n_genes = n()) %>% 
  ungroup() %>% 
  filter(group_n == 20) %>%
    select(-group_n) %>%
    spread(spec_category, n_genes) %>%
    column_to_rownames("enriched_tissues") %>%
    dist() %>%
    hclust(method = "ward.D2") %>%
    dendro_data() %$%
    labels %>%
    pull(label)
    

g1 <- 
  class_table_temp %>%
  filter(!is.na(enriched_tissues)) %>%
  group_by(group_n, enriched_tissues, spec_category, .drop = T) %>%
  summarise(n_genes = n()) %>% 
  ungroup() %>%
  mutate(enriched_tissues = factor(enriched_tissues, plot_order)) %>%
  ggplot(aes(n_genes, enriched_tissues, fill = spec_category, group = group_n)) +
  geom_col(width = 0.8, size = 0.1) +
  simple_theme +
  scale_fill_manual(values = gene_category_pal, name = "Specificity") +
  
  xlab("Number of genes") +
  # scale_y_continuous(position = "bottom", expand = c(0,0)) + 
  
  theme(axis.text.y = element_text(hjust = 0.5), 
        
        axis.title.y = element_blank(),
        panel.border = element_blank()) + 
  transition_states(group_n,
                    transition_length = 1,
                    state_length = 0) +
 ease_aes('linear')
  
g1_anim <- animate(g1, nframes = 100)
save_animation(g1_anim, savepath("group enriched genes per cell type.gif"))
```


```{r experimental_class, echo=FALSE, message=FALSE, warning=FALSE}

experimental_cell_type_class <- 
  annotated_norm_count_clean %>% 
  mutate(sample_id = paste(cell_type_name, cluster_id, tissue_id)) %>%
  hpa_gene_classification_multi_sample(expression_col = "norm_count", 
                                       tissue_col = "cell_type_name", 
                                       sample_col = "sample_id",
                                       gene_col = "ensg_id", 
                                       enr_fold = 4, 
                                       max_group_n = 6, 
                                       det_lim = 1)

experimental_cell_type_class %>% View
  table()

cell_type_class$spec_category %>% 
  table()

```


##Gene Pearson correlation

```{r}

if(file.exists("data/processed/gene_pearson_high.Rdata")) {
  load("data/processed/gene_pearson_high.Rdata")
} else {
  gene_pearson <- 
    annotated_norm_count_wide_id %>%
    {log10(. + 1)} %>%
    cor(method = "pearson")
  
  gene_pearson_high <- 
    gene_pearson %>% 
    as_tibble(rownames = "ensg_id1") %>% 
    gather(ensg_id2, cor, -1) %>% 
    filter(cor > 0.9,
           ensg_id1 < ensg_id2)
  
  save(gene_pearson_high,
       file = "data/processed/gene_pearson_high.Rdata")
  
}

  
gene_pearson_net <- 
  gene_pearson_high %>% 
  as_tbl_graph() %>%
  left_join(components(.)$membership %>%
              enframe("name", "component")) %>%
  left_join(gene_info92 %>%
              select(ensg_id, gene_name),
            by = c("name" = "ensg_id")) %>%
  
  group_by(component) %>%
  mutate(component_n = n_distinct(name)) %>%
  ungroup() %>%
  filter(component_n >= 10) %>%
  arrange(component_n) %>%
  mutate(component = unclass(factor(component))) 
  
gene_pearson_net %>% 
  as_tibble() %>%
  select(component, component_n) %>%
  distinct() %>%
  ggplot(aes(as_factor(component), component_n)) +
  geom_col()

library("enrichR")
gene_pearson_net_enrichr <-
  gene_pearson_net %>%
  as_tibble() %>%
  select(name,
         gene_name,
         component) %>% 
  distinct() %>%
  group_by(component) %>% 
  
  do({
    enrichr(.$gene_name,
            databases = c("GO_Biological_Process_2018")) %>%
      bind_rows(.id = "database")
  }) %>%
  as_tibble()



g <-
  annotated_norm_count %>% 
  # filter(tissue == "colon2") %>%
  # inner_join(gene_prop_net %>% 
  #              as_tibble() %>% 
  #              filter(component == 7),
  #                        by = c("ensg_id" = "name"))
  ggplot(aes(paste(tissue, cluster_id, cell_type_name),norm_count, fill = group_name)) +
  geom_boxplot(outlier.color = NA) +
  geom_line(data = . %>% 
              inner_join(gene_prop_net %>% 
                           as_tibble() %>% 
                           filter(component == 7) ,
                         by = c("ensg_id" = "name")),
            aes(group = ensg_id),
            alpha = 0.4) +
  scale_fill_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ggtitle("PTPM") +
  
  annotated_tmm %>% 
  # filter(tissue == "colon2") %>%
  # inner_join(gene_prop_net %>% 
  #              as_tibble() %>% 
  #              filter(component == 7),
  #                        by = c("ensg_id" = "name"))
  ggplot(aes(paste(tissue, cluster_id, cell_type_name),tmm, fill = group_name)) +
  geom_boxplot(outlier.color = NA) +
  geom_line(data = . %>% 
              inner_join(gene_prop_net %>% 
                           as_tibble() %>% 
                           filter(component == 7) ,
                         by = c("ensg_id" = "name")),
            aes(group = ensg_id),
            alpha = 0.4) +
  scale_fill_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ggtitle("TMM") +
  plot_layout(ncol = 1)

ggsave(savepath("Data distribution normalization.pdf"), plot = g, width = 24, height = 16)



annotated_tmm %>% 
  inner_join(gene_prop_net %>% 
               as_tibble() %>% 
               filter(component == 7),
             by = c("ensg_id" = "name")) %>%
  mutate(id = paste(tissue, cluster_id, cell_type_name)) %>%
  group_by(id) %>% 
  mutate(median_tmm = median(tmm)) %>% 
  ungroup() %>% 
  arrange(median_tmm) %>%
  mutate(id = factor(id, unique(id))) %>%
  ggplot(aes(id, tmm)) +
  geom_line(aes(group = ensg_id),
            alpha = 0.4) +
  geom_point(data = . %>% 
               select(id, group_name, median_tmm) %>% 
               distinct(),
             aes(y = median_tmm, 
                 color = group_name)) +
  scale_color_manual(values = cell_group_palette) +
  scale_y_log10() +
  stripped_theme+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) 

plots <-
  lapply((1:25)[-4],
         function(i) {


           annotated_tmm %>%
             # filter(tissue == "colon2") %>%
             # inner_join(gene_prop_net %>%
             #              as_tibble() %>%
             #              filter(component == 7),
             #                        by = c("ensg_id" = "name"))
             ggplot(aes(paste(tissue, cluster_id, cell_type_name),tmm, fill = group_name)) +
             geom_boxplot(outlier.color = NA) +
             geom_line(data = . %>%
                         inner_join(gene_pearson_net %>%
                                      as_tibble() %>%
                                      filter(component == i) ,
                                    by = c("ensg_id" = "name")),
                       aes(group = ensg_id),
                       alpha = 0.4) +
             scale_fill_manual(values = cell_group_palette) +
             scale_y_log10() +
             stripped_theme+
             theme(axis.text.x = element_text(angle = 60, hjust = 1))


         })

pdf(savepath("tmm distribution i.pdf"), width = 24, height = 8)
plots
dev.off()
```


## PCA & UMAP

### Data

```{r}

ensg_sd <-
  annotated_norm_count_clean_wide %>%
  column_to_rownames("id") %>%
  apply(MARGIN = 2, sd) %>% 
  enframe("ensg_id", "sd") %>%
  filter(sd > 0)


PCA_data <-
  annotated_norm_count_clean_wide %>% 
  select(1, ensg_sd$ensg_id) %>%
  column_to_rownames("id") %>%
  {. + 1} %>%
  compositions::clr() %>%
  as.data.frame()
  # {log10(. + 1)} %>%
  # scale(scale = sqrt(ensg_sd$sd), center = T)
  

  

# 
# mixed_samples <- 
#   cluster_id_map %>% 
#   filter(mixed_cell_types == 1) %>% 
#   pull(id)
# 
# PCA_data_nomix <-
#   annotated_norm_count_wide %>% 
#   filter(!id %in% mixed_samples) %>%
#   column_to_rownames("id") %>%
#   {. + 1} %>%
#   compositions::clr() %>%
#   as.data.frame()
  # {log10(. + 1)}

```


### PCA

```{r}

annotated_clusters_pca <- 
  pca_calc(PCA_data, 200)


annotated_clusters_pca$scores %>% 
  as_tibble(rownames = "id") %>% 
  left_join(cluster_id_map) %>% 
  ggplot(aes(PC1, PC2, color = cell_type_name, shape = as.factor(mixed_cell_types))) + 
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            size = 2, 
            alpha = 0.4) +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme
ggsave(savepath("PCA annotated clusters.pdf"), width = 14, height = 6)


# Transform un-annotated clusters:
unannotated_PCA_data <- 
  cluster_norm_count %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") %>%
  {log10(. + 1)} %>%
  scale(scale = sqrt(ensg_sd$sd), center = T)
 


unannotated_PCA_transormed <- 
  pca_transform(unannotated_PCA_data, annotated_clusters_pca$loadings)

 

unannotated_PCA_transormed %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map, 
            by = "id") %>% 
  ggplot(aes(PC1, PC2, color = cell_type_name)) + 
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
  geom_point(size = 5, 
             alpha = 0.7) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            size = 2, 
            alpha = 0.4) +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme
ggsave(savepath("PCA all clusters.pdf"), width = 14, height = 6)



```

### PCA Distance

```{r}

PCA_coords <- 
  annotated_clusters_pca %$%
  scores[,1:pc_95]

PCA_centers <- 
  PCA_coords %>% 
  as_tibble(rownames = "id") %>% 
  gather(PC, score, -1) %>% 
  left_join(cluster_id_map %>% 
              select(id, cell_type_name),
            by = c("id")) %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  group_by(cell_type_name, PC) %>%
  summarise(score = mean(score)) %>% 
  ungroup() %>%
  spread(PC, score) %>%
  mutate(cell_type_name = paste("center", cell_type_name)) %>% 
  rename(id = cell_type_name)

PCA_distances <- 
  bind_rows(PCA_coords %>% 
            as_tibble(rownames = "id"), 
          PCA_centers) %>% 
  column_to_rownames("id") %>% 
  dist(upper = T)


PCA_distances_list <- 
  PCA_distances %>% 
  as.matrix() %>% 
  as_tibble(rownames = "id1") %>% 
  gather(id2, dist, -1) %>%
  filter(id1 != id2) %>%
  mutate(id1_type = case_when(grepl("^center", id1) ~ "center",
                              grepl("^\\d", id1) ~ "cluster"),
         id2_type = case_when(grepl("^center", id2) ~ "center",
                              grepl("^\\d", id2) ~ "cluster"))

PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>%
  group_by(id1)
  
PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  filter(cell_type_name == "T lymphocytes") %>% 
  ggplot(aes(id1, dist )) +
  geom_point()
 

PCA_distances %>%
  as.matrix() %>%
  
# {grep("^\\d", rownames(.))}
# {grep("^center", colnames(.))}
{.[grep("^\\d", rownames(.)), grep("^center", colnames(.))]} %>%
  t() %>%
  pheatmap(clustering_method = "ward.D2")
  

plot_data <- 
  PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  group_by(id1) %>%
  top_n(3, -dist) %>%
  ungroup() %>%
  arrange(cell_type_name, id1) %>%
  mutate(id1 = factor(id1, unique(id1))) %>%
  ungroup() %>%
  filter(correct)

plot_data_2 <-
  plot_data %>%
  group_by(id2) %>%
  mutate(rank = rank(-dist)) %>% 
  filter(rank != 1 | (rank == 1 & dist == 0)) %>%
  group_by(id2) %>%
  summarise(mean_dist = mean(dist[which(correct)]),
            sd_dist = sd(dist[which(correct)])) %>% 
  mutate(mean = mean_dist,
         lower = mean_dist - 2 * sd_dist,
         upper = mean_dist + 2 * sd_dist)

plot_order <- 
  plot_data_2 %>% 
  arrange(mean_dist) %>%
  pull(1)

plot_data3 <-
  plot_data %>%
  
  left_join(plot_data_2, 
            by = "id2") %>%
  mutate(outlier = dist < lower | dist > upper) %>% 
  mutate(id2 = factor(id2, plot_order)) 

plot_data3 %>%
  ggplot(aes(dist, id2, color = id2)) +
  geom_point(size = 2.5, 
             show.legend = F) +
  geom_point(data = . %>% 
               filter(outlier),
             size = 6,
             color = "red", 
             alpha = 0.5,
             show.legend = F) +
  
  geom_segment(data = plot_data_2 %>% 
                 mutate(id2 = factor(id2, plot_order)),
               aes(x = lower, xend = upper, 
                   y = id2, yend = id2),
               show.legend = F) +
  geom_point(data = plot_data_2 %>% 
               mutate(id2 = factor(id2, plot_order)),
             aes(mean, id2), 
             inherit.aes = F, 
             shape = 4, 
             color = "black",
             size = 4,
             show.legend = F) +
  geom_point(size = 2.5,
             show.legend = F) +
  geom_text(data = . %>% 
              filter(outlier),
            aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            show.legend = F) +
  
  scale_color_manual(values = cell_type_palette) +
  
  stripped_theme_facet + 
  theme(panel.grid.major.y = element_line(color = "gray90"))
ggsave(savepath("PCA distance outlier plot.pdf"), width = 15, height = 7)  

PCA_group_distance_outliers <- 
  plot_data3 %>% 
  filter(outlier) %>% 
  pull(id1) %>%
  as.character()

```

```{r}

plot_data <- 
  PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  group_by(id1, correct) %>%
  top_n(1, -dist) %>%
  ungroup() %>%
  select(id1, id2, dist, mixed_cell_types, correct) %>%
  pivot_wider(names_from = correct, values_from = c(dist, id2)) %>%
  mutate(annotation_correct = dist_TRUE < dist_FALSE)


plot_data %>% 
  ggplot(aes(dist_TRUE, dist_FALSE, 
             color = id2_TRUE,
             alpha = annotation_correct, 
             shape = as.factor(mixed_cell_types),
             size = annotation_correct)) +
  geom_point(show.legend = F) +
  geom_abline(slope = 1,
              linetype = "dashed") + 
  geom_text(data = . %>% 
              filter(!annotation_correct),
            aes(dist_TRUE, dist_FALSE, 
                label = str_extract(id1, "^\\d{1,3} \\d{1,3}")),
            size = 2,
            inherit.aes = F) + 
  scale_alpha_manual(values = c("TRUE" = 0.5, "FALSE" = 1)) +
  scale_size_manual(values = c("TRUE" = 2, "FALSE" = 4)) +
  scale_color_manual(values = cell_type_palette, guide = F) +
  ylab("Distance to annotated center") +
  xlab("Distance to other closest center") +
  ggtitle("Comparing likeness to other clusters with same annotation",
          "Clusters under the line are more similar to clusters with other annotation, triangle = mixed cluster") + 
  stripped_theme_facet
ggsave(savepath("PCA annotated distance vs other scatter.pdf"), width = 10, height = 10)    


PCA_annotation_distance_outliers <- 
  plot_data %>% 
  filter(!annotation_correct) %>%
  pull(id1)

```

```{r}



PCA_distances_list %>%
  filter(id1 %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)) %>% 
  filter(id1_type == "cluster" & id2_type == "center") %>% 
  group_by(id1) %>% 
  mutate(mean_dist = mean(dist),
         sd_dist = sd(dist),
         lower = mean_dist - 1.5 * sd_dist,
         outlier = dist < lower, 
         dist_from_mean = mean_dist - dist) %>%
  ungroup() %>% 
  ggplot(aes(dist_from_mean, id1, alpha = outlier)) + 
  geom_point()

PCA_distances_outliers <- 
  PCA_distances_list %>%
  filter(id1 %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)) %>% 
  filter(id1_type == "cluster" & id2_type == "center") %>% 
  group_by(id1) %>% 
  # top_n(5, -dist) %>% 
  arrange(id1, dist) %>%
  ungroup() %>%
  left_join(cluster_id_map,
            c("id1" = "id")) %>%
  select(id = 1, 
         center = 2, 
         distance = 3, 
         tissue_id,
         tissue, 
         cluster_id,
         cell_type_name,
         mixed_cell_types)

PCA_distances_outliers %>% 
  select(1, 2, 3) %>% 
  spread(center, distance) %>% 
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           clustering_method = "ward.D2",
           border_color = NA,
           cutree_rows = 4,
           cutree_cols = 6, 
           annotation_row = cluster_id_map %>% 
             select(id, mixed_cell_types) %>% 
             mutate(mixed_cell_types = as.character(mixed_cell_types)) %>%
             column_to_rownames("id"),
           annotation_colors = list(mixed_cell_types = c("1" = "red", "0" = "white")),
           filename = savepath("Outlier cluster distance to centers.pdf"),
           width = 10,
           height = 8)
  
PCA_distances_outliers %>%
  group_by(id) %>% 
  top_n(3, -distance)  %>%
  write_csv(savepath("top 3 lowest distance per outlier cluster.csv"))

```

####Center distance for unannotated

```{r}

PCA_not_annotated_distances <- 
  bind_rows(unannotated_PCA_transormed[,1:annotated_clusters_pca$pc_95] %>% 
            as_tibble(rownames = "id"), 
          PCA_centers) %>% 
  column_to_rownames("id") %>% 
  dist(upper = T)

PCA_not_annotated_distances_list <- 
  PCA_not_annotated_distances %>% 
  as.matrix() %>% 
  as_tibble(rownames = "id1") %>% 
  gather(id2, dist, -1) %>%
  filter(id1 != id2) %>%
  mutate(id1_type = case_when(grepl("^center", id1) ~ "center",
                              grepl("^\\d", id1) ~ "cluster"),
         id2_type = case_when(grepl("^center", id2) ~ "center",
                              grepl("^\\d", id2) ~ "cluster"))


PCA_not_annotated_distances_list %>%
  filter(id1_type == "cluster" & id2_type == "center") %>%
  rename(id = id1, center = id2) %>%
  left_join(cluster_annotation %>%
              mutate(id = paste(tissue_id, cluster_id)) %>%
              select(id, tissue_id, cluster_id, tissue_name, cell_type_name, mixed_cell_types, reliability),
            by = "id") %>%
  filter(is.na(cell_type_name)) %>% 
  group_by(id) %>%
  top_n(3, -dist) %>% 
  ungroup() %>%
  separate(id, into = c("tissue_id", "cluster_id"), remove = F, sep = " ") %>%
  left_join(cluster_annotation %>% 
              select(tissue_id, tissue_name) %>% 
              unique() %>%
              mutate(tissue_id = as.character(tissue_id)),
            by = "tissue_id") %>%
  arrange(id) %>% 
  select(1:4, 
         distance = dist, 
         tissue_name = tissue_name.y) %>%
  write_csv(savepath("Nearest centers for unannotated cluster.csv"))

```


###UMAP

```{r}

annotated_clusters_umap <- 
  umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

annotated_clusters_umap_nomix <- 
  umap_calc(PCA_data_nomix, npcs = 2, n_neighbors = 30)

g1 <-
  annotated_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2),
         is_mixed = ifelse(mixed_cell_types == 1, "yes", "no")) %>% 
  ggplot(aes(V1, V2, color = cell_type_name, shape = is_mixed)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
  # stat_density_2d(data = . %>%
  #                  group_by(celltype) %>% 
  #                  mutate(n = n()) %>% 
  #                  ungroup() %>% 
  #                  filter(n > 1) %>% 
  #                  filter(celltype != "Unknown"),
  #                geom = "polygon", 
  #                aes(V1, V2, 
  #                    fill = celltype,
  #                    alpha = as.factor(..level..)),
  #                inherit.aes = F,
#                bins = 20, 
#                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")

# no mix
g2 <- 
  annotated_clusters_umap_nomix$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "No mixed clusters")

g1 + g2
ggsave(savepath("Annotated clusters UMAP.pdf"), width = 20, height = 12)




tibble(id = c(PCA_annotation_distance_outliers,
             as.character(PCA_group_distance_outliers))) %>% 
  unique() %>%
  mutate(type = case_when(id %in% PCA_annotation_distance_outliers & 
                            id %in% as.character(PCA_group_distance_outliers) ~ "Overlap",
                          id %in% PCA_annotation_distance_outliers ~ "Distance",
                          id %in% as.character(PCA_group_distance_outliers) ~ "Group")) %>%
  group_by(type) %>% 
  summarise(n = n())
  ggplot(aes())
       
```

####UMAP un-annotated clusters

```{r}
PCA_data_2 <- 
  cluster_norm_count %>% 
  filter(tissue %in% main_datasets$dataset) %>%
  left_join(cluster_annotation) %>% 
  mutate(id = paste(tissue_id, cluster_id)) %>%
  select(ensg_id, id, norm_count) %>% 
  spread(ensg_id, norm_count) %>% 
  select(1, unique(cell_markers$ensg_id)) %>%
  column_to_rownames("id") %>%
  {. + 1} %>%
  compositions::clr() %>%
  as.data.frame()
  # {log10(. + 1)} %>%

all_clusters_umap <- 
  umap_calc(PCA_data_2, npcs = 2, n_neighbors = 30)

g1 <-
  all_clusters_umap$layout %>% 
  as_tibble(rownames = "id") %>% 
  separate(id, into = c("tissue_id", "cluster_id"), convert = T) %>%
  left_join(cluster_annotation ) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2),
         is_mixed = ifelse(mixed_cell_types == 1, "yes", "no")) %>% 
  ggplot(aes(V1, V2, color = cell_type_name, shape = is_mixed)) + 
  geom_point(data = . %>% 
               filter(is.na(cell_type_name)), 
             aes(V1, V2),
             size = 7, 
             color = "red",
             alpha = 0.7,
             show.legend = F, 
             inherit.aes = F) + 
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("UMAP", "Not annotated clusters marked")

g1

ggsave(savepath("marker UMAP unannotated clusters marked.pdf"), width = 30, height = 30)

new_rowname <- 
  PCA_data_2 %>%
  rownames() %>% 
  enframe("i", "id") %>% 
  separate(id, into = c("tissue_id", "cluster_id"), convert = T) %>%
  left_join(cluster_annotation ) %>% 
  mutate(new_name = paste( tissue_id, cluster_id, tissue_name, cluster_id, cell_type_name)) %>% 
  pull(new_name)

new_colname <- 
  PCA_data_2 %>%
  colnames() %>% 
  enframe("i", "ensg_id") %>%
  left_join(gene_info92) %>% 
  pull(gene_name)

heatmap_meta <-
  PCA_data_2 %>%
  rownames() %>% 
  enframe("i", "id") %>% 
  separate(id, into = c("tissue_id", "cluster_id"), convert = T) %>%
  left_join(cluster_annotation ) %>%
  mutate(new_name = paste( tissue_id, cluster_id, tissue_name, cluster_id, cell_type_name),
         annotated = as.character(!is.na(cell_type_name))) %>% 
  select(new_name, annotated) %>% 
  column_to_rownames("new_name")

PCA_data_2 %>% 
  set_rownames(new_rowname) %>% 
  set_colnames(new_colname) %>% 
  pheatmap(clustering_method = "ward.D2", 
           annotation_row = heatmap_meta,
           filename = savepath("marker heatmap unannotated clusters marked.pdf"),
           width = 30,
           height = 20)
```


####Only markers
```{r}


annotated_clusters_umap_only_markers <-
  PCA_data %>% 
  {.[, which(colnames(.) %in% cell_markers$ensg_id)]} %>% 
  umap_calc(npcs = 2, n_neighbors = 30)


g1 <-
  annotated_clusters_umap_only_markers$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2),
         is_mixed = ifelse(mixed_cell_types == 1, "yes", "no")) %>% 
  ggplot(aes(V1, V2, color = cell_type_name, shape = is_mixed)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 5) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 2, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            size = 1.5,
            alpha = 0.3) +
  # geom_text(data = . %>%
  #             select(mean_V1, mean_V2, cell_type_name) %>% 
  #             unique(),
  #           aes(x = mean_V1, y = mean_V2, label = cell_type_name),
  #           inherit.aes = F, 
  #           alpha = 0.6,
  #           fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")

ggsave(savepath("UMAP only markers - all annotated.pdf"), plot = g1, width = 15, height = 15)



```


###PLSDA

```{r}

PLS_data <- 
  annotated_norm_count_clean_wide %>% 
  select(1, ensg_sd$ensg_id) %>%
  column_to_rownames("id") %>%
  {. + 1}
  # {log10(. + 1)} %>%
  # scale(scale = sqrt(ensg_sd$sd), center = T)
  


X <- PLS_data[which(!rownames(PCA_data) %in% PCA_distances_outliers$id),] #annotated_clusters_pca$scores 

Y <-
  X %>% 
  rownames() %>% #rownames(annotated_clusters_pca$scores) %>%  
  enframe("row", "id") %>% 
  left_join(cluster_id_map,
            by = "id") %>%
  pull(cell_type_name)

SPLSDA_annotated <- splsda(X, Y, ncomp = 100, logratio = "CLR")

plotIndiv(SPLSDA_annotated)


SPLSDA_expvar <- 
  SPLSDA_annotated$explained_variance$X %>%
  enframe("comp", "exp_var") %>% 
  mutate(cum_var = cumsum(exp_var),
         comp = factor(comp, comp),
         comp_n = as.numeric(gsub("comp ", "", comp)))

expvar_comp_lim <-
  SPLSDA_expvar %>% 
  filter(cum_var >= 0.95) %>% 
  head(1)


SPLSDA_expvar %>%
  gather(metric, exp_var, -comp, -comp_n) %>% 
  
  ggplot(aes(comp_n, exp_var, color = metric)) +
  geom_line() +
  geom_vline(xintercept = expvar_comp_lim$comp_n)





# annotated_clusters_umap <- 
  # umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

 
# No mix, annotated cells
SPLSDA_annotated$variates$X %>%
  as_tibble(rownames = "id") %>%
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3,
            size = 1.5) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 3,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA")

ggsave(savepath("Annotated clusters SPLSDA.pdf"), width = 12, height = 12)

# Also non-annotated cells

PLS_data_not_annotated <- 
  cluster_norm_count %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") 

X %>% 
  logratio.transfo(logratio = "CLR") %>%
  scale()
  
PLS_data_not_annotated_scaled <- 
  PLS_data_not_annotated %>%
  {(. + 1)} %>%
  
  compositions::clr() %>%
  scale(scale = apply(., MARGIN = 2, function(x) (sd(x))), center = T) 
###

 # meanX = colMeans(temp, na.rm = TRUE)
 #  if (scale) {
 #    sqrt.sdX = colSds(temp, na.rm = TRUE)
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #    data.list.study.scale_i = data.list.study.scale_i/rep(1, 
 #      nrow(temp)) %*% t(sqrt.sdX)
 #    ind = which(sqrt.sdX == 0)
 #    if (length(ind) > 0) 
 #      data.list.study.scale_i[, ind] = 0
 #  }
 #  else {
 #    sqrt.sdX = NULL
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #  }
 #  out = list(data_scale = data.list.study.scale_i, meanX = meanX, 
 #    sqrt.sdX = sqrt.sdX)
 #  return(out)

###


dim(PLS_data_not_annotated_scaled)
dim(SPLSDA_annotated$loadings$X)

SPLSDA_not_anno_transformed <- 
  pca_transform(PLS_data_not_annotated_scaled,
                SPLSDA_annotated$loadings$X)

left_join(SPLSDA_annotated$variates$X %>% 
            as_tibble(rownames = "id") %>%
            mutate(id = str_extract(id, "^\\d{1,3} \\d{1,3}")) %>%
            select(1:2),
          SPLSDA_not_anno_transformed %>%
            as_tibble(rownames = "id") %>% 
            select(1:2),
          by = "id") %>% 
  ggplot(aes(comp1.x, comp1.y)) +
  geom_point() +
  geom_abline(slope = 1)

g <-
  SPLSDA_not_anno_transformed %>%
  as_tibble(rownames = "id") %>%
  left_join(all_clusters_map,
            by = "id") %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F,
             alpha = 0.3,
             size = 1) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 2,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA")

ggsave(savepath("All clusters SPLSDA.pdf"), plot = g, width = 12, height = 12)

g + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3, 
            size = 1.5)

ggsave(savepath("All clusters SPLSDA with text.pdf"), plot = g, width = 12, height = 12)
```

```{r}


SPLSDA_UMAP <- 
  umap_calc(SPLSDA_not_anno_transformed, npcs = 2, n_neighbors = 30)

SPLSDA_UMAP$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
  # stat_density_2d(data = . %>%
  #                  group_by(celltype) %>% 
  #                  mutate(n = n()) %>% 
  #                  ungroup() %>% 
  #                  filter(n > 1) %>% 
  #                  filter(celltype != "Unknown"),
  #                geom = "polygon", 
  #                aes(V1, V2, 
  #                    fill = celltype,
  #                    alpha = as.factor(..level..)),
  #                inherit.aes = F,
#                bins = 20, 
#                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")
```

#### PLSDA only markers


```{r}

PLS_data <- 
  annotated_norm_count_clean_wide %>% 
  select(1, ensg_sd$ensg_id) %>%
  select(1, unique(cell_markers$ensg_id)) %>%
  column_to_rownames("id") %>%
  {. + 1}
  # {log10(. + 1)} %>%
  # scale(scale = T, center = T)
  # scale(scale = sqrt(ensg_sd$sd), center = T)
  
PLS_data %>% 
  as_tibble() %>%
  visdat::vis_miss()

X <- PLS_data[which(!rownames(PCA_data) %in% PCA_distances_outliers$id),] #annotated_clusters_pca$scores 

Y <-
  X %>% 
  rownames() %>% #rownames(annotated_clusters_pca$scores) %>%  
  enframe("row", "id") %>% 
  left_join(cluster_id_map,
            by = "id") %>%
  pull(cell_type_name)

SPLSDA_annotated <- splsda(X, Y, ncomp = 100, logratio = "CLR")

plotIndiv(SPLSDA_annotated)


SPLSDA_expvar <- 
  SPLSDA_annotated$explained_variance$X %>%
  enframe("comp", "exp_var") %>% 
  mutate(cum_var = cumsum(exp_var),
         comp = factor(comp, comp),
         comp_n = as.numeric(gsub("comp ", "", comp)))

expvar_comp_lim <-
  SPLSDA_expvar %>% 
  filter(cum_var >= 0.95) %>% 
  head(1)


SPLSDA_expvar %>%
  gather(metric, exp_var, -comp, -comp_n) %>% 
  
  ggplot(aes(comp_n, exp_var, color = metric)) +
  geom_line() +
  geom_vline(xintercept = expvar_comp_lim$comp_n)





# annotated_clusters_umap <- 
  # umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

 
# No mix, annotated cells
SPLSDA_annotated$variates$X %>%
  as_tibble(rownames = "id") %>%
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3,
            size = 1.5) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 3,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of annotated clusters", "Supervised clustering using markers only")

ggsave(savepath("Annotated clusters SPLSDA only markers.pdf"), width = 12, height = 12)

# Also non-annotated cells

PLS_data_not_annotated <- 
  cluster_norm_count %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  filter(ensg_id %in% unique(cell_markers$ensg_id)) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") %>%
  {.[, rownames(SPLSDA_annotated$loadings$X)]}

X %>% 
  logratio.transfo(logratio = "CLR") %>%
  scale()
  
PLS_data_not_annotated_scaled <- 
  PLS_data_not_annotated %>%
  {(. + 1)} %>%
  
  compositions::clr() %>%
  scale(scale = apply(., MARGIN = 2, function(x) (sd(x))), center = T) 
###

 # meanX = colMeans(temp, na.rm = TRUE)
 #  if (scale) {
 #    sqrt.sdX = colSds(temp, na.rm = TRUE)
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #    data.list.study.scale_i = data.list.study.scale_i/rep(1, 
 #      nrow(temp)) %*% t(sqrt.sdX)
 #    ind = which(sqrt.sdX == 0)
 #    if (length(ind) > 0) 
 #      data.list.study.scale_i[, ind] = 0
 #  }
 #  else {
 #    sqrt.sdX = NULL
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #  }
 #  out = list(data_scale = data.list.study.scale_i, meanX = meanX, 
 #    sqrt.sdX = sqrt.sdX)
 #  return(out)

###


dim(PLS_data_not_annotated_scaled)
dim(SPLSDA_annotated$loadings$X)

SPLSDA_not_anno_transformed <- 
  pca_transform(PLS_data_not_annotated_scaled,
                SPLSDA_annotated$loadings$X)

left_join(SPLSDA_annotated$variates$X %>% 
            as_tibble(rownames = "id") %>%
            mutate(id = str_extract(id, "^\\d{1,3} \\d{1,3}")) %>%
            select(1:2),
          SPLSDA_not_anno_transformed %>%
            as_tibble(rownames = "id") %>% 
            select(1:2),
          by = "id") %>% 
  ggplot(aes(comp1.x, comp1.y)) +
  geom_point() +
  geom_abline(slope = 1)

g <-
  SPLSDA_not_anno_transformed %>%
  as_tibble(rownames = "id") %>%
  left_join(all_clusters_map,
            by = "id") %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F,
             alpha = 0.3,
             size = 1) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 2,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of all clusters - not annotated in gray", "Supervised clustering using markers only")

ggsave(savepath("All clusters SPLSDA only markers.pdf"), plot = g, width = 12, height = 12)

g + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3, 
            size = 1.5)

ggsave(savepath("All clusters SPLSDA only markers with text.pdf"), width = 12, height = 12)
```

```{r}


SPLSDA_UMAP <- 
  umap_calc(SPLSDA_not_anno_transformed, npcs = 2, n_neighbors = 30)

SPLSDA_UMAP$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
  # stat_density_2d(data = . %>%
  #                  group_by(celltype) %>% 
  #                  mutate(n = n()) %>% 
  #                  ungroup() %>% 
  #                  filter(n > 1) %>% 
  #                  filter(celltype != "Unknown"),
  #                geom = "polygon", 
  #                aes(V1, V2, 
  #                    fill = celltype,
  #                    alpha = as.factor(..level..)),
  #                inherit.aes = F,
#                bins = 20, 
#                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")
```








#Machine learning for annotation

```{r}

untrusted_annotations <- 
  c("88 10", "88 8", "83 15", "86 10", "91 4", "108 11", "103 12", "104 3", "104 7", "104 8", "91 9", "91 5", "104 11", "105 8", "87 7", "87 9")

annotation_ML_data <- 
  cluster_norm_count %>%
  filter(ensg_id %in% cell_markers$ensg_id) %>%
  mutate(tissue_id = as.character(tissue_id),
         norm_count = ifelse(norm_count < 1, 0, norm_count)) %>%
  left_join(dataset_map,
            by = c("tissue" = "dataset", "tissue_id")) %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  left_join(cluster_annotation %>% 
              mutate(tissue_id = as.character(tissue_id)) %>%
              select(tissue_id, cluster_id, 
                     annotated_cell_type = cell_type_name,
                     mixed_cell_types,
                     reliability),
            by = c("tissue_id", "cluster_id")) %>%
  # filter(mixed_cell_types == 0) %>%
  filter(!is.na(annotated_cell_type)) %>%
  filter(annotated_cell_type != "Inflammatory cells") %>% 
  filter(cell_type_name != "Immune cells") 

X_Y <-
  annotation_ML_data %>%
  # mutate(id = paste0("c", gsub(" ", "_", id))) %>%
  select(ensg_id, id, Y = annotated_cell_type, norm_count) %>%
  spread(ensg_id, norm_count)

X <- 
  X_Y %>%
  select(-Y) %>% 
  column_to_rownames("id")

X_scaled <- 
  X %>% 
  {. + 1} %>%
  compositions::clr() %>%
  as.data.frame()#%>%
  # scale(scale = apply(., MARGIN = 2, function(x) sqrt(sd(x))), center = T) 
  
  
random_ids <-
  
  {set.seed(42);stringi::stri_rand_strings(100, 5, '[A-Z]')} %>%
  unique()

Y_map <- 
  X_Y %>%
  select(Y, id) %>%
  mutate(class_id = random_ids[unclass(factor(Y))])

Y_map_sum <- 
  Y_map %>% 
  select(Y, class_id) %>%
  distinct()

Y <-
  Y_map %$% 
  set_names(class_id, id)

dim(X_scaled)[1] == length(Y)
#

if(file.exists("data/processed/annotation_model.Rdata")) {
  load("data/processed/annotation_model.Rdata")
} else {
  cl <- makePSOCKcluster(6)
  registerDoParallel(cl)
  annotation_model <- 
    train(x = X_scaled,
          y = Y,
          method = "pls",
          trControl = trainControl(method = "repeatedcv",
                                   number = 4,
                                   repeats = 100,
                                   classProbs  = T,
                                   allowParallel = T,
                                   returnResamp = "all",
                                   savePredictions = T,
                                   summaryFunction = defaultSummary),
          tuneGrid = expand.grid(ncomp = c(4:10) * 10),
          
          metric = "Accuracy")
  stopCluster(cl)
  save(annotation_model,
       file = "data/processed/annotation_model.Rdata")
  
}

```

##Plots and metrics

### Misclassifications

```{r}

annotation_model_predictions <-
  annotation_model$pred %>% 
  as_tibble() %>% 
  filter(ncomp == annotation_model$bestTune$ncomp) %>%

  gather(obs_pred, prob, -(1:3), -ncomp, -Resample) %>%
  mutate(pred = Y_map_sum$Y[match(pred, Y_map_sum$class_id)],
         obs = Y_map_sum$Y[match(obs, Y_map_sum$class_id)],
         obs_pred = Y_map_sum$Y[match(obs_pred, Y_map_sum$class_id)]) %>%
  arrange(Resample, rowIndex, -prob) %>%
  left_join(names(Y) %>% enframe("rowIndex", "id"))

annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>%
  group_by(id, correct) %>% 
  summarise(n = n()) 



##### Total prediction rate
plot_data <- 
  annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>%
  group_by(obs, correct, .drop = F) %>% 
  summarise(n = n()) %>%
  mutate(n_sum = sum(n),
         fract = n / n_sum) %>%
  ungroup() 
  
plot_order <- 
  plot_data %>%
  select(., obs, correct, fract) %>%
  spread(correct, fract, fill = 0) %>% 
  mutate(rate = `TRUE` / `FALSE`) %$%
  obs[order(rate)]
  
plot_data %>% 
  mutate(obs = factor(obs, levels = plot_order)) %>% 
  ggplot(aes(fract, obs, fill = correct)) +
  geom_col() + 
  scale_fill_manual(values = c("FALSE" = "orangered", "TRUE" = "lightgray")) +
  xlab("Fraction of correct classification") +
  theme_minimal() +
  theme(legend.position = "top",
        axis.title.y = element_blank()) +
  
  cluster_annotation$cell_type_name %>% 
  table() %>%
  enframe("cell_type", "n_clusters") %>% 
  mutate(cell_type = factor(cell_type, levels = plot_order)) %>% 
  filter(complete.cases(.)) %>%
  ggplot(aes(n_clusters, cell_type)) +
  geom_col() +
  xlab("Number of clusters") +
  theme_minimal() +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank())
ggsave(savepath("PLS model misclassification rate per cell type.pdf"), width = 10, height = 6)

annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>% 
  group_by(pred, obs) %>% 
  summarise(n = n()) %>%
  ggplot(aes(n, obs, fill = pred)) +
  geom_col() + 
  scale_fill_manual(values = cell_type_palette)

annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>% 
  group_by(obs, pred) %>% 
  summarise(n = n()) %>%
  mutate(sum_n = sum(n),
         fract = n / sum_n, 
         from = paste("obs", obs),
         to = paste("pred", pred)) %$%
  chord_with_title(from = from, 
                   to = to, 
                   sizes = fract, 
                   grid.col = cell_type_palette, 
                   groups = c(rep(1, n_distinct(from)),
                              rep(2, n_distinct(to))),
                   plot.order =  c(sort(unique(from), decreasing = T), sort(unique(to))), 
                   titles = c("Observed", "Predicted"), 
                   from_labels = obs, 
                   to_labels = pred, gap_adj = 1, label_style = "vertical")

annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>% 
  group_by(obs, pred) %>% 
  summarise(n = n()) %>%
  mutate(sum_n = sum(n),
         fract = n / sum_n, 
         from = paste("obs", obs),
         to = paste("pred", pred)) %>%
  multi_alluvial_plot(vars = )

#### Prediction rate per cluster
annotation_model_predictions_per_cluster <- 
  annotation_model_predictions %>% 
  select(Resample, pred, obs, rowIndex, id) %>% 
  distinct() %>% 
  mutate(correct = pred == obs) %>%
  group_by(rowIndex, id, obs, pred, correct, .drop = F) %>% 
  summarise(n = n()) %>%
  group_by(rowIndex, id, obs) %>%
  mutate(n_sum = sum(n),
         fract = n / n_sum,
         correct_fract = ifelse(!any(correct),
                                0, 
                                fract[which(correct)]))%>%
  ungroup() 

correct_annotations <-
  annotation_model_predictions_per_cluster %>% 
  filter(correct) %>% 
  filter(fract > 0.7)

annotation_model_predictions_per_cluster %>% 
  select(id, correct_fract) %>% 
  distinct() %>% 
  mutate(pass = correct_fract > 0.8) %>% 
  group_by(pass) %>% 
  summarise(n = n()) %>% 
  mutate(fract = n / sum(n))

annotation_model_predictions_per_cluster %>% 
  select(id, correct_fract) %>% 
  distinct() %>% 
  ggplot(aes(correct_fract)) +
  geom_histogram() +
  theme_minimal() +
  xlab("Frequency of same annotation")
ggsave(savepath("PLS model freq correct cluster annotation.pdf"), width = 5, height = 5)

annotation_model_wrong_annotation_res <- 
  annotation_model_predictions_per_cluster %>% 
  filter(!id %in% correct_annotations$id) %>%
  filter(!correct) %>%
  separate(id, into = c("tissue_id", "cluster_id")) %>% 
  left_join(dataset_map) %>% 
  left_join(cluster_annotation %>% 
              mutate(cluster_id = as.character(cluster_id)), 
            by = c("cluster_id", "dataset" = "tissue_name")) %>% 
  select(dataset, cluster_id, 
         annotation = obs, 
         contradicting_annotation = pred,
         annotation_frequency = fract,
         correct_annotation_frequency = correct_fract,
         other_cell_types,
         mixed_cell_types,
         reliability,
         internal_comment) %>%
  arrange(dataset, -as.numeric(cluster_id), -annotation_frequency) 



annotation_model_wrong_annotation_res %>% 
  
  write_csv(savepath("contradictory cluster annotations.csv"))
  
g <- 
  annotation_model_wrong_annotation_res %>% 
  mutate(id = factor(paste(cluster_id, annotation), levels = {select(., cluster_id, annotation) %>%
      distinct() %>% 
      arrange(-as.numeric(cluster_id)) %$%
      paste(cluster_id, annotation)})) %>%
  # filter(dataset %in% c("testis", "colon", "breast")) %>%
  ggplot(aes(annotation_frequency, id, 
             fill = contradicting_annotation, label = contradicting_annotation)) + 
  geom_col(show.legend = F, color = "white") +
  geom_text_repel(position = position_stack(vjust = .5), direction = "x",
                  size = 2) +
  facet_grid(dataset ~ ., scales = "free_y", space = "free") +
  scale_fill_manual(values = cell_type_palette) +
  stripped_theme_facet +
  theme(strip.text.y = element_text(angle = 0))
ggsave(savepath("contradictory cluster annotations.pdf"), plot = g, width = 12, height = 24)

annotation_model_wrong_annotation_res %>% 
  select(1:2) %>% 
  distinct() %>% 
  left_join(cluster_annotation %>% 
              mutate(cluster_id = as.character(cluster_id)), 
            by = c("cluster_id", "dataset" = "tissue_name")) %>% 
  ggplot(aes(mixed_cell_types)) +
  geom_bar()
```

### Variable importance

```{r ML_plots_varimp}

annotation_model_varimp <- 
  varImp(annotation_model$finalModel) %>%
  as_tibble(rownames = "ensg_id") %>% 
  gather(class_id, importance, -1) %>% 
  left_join(Y_map_sum) %>%
  left_join(gene_info92 %>% 
              select(ensg_id, gene_name)) 


annotation_model_varimp %>% 
  group_by(Y) %>% 
  top_n(5, importance) %>%
  ungroup() %>%
  left_join(cell_markers %>% 
              select(cell_type, 
                     ensg_id) %>% 
              distinct()) %>%
  ggplot(aes(importance, Y, label = gene_name, color = cell_type)) +
  geom_text() +
  scale_color_manual(values = cell_type_palette)

annotation_model_varimp %>%
  group_by(Y) %>% 
  top_n(20, importance) %>%
  ungroup() %>%
  left_join(cell_markers %>%
              select(ensg_id, gene_name, cell_type)) %>%
  ggplot(aes(importance, Y, fill = cell_type)) +
  geom_col(show.legend = F) + 
  scale_fill_manual(values = cell_type_palette)

# Loadings
annotation_model_varimp %>% 
  filter(Y == "Natural killer cells") %>% 
  arrange(-importance)


annotated_mean_count <- 
  annotated_norm_count %>% 
  group_by(ensg_id, cell_type_name) %>% 
  summarise(norm_count = mean(norm_count)) %>% 
  group_by(ensg_id) %>% 
  mutate(mean_count = mean(norm_count)) %>% 
  ungroup() %>% 
  mutate(relative_exp = norm_count / mean_count)

g <- 
  annotation_model_varimp %>% 
  # filter(Y == "Natural killer cells") %>% 
  arrange(-importance) %>%
  left_join(annotated_mean_count,
            by = c("ensg_id", "Y" = "cell_type_name")) %>% 
  ggplot(aes(relative_exp, importance, label = gene_name)) +
  # geom_point() + 
  geom_text(size = 0.8) +
  
  facet_wrap(~Y, scales = "free") +
  
  scale_x_log10() +
  theme_minimal()

ggsave(savepath("PLS model variance importance scatter.pdf"), plot = g, width = 20, height = 20)

annotation_model$finalModel %>%
  pls::loadings() %>% {.[]} %>%
  as.matrix() %>%
  as_tibble(rownames = "ensg_id") %>%
  column_to_rownames("ensg_id") %>%
  pheatmap(clustering_method = "ward.D2", 
           cluster_cols = F)


#####
annotation_model_varimp

require(pROC)
pROC::auc()
pROC_obj <- roc(df$labels,df$predictions,
            smoothed = TRUE,
            # arguments for ci
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            # arguments for plot
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)


sens.ci <- ci.se(pROC_obj)
plot(sens.ci, type="shape", col="lightblue")
## Warning in plot.ci.se(sens.ci, type = "shape", col = "lightblue"): Low
## definition shape.
plot(sens.ci, type="bars")


```


### Scores

``` {r ML_plots1}


# pls::loadingplot(annotation_model$finalModel)
# pls::corrplot(annotation_model$finalModel)
# pls::predplot(annotation_model$finalModel)
# pls::coefplot(annotation_model$finalModel)
# pls::scoreplot(annotation_model$finalModel)



#Scores
annotation_model_scores <- 
  annotation_model$finalModel %>%
  pls::scores() %>% {.[]} %>%
  as.matrix() %>%
  as_tibble(rownames = "id") %>%
  set_names(gsub(" ", "", tolower(colnames(.)))) %>%
  bind_cols(Y_map, 
            .) %>%
  mutate(id = gsub("c", "", id),
         id = gsub("_", " ", id)) %>%
  separate(id, into = c("tissue_id", "cluster_id"), remove = F)

annotation_model_scores %>%
  group_by(Y) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = Y)) + 
  
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = id),
            color = "black", 
            alpha = 0.3,
            size = 1.5) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, Y) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = Y),
            inherit.aes = F, 
            alpha = 0.6,
            size = 3,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of annotated clusters", "Supervised clustering using markers only")
ggsave(savepath("PLS model scores.pdf"), width = 10, height = 10)

annotation_model$finalModel %>%
  pls::scores() %>% {.[]} %>%
  as.matrix() %>%
  as_tibble(rownames = "id")

annotation_model$finalModel %>%
  pls::loadings() %>% {.[]} %>%
  as.matrix() %>%
  as_tibble(rownames = "ensg_id") %>%
  column_to_rownames("ensg_id") %>%
  pheatmap(clustering_method = "ward.D2", 
           cluster_cols = F)

annotation_model$finalModel %>%
  pls::scores() %>% {.[]} %>%
  as.matrix() %>%
  as_tibble(rownames = "id") %>%
  column_to_rownames("id") %>%
   pheatmap(clustering_method = "ward.D2", 
           cluster_cols = F)


plot_comps <- 10
g <- 
  annotation_model_scores %>%
  gather(component, score, -(1:6)) %>% 
  select(-class_id, -id1) %>%
  mutate(comp_n = as.numeric(gsub("comp", "", component))) %>%
  filter(comp_n <= plot_comps) %>% {
    g_data <<- .
    tidyr::crossing(comp_n1 = 1:plot_comps, comp_n2 = 1:plot_comps) %>%
      left_join(g_data,
                by = c("comp_n1" = "comp_n")) %>%
      left_join(g_data,
                by = c("Y", "id", "tissue_id", "cluster_id", "comp_n2" = "comp_n"), 
                suffix = c("1", "2"))
  } %>%
  
  group_by(Y, comp_n1, comp_n2) %>% 
  mutate(mean_V1 = mean(score1),
         mean_V2 = mean(score2)) %>%
  filter(component1 != component2) %>%
  ggplot(aes(score1, score2, color = Y)) + 
  
  geom_segment(aes(xend = mean_V1, yend = mean_V2),
               show.legend = F) +
  geom_point(size = 1, 
             alpha = 0.7,
             show.legend = F) + 
  # geom_text(aes(label = id),
  #           color = "black", 
  #           alpha = 0.3,
  #           size = 1.5) +
  # geom_text(data = . %>%
  #             select(mean_V1, mean_V2, Y, comp_n2, comp_n1) %>%
  #             unique(),
  #           aes(x = mean_V1, y = mean_V2, label = Y),
  #           inherit.aes = F,
  #           alpha = 0.6,
  #           size = 1,
  #           fontface = "bold") +
  facet_grid(comp_n2 ~ comp_n1) +
  
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of annotated clusters", "Supervised clustering using markers only")
ggsave(savepath("PLS model multiple components score.pdf"), plot = g, width = 4*plot_comps, height = 4*plot_comps)  
  

```





#Old

##Example RPL5

```{r}


annotated_tmm %>% 
  filter(ensg_id == gene_info92 %>% 
           filter(gene_name == "RPL5") %>% 
           pull(ensg_id)) %>%
  select(tissue, cell_type_name, norm_count, tmm) %>% 
  gather(type, value, norm_count, tmm) %>% 
  ggplot(aes(value, paste(tissue, cell_type_name))) +
  geom_col() +
  facet_wrap(~type)


# annotated_tmm %>% 
#   inner_join(gene_pearson_net %>% 
#                as_tibble() %>%
#                filter(component %in% c(8,10)),
#              by = c("ensg_id" = "name")) %>%
#   group_by(ensg_id) %>% 
#   mutate(norm_count = norm_count / max(norm_count),
#          tmm = tmm / max(tmm)) %>%
#   group_by(tissue, cell_type_name) %>% 
#   summarise(norm_count = mean(norm_count),
#             tmm = mean(tmm)) %>%
#   ggplot(aes(tmm, norm_count)) +
#   geom_point()
  # # select(tissue, cell_type_name, norm_count, tmm) %>% 
  # gather(type, value, norm_count, tmm) %>% 
  # ggplot(aes(value, paste(tissue, cell_type_name))) +
  # geom_col() +
  # facet_wrap(~type)

```


### PCA Distance

```{r}

PCA_coords <- 
  annotated_clusters_pca %$%
  scores[,1:pc_95]

PCA_centers <- 
  PCA_coords %>% 
  as_tibble(rownames = "id") %>% 
  gather(PC, score, -1) %>% 
  left_join(cluster_id_map %>% 
              select(id, cell_type_name),
            by = c("id")) %>%
  filter(cell_type_name != "Inflammatory cells") %>%
  filter(cell_type_name != "Immune cells") %>%
  group_by(cell_type_name, PC) %>%
  summarise(score = mean(score)) %>% 
  ungroup() %>%
  spread(PC, score) %>%
  mutate(cell_type_name = paste("center", cell_type_name)) %>% 
  rename(id = cell_type_name)

PCA_distances <- 
  bind_rows(PCA_coords %>% 
            as_tibble(rownames = "id"), 
          PCA_centers) %>% 
  column_to_rownames("id") %>% 
  dist(upper = T)


PCA_distances_list <- 
  PCA_distances %>% 
  as.matrix() %>% 
  as_tibble(rownames = "id1") %>% 
  gather(id2, dist, -1) %>%
  filter(id1 != id2) %>%
  mutate(id1_type = case_when(grepl("^center", id1) ~ "center",
                              grepl("^\\d", id1) ~ "cluster"),
         id2_type = case_when(grepl("^center", id2) ~ "center",
                              grepl("^\\d", id2) ~ "cluster"))

PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>%
  group_by(id1)
  
PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  filter(cell_type_name == "T lymphocytes") %>% 
  ggplot(aes(id1, dist )) +
  geom_point()
 

PCA_distances %>%
  as.matrix() %>%
  
# {grep("^\\d", rownames(.))}
# {grep("^center", colnames(.))}
{.[grep("^\\d", rownames(.)), grep("^center", colnames(.))]} %>%
  t() %>%
  pheatmap(clustering_method = "ward.D2")
  

plot_data <- 
  PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  group_by(id1) %>%
  top_n(3, -dist) %>%
  ungroup() %>%
  arrange(cell_type_name, id1) %>%
  mutate(id1 = factor(id1, unique(id1))) %>%
  ungroup() %>%
  filter(correct)

plot_data_2 <-
  plot_data %>%
  group_by(id2) %>%
  mutate(rank = rank(-dist)) %>% 
  filter(rank != 1 | (rank == 1 & dist == 0)) %>%
  group_by(id2) %>%
  summarise(mean_dist = mean(dist[which(correct)]),
            sd_dist = sd(dist[which(correct)])) %>% 
  mutate(mean = mean_dist,
         lower = mean_dist - 2 * sd_dist,
         upper = mean_dist + 2 * sd_dist)

plot_order <- 
  plot_data_2 %>% 
  arrange(mean_dist) %>%
  pull(1)

plot_data3 <-
  plot_data %>%
  
  left_join(plot_data_2, 
            by = "id2") %>%
  mutate(outlier = dist < lower | dist > upper) %>% 
  mutate(id2 = factor(id2, plot_order)) 

plot_data3 %>%
  ggplot(aes(dist, id2, color = id2)) +
  geom_point(size = 2.5, 
             show.legend = F) +
  geom_point(data = . %>% 
               filter(outlier),
             size = 6,
             color = "red", 
             alpha = 0.5,
             show.legend = F) +
  
  geom_segment(data = plot_data_2 %>% 
                 mutate(id2 = factor(id2, plot_order)),
               aes(x = lower, xend = upper, 
                   y = id2, yend = id2),
               show.legend = F) +
  geom_point(data = plot_data_2 %>% 
               mutate(id2 = factor(id2, plot_order)),
             aes(mean, id2), 
             inherit.aes = F, 
             shape = 4, 
             color = "black",
             size = 4,
             show.legend = F) +
  geom_point(size = 2.5,
             show.legend = F) +
  geom_text(data = . %>% 
              filter(outlier),
            aes(label = paste(tissue_id, cluster_id)),
            color = "black",
            show.legend = F) +
  
  scale_color_manual(values = cell_type_palette) +
  
  stripped_theme_facet + 
  theme(panel.grid.major.y = element_line(color = "gray90"))
ggsave(savepath("PCA distance outlier plot.pdf"), width = 15, height = 7)  

PCA_group_distance_outliers <- 
  plot_data3 %>% 
  filter(outlier) %>% 
  pull(id1) %>%
  as.character()

```

```{r}

plot_data <- 
  PCA_distances_list %>%
  filter(id1_type == "cluster" &
           id2_type == "center") %>% arrange(dist) %>% 
  mutate(id2 = gsub("^center ", "", id2)) %>% 
  left_join(cluster_id_map,
            by = c("id1" = "id")) %>% 
  mutate(correct = cell_type_name == id2) %>%
  group_by(id1, correct) %>%
  top_n(1, -dist) %>%
  ungroup() %>%
  select(id1, id2, dist, mixed_cell_types, correct) %>%
  pivot_wider(names_from = correct, values_from = c(dist, id2)) %>%
  mutate(annotation_correct = dist_TRUE < dist_FALSE)


plot_data %>% 
  ggplot(aes(dist_TRUE, dist_FALSE, 
             color = id2_TRUE,
             alpha = annotation_correct, 
             shape = as.factor(mixed_cell_types),
             size = annotation_correct)) +
  geom_point(show.legend = F) +
  geom_abline(slope = 1,
              linetype = "dashed") + 
  geom_text(data = . %>% 
              filter(!annotation_correct),
            aes(dist_TRUE, dist_FALSE, 
                label = str_extract(id1, "^\\d{1,3} \\d{1,3}")),
            size = 2,
            inherit.aes = F) + 
  scale_alpha_manual(values = c("TRUE" = 0.5, "FALSE" = 1)) +
  scale_size_manual(values = c("TRUE" = 2, "FALSE" = 4)) +
  scale_color_manual(values = cell_type_palette, guide = F) +
  ylab("Distance to annotated center") +
  xlab("Distance to other closest center") +
  ggtitle("Comparing likeness to other clusters with same annotation",
          "Clusters under the line are more similar to clusters with other annotation, triangle = mixed cluster") + 
  stripped_theme_facet
ggsave(savepath("PCA annotated distance vs other scatter.pdf"), width = 10, height = 10)    


PCA_annotation_distance_outliers <- 
  plot_data %>% 
  filter(!annotation_correct) %>%
  pull(id1)

```

```{r}



PCA_distances_list %>%
  filter(id1 %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)) %>% 
  filter(id1_type == "cluster" & id2_type == "center") %>% 
  group_by(id1) %>% 
  mutate(mean_dist = mean(dist),
         sd_dist = sd(dist),
         lower = mean_dist - 1.5 * sd_dist,
         outlier = dist < lower, 
         dist_from_mean = mean_dist - dist) %>%
  ungroup() %>% 
  ggplot(aes(dist_from_mean, id1, alpha = outlier)) + 
  geom_point()

PCA_distances_outliers <- 
  PCA_distances_list %>%
  filter(id1 %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)) %>% 
  filter(id1_type == "cluster" & id2_type == "center") %>% 
  group_by(id1) %>% 
  # top_n(5, -dist) %>% 
  arrange(id1, dist) %>%
  ungroup() %>%
  left_join(cluster_id_map,
            c("id1" = "id")) %>%
  select(id = 1, 
         center = 2, 
         distance = 3, 
         tissue_id,
         tissue, 
         cluster_id,
         cell_type_name,
         mixed_cell_types)

PCA_distances_outliers %>% 
  select(1, 2, 3) %>% 
  spread(center, distance) %>% 
  column_to_rownames("id") %>% 
  pheatmap(color = heatmap_palette,
           clustering_method = "ward.D2",
           border_color = NA,
           cutree_rows = 4,
           cutree_cols = 6, 
           annotation_row = cluster_id_map %>% 
             select(id, mixed_cell_types) %>% 
             mutate(mixed_cell_types = as.character(mixed_cell_types)) %>%
             column_to_rownames("id"),
           annotation_colors = list(mixed_cell_types = c("1" = "red", "0" = "white")),
           filename = savepath("Outlier cluster distance to centers.pdf"),
           width = 10,
           height = 8)
  
PCA_distances_outliers %>%
  group_by(id) %>% 
  top_n(3, -distance)  %>%
  write_csv(savepath("top 3 lowest distance per outlier cluster.csv"))

```

####Center distance for unannotated

```{r}

PCA_not_annotated_distances <- 
  bind_rows(unannotated_PCA_transormed[,1:annotated_clusters_pca$pc_95] %>% 
            as_tibble(rownames = "id"), 
          PCA_centers) %>% 
  column_to_rownames("id") %>% 
  dist(upper = T)

PCA_not_annotated_distances_list <- 
  PCA_not_annotated_distances %>% 
  as.matrix() %>% 
  as_tibble(rownames = "id1") %>% 
  gather(id2, dist, -1) %>%
  filter(id1 != id2) %>%
  mutate(id1_type = case_when(grepl("^center", id1) ~ "center",
                              grepl("^\\d", id1) ~ "cluster"),
         id2_type = case_when(grepl("^center", id2) ~ "center",
                              grepl("^\\d", id2) ~ "cluster"))


PCA_not_annotated_distances_list %>%
  filter(id1_type == "cluster" & id2_type == "center") %>%
  rename(id = id1, center = id2) %>%
  left_join(cluster_annotation %>%
              mutate(id = paste(tissue_id, cluster_id)) %>%
              select(id, tissue_id, cluster_id, tissue_name, cell_type_name, mixed_cell_types, reliability),
            by = "id") %>%
  filter(is.na(cell_type_name)) %>% 
  group_by(id) %>%
  top_n(3, -dist) %>% 
  ungroup() %>%
  separate(id, into = c("tissue_id", "cluster_id"), remove = F, sep = " ") %>%
  left_join(cluster_annotation %>% 
              select(tissue_id, tissue_name) %>% 
              unique() %>%
              mutate(tissue_id = as.character(tissue_id)),
            by = "tissue_id") %>%
  arrange(id) %>% 
  select(1:4, 
         distance = dist, 
         tissue_name = tissue_name.y) %>%
  write_csv(savepath("Nearest centers for unannotated cluster.csv"))

```


###PLSDA

```{r}

PLS_data <- 
  annotated_norm_count_clean_wide %>% 
  select(1, ensg_sd$ensg_id) %>%
  column_to_rownames("id") %>%
  {. + 1}
  # {log10(. + 1)} %>%
  # scale(scale = sqrt(ensg_sd$sd), center = T)
  


X <- PLS_data[which(!rownames(PCA_data) %in% PCA_distances_outliers$id),] #annotated_clusters_pca$scores 

Y <-
  X %>% 
  rownames() %>% #rownames(annotated_clusters_pca$scores) %>%  
  enframe("row", "id") %>% 
  left_join(cluster_id_map,
            by = "id") %>%
  pull(cell_type_name)

SPLSDA_annotated <- splsda(X, Y, ncomp = 100, logratio = "CLR")

plotIndiv(SPLSDA_annotated)


SPLSDA_expvar <- 
  SPLSDA_annotated$explained_variance$X %>%
  enframe("comp", "exp_var") %>% 
  mutate(cum_var = cumsum(exp_var),
         comp = factor(comp, comp),
         comp_n = as.numeric(gsub("comp ", "", comp)))

expvar_comp_lim <-
  SPLSDA_expvar %>% 
  filter(cum_var >= 0.95) %>% 
  head(1)


SPLSDA_expvar %>%
  gather(metric, exp_var, -comp, -comp_n) %>% 
  
  ggplot(aes(comp_n, exp_var, color = metric)) +
  geom_line() +
  geom_vline(xintercept = expvar_comp_lim$comp_n)





# annotated_clusters_umap <- 
  # umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

 
# No mix, annotated cells
SPLSDA_annotated$variates$X %>%
  as_tibble(rownames = "id") %>%
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3,
            size = 1.5) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 3,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA")

ggsave(savepath("Annotated clusters SPLSDA.pdf"), width = 12, height = 12)

# Also non-annotated cells

PLS_data_not_annotated <- 
  cluster_norm_count %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") 

X %>% 
  logratio.transfo(logratio = "CLR") %>%
  scale()
  
PLS_data_not_annotated_scaled <- 
  PLS_data_not_annotated %>%
  {(. + 1)} %>%
  
  compositions::clr() %>%
  scale(scale = apply(., MARGIN = 2, function(x) (sd(x))), center = T) 
###

 # meanX = colMeans(temp, na.rm = TRUE)
 #  if (scale) {
 #    sqrt.sdX = colSds(temp, na.rm = TRUE)
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #    data.list.study.scale_i = data.list.study.scale_i/rep(1, 
 #      nrow(temp)) %*% t(sqrt.sdX)
 #    ind = which(sqrt.sdX == 0)
 #    if (length(ind) > 0) 
 #      data.list.study.scale_i[, ind] = 0
 #  }
 #  else {
 #    sqrt.sdX = NULL
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #  }
 #  out = list(data_scale = data.list.study.scale_i, meanX = meanX, 
 #    sqrt.sdX = sqrt.sdX)
 #  return(out)

###


dim(PLS_data_not_annotated_scaled)
dim(SPLSDA_annotated$loadings$X)

SPLSDA_not_anno_transformed <- 
  pca_transform(PLS_data_not_annotated_scaled,
                SPLSDA_annotated$loadings$X)

left_join(SPLSDA_annotated$variates$X %>% 
            as_tibble(rownames = "id") %>%
            mutate(id = str_extract(id, "^\\d{1,3} \\d{1,3}")) %>%
            select(1:2),
          SPLSDA_not_anno_transformed %>%
            as_tibble(rownames = "id") %>% 
            select(1:2),
          by = "id") %>% 
  ggplot(aes(comp1.x, comp1.y)) +
  geom_point() +
  geom_abline(slope = 1)

g <-
  SPLSDA_not_anno_transformed %>%
  as_tibble(rownames = "id") %>%
  left_join(all_clusters_map,
            by = "id") %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F,
             alpha = 0.3,
             size = 1) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 2,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA")

ggsave(savepath("All clusters SPLSDA.pdf"), plot = g, width = 12, height = 12)

g + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3, 
            size = 1.5)

ggsave(savepath("All clusters SPLSDA with text.pdf"), plot = g, width = 12, height = 12)
```

```{r}


SPLSDA_UMAP <- 
  umap_calc(SPLSDA_not_anno_transformed, npcs = 2, n_neighbors = 30)

SPLSDA_UMAP$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
  # stat_density_2d(data = . %>%
  #                  group_by(celltype) %>% 
  #                  mutate(n = n()) %>% 
  #                  ungroup() %>% 
  #                  filter(n > 1) %>% 
  #                  filter(celltype != "Unknown"),
  #                geom = "polygon", 
  #                aes(V1, V2, 
  #                    fill = celltype,
  #                    alpha = as.factor(..level..)),
  #                inherit.aes = F,
#                bins = 20, 
#                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")
```

#### PLSDA only markers


```{r}

PLS_data <- 
  annotated_norm_count_clean_wide %>% 
  select(1, ensg_sd$ensg_id) %>%
  select(1, unique(cell_markers$ensg_id)) %>%
  column_to_rownames("id") %>%
  {. + 1}
  # {log10(. + 1)} %>%
  # scale(scale = T, center = T)
  # scale(scale = sqrt(ensg_sd$sd), center = T)
  
PLS_data %>% 
  as_tibble() %>%
  visdat::vis_miss()

X <- PLS_data[which(!rownames(PCA_data) %in% PCA_distances_outliers$id),] #annotated_clusters_pca$scores 

Y <-
  X %>% 
  rownames() %>% #rownames(annotated_clusters_pca$scores) %>%  
  enframe("row", "id") %>% 
  left_join(cluster_id_map,
            by = "id") %>%
  pull(cell_type_name)

SPLSDA_annotated <- splsda(X, Y, ncomp = 100, logratio = "CLR")

plotIndiv(SPLSDA_annotated)


SPLSDA_expvar <- 
  SPLSDA_annotated$explained_variance$X %>%
  enframe("comp", "exp_var") %>% 
  mutate(cum_var = cumsum(exp_var),
         comp = factor(comp, comp),
         comp_n = as.numeric(gsub("comp ", "", comp)))

expvar_comp_lim <-
  SPLSDA_expvar %>% 
  filter(cum_var >= 0.95) %>% 
  head(1)


SPLSDA_expvar %>%
  gather(metric, exp_var, -comp, -comp_n) %>% 
  
  ggplot(aes(comp_n, exp_var, color = metric)) +
  geom_line() +
  geom_vline(xintercept = expvar_comp_lim$comp_n)





# annotated_clusters_umap <- 
  # umap_calc(PCA_data, npcs = 2, n_neighbors = 30)

 
# No mix, annotated cells
SPLSDA_annotated$variates$X %>%
  as_tibble(rownames = "id") %>%
  left_join(cluster_id_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3,
            size = 1.5) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 3,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of annotated clusters", "Supervised clustering using markers only")

ggsave(savepath("Annotated clusters SPLSDA only markers.pdf"), width = 12, height = 12)

# Also non-annotated cells

PLS_data_not_annotated <- 
  cluster_norm_count %>%
  mutate(id = paste(tissue_id, cluster_id)) %>%
  # left_join(enframe(ensg_sd, "ensg_id", "sd"),
  #           by = "ensg_id") %>% 
  # mutate(norm_count = norm_count / sd) %>%
  select(ensg_id, id, norm_count) %>%
  filter(ensg_id %in% ensg_sd$ensg_id) %>%
  filter(ensg_id %in% unique(cell_markers$ensg_id)) %>%
  spread(ensg_id, norm_count) %>% 
  column_to_rownames("id") %>%
  {.[, rownames(SPLSDA_annotated$loadings$X)]}

X %>% 
  logratio.transfo(logratio = "CLR") %>%
  scale()
  
PLS_data_not_annotated_scaled <- 
  PLS_data_not_annotated %>%
  {(. + 1)} %>%
  
  compositions::clr() %>%
  scale(scale = apply(., MARGIN = 2, function(x) (sd(x))), center = T) 
###

 # meanX = colMeans(temp, na.rm = TRUE)
 #  if (scale) {
 #    sqrt.sdX = colSds(temp, na.rm = TRUE)
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #    data.list.study.scale_i = data.list.study.scale_i/rep(1, 
 #      nrow(temp)) %*% t(sqrt.sdX)
 #    ind = which(sqrt.sdX == 0)
 #    if (length(ind) > 0) 
 #      data.list.study.scale_i[, ind] = 0
 #  }
 #  else {
 #    sqrt.sdX = NULL
 #    data.list.study.scale_i = temp - rep(1, nrow(temp)) %*% 
 #      t(meanX)
 #  }
 #  out = list(data_scale = data.list.study.scale_i, meanX = meanX, 
 #    sqrt.sdX = sqrt.sdX)
 #  return(out)

###


dim(PLS_data_not_annotated_scaled)
dim(SPLSDA_annotated$loadings$X)

SPLSDA_not_anno_transformed <- 
  pca_transform(PLS_data_not_annotated_scaled,
                SPLSDA_annotated$loadings$X)

left_join(SPLSDA_annotated$variates$X %>% 
            as_tibble(rownames = "id") %>%
            mutate(id = str_extract(id, "^\\d{1,3} \\d{1,3}")) %>%
            select(1:2),
          SPLSDA_not_anno_transformed %>%
            as_tibble(rownames = "id") %>% 
            select(1:2),
          by = "id") %>% 
  ggplot(aes(comp1.x, comp1.y)) +
  geom_point() +
  geom_abline(slope = 1)

g <-
  SPLSDA_not_anno_transformed %>%
  as_tibble(rownames = "id") %>%
  left_join(all_clusters_map,
            by = "id") %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(comp1),
         mean_V2 = mean(comp2)) %>% 
  ggplot(aes(comp1, comp2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 6) +
   # stat_density_2d(data = . %>%
   #                  group_by(celltype) %>% 
   #                  mutate(n = n()) %>% 
   #                  ungroup() %>% 
   #                  filter(n > 1) %>% 
   #                  filter(celltype != "Unknown"),
   #                geom = "polygon", 
   #                aes(V1, V2, 
   #                    fill = celltype,
   #                    alpha = as.factor(..level..)),
   #                inherit.aes = F,
   #                bins = 20, 
   #                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F,
             alpha = 0.3,
             size = 1) +
  geom_point(size = 3, 
             alpha = 0.7,
             show.legend = F) + 
  
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            size = 2,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("SPLSDA of all clusters - not annotated in gray", "Supervised clustering using markers only")

ggsave(savepath("All clusters SPLSDA only markers.pdf"), plot = g, width = 12, height = 12)

g + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3, 
            size = 1.5)

ggsave(savepath("All clusters SPLSDA only markers with text.pdf"), width = 12, height = 12)
```

```{r}


SPLSDA_UMAP <- 
  umap_calc(SPLSDA_not_anno_transformed, npcs = 2, n_neighbors = 30)

SPLSDA_UMAP$layout %>% 
  as_tibble(rownames = "id") %>% 
  left_join(all_clusters_map) %>% 
  group_by(cell_type_name) %>% 
  mutate(mean_V1 = mean(V1),
         mean_V2 = mean(V2)) %>% 
  ggplot(aes(V1, V2, color = cell_type_name)) + 
  geom_point(data = . %>% 
               filter(id %in% c(PCA_annotation_distance_outliers, PCA_group_distance_outliers)),
             color = "red", 
             alpha = 0.5, 
             size = 10) +
  # stat_density_2d(data = . %>%
  #                  group_by(celltype) %>% 
  #                  mutate(n = n()) %>% 
  #                  ungroup() %>% 
  #                  filter(n > 1) %>% 
  #                  filter(celltype != "Unknown"),
  #                geom = "polygon", 
  #                aes(V1, V2, 
  #                    fill = celltype,
  #                    alpha = as.factor(..level..)),
  #                inherit.aes = F,
#                bins = 20, 
#                show.legend = F, h = c(4, 4)) +
geom_segment(data = . %>% 
               filter(cell_type_name != "Not annotated"),
             aes(xend = mean_V1, yend = mean_V2),
             show.legend = F) +
  geom_point(size = 5, 
             alpha = 0.7,
             show.legend = F) + 
  geom_text(aes(label = paste(tissue_id, cluster_id)),
            color = "black", 
            alpha = 0.3) +
  geom_text(data = . %>%
              select(mean_V1, mean_V2, cell_type_name) %>% 
              unique(),
            aes(x = mean_V1, y = mean_V2, label = cell_type_name),
            inherit.aes = F, 
            alpha = 0.6,
            fontface = "bold") +
  scale_color_manual(values = cell_type_palette) + 
  scale_fill_manual(values = cell_type_palette) + 
  scale_alpha_discrete(range = c(0, 0.1)) + 
  stripped_theme +
  ggtitle("Annotated clusters UMAP", "Including mixed clusters")
```







##Cluster-wise classification

```{r class2}

cluster_class_new_ids <- 
  annotated_norm_count_main %>% 
  select(tissue, tissue_id, cluster_id, cell_type_name) %>%
  distinct %>%
  group_by(cell_type_name) %>% 
  mutate(n = length(cell_type_name), 
         row_number = row_number(),
         cluster_id_2 = ifelse(n == 1, cell_type_name, paste(cell_type_name, LETTERS[row_number]))) %>% 
  ungroup()

cluster_class <- 
  annotated_norm_count_main %>% 
  left_join(cluster_class_new_ids %>% 
              select(tissue, tissue_id, cluster_id, cluster_id_2), 
            by = c("tissue", "tissue_id", "cluster_id")) %>%
  hpa_gene_classification(expression_col = "norm_count", 
                          tissue_col = "cluster_id_2", 
                          gene_col = "ensg_id", 
                          enr_fold = 4, 
                          max_group_n = 50, 
                          det_lim = 1)


###



```



##Tissue-cell type classification

```{r class3}

dataset_cell_type_norm_count <- 
  annotated_norm_count_main %>% 
  mutate(tissue_id = as.character(tissue_id)) %>%
  left_join(dataset_map,
            by = c("tissue" = "dataset", "tissue_id")) %>%
  mutate(tissue_cell_type_id = paste(tissue_type, cell_type_name, sep = "_")) %>%
  group_by(tissue_cell_type_id, ensg_id) %>%
  summarise(norm_count = mean(norm_count)) 
  


dataset_cell_type_class <- 
  dataset_cell_type_norm_count %>% 
  ungroup() %>%
  hpa_gene_classification(expression_col = "norm_count", 
                          tissue_col = "tissue_cell_type_id", 
                          gene_col = "ensg_id", 
                          enr_fold = 4, 
                          max_group_n = 20, 
                          det_lim = 1)



dataset_cell_type_class %>%
  mutate(spec_category = str_to_sentence(spec_category),
         dist_category = str_to_sentence(dist_category)) %>%
  
  multi_alluvial_plot(vars = c("Specificity" = "spec_category", 
                               "Distribution" = "dist_category"), 
                      chunk_levels = c('Tissue enriched', 'Group enriched', 
                                       'Tissue enhanced', 'Low tissue specificity', 
                                       'Detected in single',
                                       'Detected in some', 
                                       'Detected in many', 
                                       'Detected in all',
                                       'Not detected'), 
                      pal = c(gene_category_pal, elevation_identity_pal), 
                      color_by = c(1, 1)) 
ggsave(savepath("tissue cell type class comb n_genes alluvial.pdf"), width = 4, height = 6, useDingbats = F)


class_table_temp <-
  dataset_cell_type_class %>%
  select(gene, spec_category, enriched_tissues) %>%
  separate_rows(enriched_tissues, sep = ";") %>%
  mutate(spec_category = factor(spec_category, levels = rev(spec_category_levels)),
         enriched_tissues = (enriched_tissues))
  

class_table_temp %>%
  filter(!is.na(enriched_tissues)) %>%
  group_by(enriched_tissues, spec_category) %>%
  summarise(n_genes = n()) %>% 
  ungroup() %>%
  ggplot(aes(n_genes, enriched_tissues, fill = spec_category)) +
  geom_col(width = 0.8, size = 0.1) +
  simple_theme +
  scale_fill_manual(values = gene_category_pal, name = "Specificity") +
  
  xlab("Number of genes") +
  # scale_y_continuous(position = "bottom", expand = c(0,0)) + 
  
  theme(axis.text.y = element_text(hjust = 0.5), 
        
        axis.title.y = element_blank(),
        panel.border = element_blank())


ggsave(savepath("Tissue celltype N enr genes per tissue + dendro 2.pdf"), width = 7, height = 12)

###
dataset_cell_type_palette <-
  expand_grid(name = cell_type_palette %>%
                names(),
              dataset = unique(dataset_map$tissue_type)) %>%
  left_join(cell_type_palette %>%
              enframe ) %>%
  unite(name, dataset, name) %$%
  set_names(value, name)
```

### Network

```{r class_network_2_whole_groups, echo=FALSE, message=FALSE, warning=FALSE}


class_network_celltype_dataset_enriched <- 
  classification_network_plot_2(class_table = dataset_cell_type_class,
                                gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "group enriched"),
                                pal = c(dataset_cell_type_palette, gene_category_pal),
                                savename = "Celltype_dataset enriched",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 3,
                                node_filter_n_show = 5, 
                                scale_factor = 0.5)
                              
ggsave(savepath("Celltype_dataset enriched.pdf"), plot = class_network_celltype_dataset_enriched, 
       width = 25, height = 16, useDingbats = F)


class_network_celltype_dataset_elevated <- 
  classification_network_plot_2(class_table = dataset_cell_type_class,
                                gene_col = "gene",
                                spec_col = "spec_category",
                                enriched_col = "enriched_tissues",
                                spec_filter = c("tissue enriched", 
                                                "tissue enhanced",
                                                "group enriched"),
                                pal = c(dataset_cell_type_palette, gene_category_pal),
                                savename = "Celltype_dataset enhanced",
                                enriched_sep = ";",
                                node_filter_rank = 2,
                                node_filter_show_cat = "tissue enriched",
                                node_filter_min = 3,
                                node_filter_n_show = 5, 
                                scale_factor = 0.5)
ggsave(savepath("Celltype_dataset elevated.pdf"), plot = class_network_celltype_dataset_elevated, 
       width = 25, height = 16, useDingbats = F)



```

## Composite network plot

```{r}

class_network_celltype_enriched +
  ggtitle("Celltype enriched") + 
  class_network_celltype_elevated +
  ggtitle("Celltype elevated") + 
  class_network_celltype_dataset_enriched +
  ggtitle("Celltype dataset enriched") + 
  class_network_celltype_dataset_elevated +
  ggtitle("Celltype dataset elevated") 

ggsave(savepath("Classification composite plot.pdf"), width = 30, height = 20)

```


##Compare three classifications

```{r}

cell_type_class %>% 
  select(1:2) %>% 
  left_join(dataset_cell_type_class %>% 
              select(1:2),
            by = "gene",
            suffix = c("_cell", "_dataset_cell")) %>%
  left_join(cluster_class %>% 
              select(gene, spec_category_cluster = 2),
            by = "gene") %>%
  multi_alluvial_plot(vars = c("Cell type" = "spec_category_cell", 
                               "Dataset + cell type" = "spec_category_dataset_cell", 
                               "Cluster" = "spec_category_cluster"), 
                      chunk_levels = c('tissue enriched', 'group enriched', 
                                       'tissue enhanced', 'low tissue specificity', 
                                       'not detected'), 
                      pal = c(gene_category_pal, elevation_identity_pal), 
                      color_by = c(1, 2, 2)) 
ggsave(savepath("Comparison three classifications alluvial.pdf"), width = 6, height = 6, useDingbats = F)

c("Global" = n_distinct(cell_type_norm_count$cell_type_name),
  "Tissue-wise cell type" = n_distinct(dataset_cell_type_norm_count$tissue_cell_type_id),
  "Cluster" = n_distinct(cluster_class_new_ids$cluster_id_2)) %>% 
  enframe() %>% 
  mutate(name = factor(name, name)) %>%
  ggplot(aes(name, value, label = value)) + 
  geom_col() + 
  geom_text(vjust = -0.5) +
  theme_minimal() +
  ylab("Number of cell types/clusters") + 
  theme(axis.title.x = element_blank())
ggsave(savepath("Number of classification units.pdf"), width = 4, height = 4)

```



##Data distribution

```{r distribution_count, echo=FALSE, message=FALSE, warning=FALSE}


cheng_blood_count %>%
  # filter(tmm > 4) %>%
{ggplot(., aes(celltype, count, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5, color = "white") + 
    
    coord_flip() +
    scale_y_log10() +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet +
    
    ggplot(., aes(celltype, tmm, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5, color = "white") + 
    
    coord_flip() +
    scale_y_log10() +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet + 
    
    plot_layout(ncol = 1)}
ggsave(savepath("sample distribution.pdf"), width = 6, height = 6)  

cheng_blood_count %>% 
  mutate(is_zero = count == 0) %>%
  group_by(celltype, is_zero) %>% 
  summarise(n = n()) %>%
  ggplot(aes(celltype, n, fill = is_zero)) + 
  geom_col(color = "black") + 
  coord_flip() + 
  scale_fill_manual(values = c("TRUE" = "darkgrey", "FALSE" = "white")) + 
  stripped_theme_facet
ggsave(savepath("n zeros per sample.pdf"), width = 4, height = 4)

cheng_blood_count %>% 
  mutate(ratio = tmm / count) %>% 
  filter(is.finite(ratio)) %>% 
  group_by(celltype) %>% 
  summarise(ratio = mean(ratio))

cheng_blood_count %>% 
  select(-count) %>%
  spread(celltype, tmm) %>% 
  column_to_rownames("gene_name") %>% 
  cor(method = "spearman") %>% 
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

cheng_blood_count %>% 
  select(-tmm) %>%
  spread(celltype, count) %>% 
  column_to_rownames("gene_name") %>% 
  cor(method = "spearman") %>% 
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")


cheng_propr_count <-
  cheng_blood_count %>% 
  select(-tmm) %>%
  spread(celltype, count) %>% 
  column_to_rownames("gene_name") %>% 
  propr() 

cheng_propr_tmm <-
  cheng_blood_count %>% 
  select(-count) %>%
  spread(celltype, tmm) %>% 
  column_to_rownames("gene_name") %>% 
  propr() 

cheng_propr_count@matrix %>%
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

cheng_propr_tmm@matrix %>%
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

 
gene_propr_count <-
  cheng_blood_count %>% 
  select(-tmm) %>%
  group_by(gene_name) %>% 
  mutate(has_zero = any(count == 0)) %>% 
  ungroup() %>% 
  filter(!has_zero) %>%
  select(-has_zero) %>%
  spread(gene_name, count) %>% 
  column_to_rownames("celltype") %>% 
  propr() 
save(gene_propr_count, file =  "data/gene propr count.Rdata")

gene_propr_res <- 
  gene_propr_count@matrix %>%
  as_tibble(rownames = "gene_name1") %>% 
  gather(gene_name2, prop, -1) 


# gene_propr_res %>% 
#   ggplot(aes(prop)) + 
#   geom_density()

gene_propr_res_filtered <- 
  gene_propr_res %>% 
  filter(gene_name1 > gene_name2) %>% 
  filter(prop > 0.95)



edges <- 
  gene_propr_res_filtered %>%
  select(from = 1, 
         to = 2) %>% 
  mutate(weight = 1)

nodes <- 
  gene_propr_res_filtered %$%
  c(gene_name1,
    gene_name2) %>% 
  unique()


coexp_net <- 
  graph_from_data_frame(d = edges, 
                        vertices = nodes, 
                        directed = F)

net_communities <- 
  components(coexp_net) %$% 
  left_join(enframe(membership, 
                    "node", "community"), 
            enframe(csize, 
                    "community", "community_size"), 
            by = "community")

net_communities %>%
  select(-1) %>%
  unique() %>%
  ggplot(aes(community, community_size)) +
  geom_col()


RP_cluster <- 
  net_communities %>%
  filter(community == 3)


cheng_blood_count %>%
{ggplot(., aes(celltype, count, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5) + 
    geom_point(data = cheng_blood_count %>%
                 filter(gene_name %in% RP_cluster$node)) +
    geom_line(data = cheng_blood_count %>%
                filter(gene_name %in% RP_cluster$node), 
              aes(group = gene_name)) +
    coord_flip() +
    scale_y_log10() +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet +
    ggplot(., aes(celltype, count, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5) + 
    geom_point(data = cheng_blood_count %>%
                 filter(gene_name %in% RP_cluster$node)) +
    geom_line(data = cheng_blood_count %>%
                filter(gene_name %in% RP_cluster$node), 
              aes(group = gene_name)) +
    coord_flip() +
    # scale_y_log10() +
    scale_y_continuous(limits = c(0, 50)) +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet + 
    plot_layout(ncol = 1)}

cheng_blood_count %>%
  filter(gene_name %in% RP_cluster$node) %>% 
  select(1:3) %>%
  spread(celltype, count) %>%
  
  column_to_rownames("gene_name") %>% 
  
  psych::pairs.panels()
  

# lm normalization


lm_RP_data <- 
  cheng_blood_count %>%
  filter(gene_name %in% RP_cluster$node) %>% 
  select(1, 2, tpm) %>% 
  mutate(log_count = log10(tpm)) %>% 
  group_by(gene_name) %>% 
  mutate(median_log_count = median(log_count)) %>% 
  ungroup()

lm_normalization_factors <- 
  lm_RP_data %>%
  group_by(celltype) %>%
  do({
    g_data <- .
    lm(median_log_count ~ log_count, 
       data = g_data)$coefficients %>%
      enframe("term", "coefficient") 
  }) %>% 
  spread(term, coefficient) %>% 
  rename(m = `(Intercept)`,
         k = log_count) %>% 
  ungroup()

cheng_blood_count %>% 
  left_join(lm_normalization_factors) %>% 
  mutate(just_count = 10 ^ (k * log10(tpm) + m)) %>% 
  mutate(just_count = ifelse(just_count < 0, 0, just_count)) %>% 
  {ggplot(., aes(celltype, tpm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      
      ggplot(., aes(celltype, just_count, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet + 
      
      ggplot(., aes(celltype, tmm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      plot_layout(ncol = 1)}


cheng_blood_count %>% 
  left_join(lm_normalization_factors) %>% 
  mutate(just_count = 10 ^ (k * log10(tpm) + m)) %>% 
  mutate(just_count = ifelse(just_count < 0, 0, just_count)) %>% 
  filter(just_count > 4) %>%
  {ggplot(., aes(celltype, tpm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      
      ggplot(., aes(celltype, just_count, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet + 
      
      ggplot(., aes(celltype, tmm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      plot_layout(ncol = 1)}


#######





RP_tmm_coefs <- 
  cheng_blood_count %>% 
  filter(gene_name %in% RP_cluster$node) %>% 
  select(1, 2, count) %>% 
  spread(celltype, count) %>% 
  column_to_rownames("gene_name") %>% 
  tmm_norm_median_ref(doWeighting = T,
                      logratioTrim = 0.1) %>% 
  as_tibble(rownames = "gene_name") %>%
  gather(celltype, RP_tmm, -1) %>% 
  left_join(cheng_blood_count, 
            by = c("gene_name", "celltype")) %>% 
  mutate(ratio = RP_tmm / count) %>% 
  filter(is.finite(ratio)) %>% 
  group_by(celltype) %>%
  summarise(ratio = mean(ratio))
  
cheng_blood_count_2 <- 
  cheng_blood_count %>% 
  left_join(lm_normalization_factors) %>% 
  mutate(just_count = 10 ^ (k * log10(tpm) + m)) %>% 
  mutate(just_count = ifelse(just_count < 0, 0, just_count)) %>% 
  left_join(RP_tmm_coefs) %>%
  mutate(RP_tmm = ratio * count) %>% 
  group_by(celltype) %>% 
  mutate(sum_tmm2 = sum(RP_tmm)) %>%
  ungroup() %>% 
  mutate(mean_sum_tmm2 = mean(sum_tmm2), 
         RP_tmm = 1000000 * RP_tmm / mean_sum_tmm2)

cheng_blood_count_2 %>% 
  filter(just_count > 4) %>%
  {ggplot(., aes(celltype, tpm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      
      ggplot(., aes(celltype, just_count, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet + 
      
      ggplot(., aes(celltype, tmm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      
      stripped_theme_facet + 
      
      ggplot(., aes(celltype, RP_tmm, fill = celltype)) + 
      geom_violin(draw_quantiles = 0.5, color = "white") + 
      geom_point(data = . %>%
                   filter(gene_name %in% RP_cluster$node)) +
      geom_line(data = . %>%
                  filter(gene_name %in% RP_cluster$node), 
                aes(group = gene_name)) +
      coord_flip() +
      scale_y_log10() +
      # scale_y_continuous(limits = c(1, 25)) +
      scale_fill_manual(values = celltype_pal) +
      
      stripped_theme_facet +
      plot_layout(ncol = 1)}

ggsave(savepath("distribution different normalization.pdf"), width = 8, height = 12)
```


```{r distribution, echo=FALSE, message=FALSE, warning=FALSE}
cheng_blood_data %>%
{ggplot(., aes(celltype, tpm, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5) + 
    
    coord_flip() +
    scale_y_log10() +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet +
    
    ggplot(., aes(celltype, tmm, fill = celltype)) + 
    geom_violin(draw_quantiles = 0.5) + 
    
    coord_flip() +
    scale_y_log10() +
    scale_fill_manual(values = celltype_pal) +
    
    stripped_theme_facet + 
    
    plot_layout(ncol = 1)}

cheng_blood_data %>% 
  mutate(is_zero = tpm == 0) %>%
  group_by(celltype, is_zero) %>% 
  summarise(n = n()) %>%
  ggplot(aes(celltype, n, fill = is_zero)) + 
  geom_col() + 
  coord_flip()

cheng_blood_data %>% 
  mutate(ratio = tmm / tpm) %>% 
  filter(is.finite(ratio)) %>% 
  group_by(celltype) %>% 
  summarise(ratio = mean(ratio))

cheng_blood_data %>% 
  select(-tpm) %>%
  spread(celltype, tmm) %>% 
  column_to_rownames("gene_name") %>% 
  cor(method = "spearman") %>% 
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

cheng_blood_data %>% 
  select(-tmm) %>%
  spread(celltype, tpm) %>% 
  column_to_rownames("gene_name") %>% 
  cor(method = "spearman") %>% 
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")


cheng_propr_tpm <-
  cheng_blood_data %>% 
  select(-tmm) %>%
  spread(celltype, tpm) %>% 
  column_to_rownames("gene_name") %>% 
  propr() 

cheng_propr_tmm <-
  cheng_blood_data %>% 
  select(-tpm) %>%
  spread(celltype, tmm) %>% 
  column_to_rownames("gene_name") %>% 
  propr() 

cheng_propr_tpm@matrix %>%
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

cheng_propr_tmm@matrix %>%
  pheatmap(color = heatmap_palette, 
           clustering_method = "ward.D2")

 
gene_propr_tpm <-
  cheng_blood_data %>% 
  select(-tmm) %>%
  group_by(gene_name) %>% 
  mutate(has_zero = any(tpm == 0)) %>% 
  ungroup() %>% 
  filter(!has_zero) %>%
  select(-has_zero) %>%
  spread(gene_name, tpm) %>% 
  column_to_rownames("celltype") %>% 
  propr() 
save(gene_propr_tpm, file =  "data/gene propr tpm.Rdata")

gene_propr_res <- 
  gene_propr_tpm@matrix %>%
  as_tibble(rownames = "gene_name1") %>% 
  gather(gene_name2, prop, -1) 


# gene_propr_res %>% 
#   ggplot(aes(prop)) + 
#   geom_density()

gene_propr_res_filtered <- 
  gene_propr_res %>% 
  filter(gene_name1 > gene_name2) %>% 
  filter(prop > 0.9)


```


##Normalization

```{r normalization, echo=FALSE, message=FALSE, warning=FALSE}


blood_TMM_wide <- 
  blood_TPM_wide %>%
  column_to_rownames("ensg_id") %>% 
  {log10(. + 1)} %>% 
  tmm_norm_median_ref() %>% 
  {10^. - 1}

blood_TMM_long <- 
  blood_TMM_wide %>% 
  as_tibble(rownames = "ensg_id") %>% 
  gather(sample, tmm, -1) %>% 
  mutate(individual = str_extract(sample, "^bd\\d"),
         celltype = gsub("^bd\\d_", "", sample)) %>% 
  select(sample, individual, celltype, ensg_id, tmm)

blood_TPM_long <- 
  blood_TPM_wide %>% 
  gather(sample, tpm, -1) %>% 
  mutate(individual = str_extract(sample, "^bd\\d"),
         celltype = gsub("^bd\\d_", "", sample)) %>% 
  select(sample, individual, celltype, ensg_id, tpm)


blood_TPM_long %>%
  ggplot(aes(individual, tpm, fill = celltype)) +
  geom_violin(draw_quantiles = 0.5, 
              show.legend = F) + 
  
  facet_wrap(~celltype) +
  
  stripped_theme +
  scale_fill_manual(values = blood_pal) + 
  scale_y_log10() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        panel.spacing = unit(0, "mm"))

blood_TMM_long %>%
  ggplot(aes(individual, tmm, fill = celltype)) +
  geom_violin(draw_quantiles = 0.5, 
              show.legend = F) + 
  
  facet_wrap(~celltype) +
  
  stripped_theme +
  scale_fill_manual(values = blood_pal) + 
  scale_y_log10() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        panel.spacing = unit(0, "mm"))

imputed_samples <- 
  blood_TMM_long %>% 
  select(celltype) %>% 
  unique() %$%
  crossing(bd = paste0("bd", 1:6), celltype) %>% 
  unite(sample, c("bd", "celltype")) %>%
  mutate(imputed = !sample %in% blood_TMM_long$sample)
  

blood_TMM_wide
imputed_samples %>% 
  left_join(blood_TMM_long) %>% 
  select(sample, ensg_id, tmm) %>% 
  spread(sample, tmm) %>% 
  column_to_rownames("ensg_id")
```

##ANOVA test



```{r}

filtered_genes <- 
  blood_class %>%
  filter(specificity_category %in% c("Low tissue specificity", "Not detected")) %>%
  pull(ensg_id)


ANOVA_res <- 
  blood_TMM_long %>%
  group_by(ensg_id) %>%
  mutate(mean_tmm = mean(tmm, na.rm = T)) %>%
  ungroup() %>% 
  filter(mean_tmm > 10) %>%
  filter(celltype != "total_pbmcs") %>%
  filter(!ensg_id %in% filtered_genes) %>%
  mutate(tmm = log2(tmm + 1)) %>%
  group_by(ensg_id) %>%
  do({
    
    g_data <- .
    saved_data <<- g_data
    
    
    md1 <- aov(tmm ~ individual + celltype,
               data = g_data)
    
    TukeyHSD(x = md1, "celltype")$celltype %>% 
      as_tibble(rownames = "contrast")
    
    
  }) %>% 
  group_by(contrast) %>%
  mutate(p_adj = p.adjust(`p adj`))


anova_genes <- 
  ANOVA_res %>%
  ungroup() %>%
  filter(p_adj < 0.05) %>%
  filter(abs(diff) > 2 & abs(diff) < 10) %>%
  arrange(-abs(diff)) %>%
  group_by(contrast) %>%
  top_n(10, diff) %>% 
  pull(ensg_id) %>%
  unique()
  

```



##Deconvolution

###Method 1

```{r decon_func}

deconvolute_cells <- 
  function(X, Y, sum_1 = TRUE) {
    
    # coef_n >= 0
    if(!sum_1) {
      Amat = diag(ncol(X))
      bvec = rep(0,ncol(X))
      meq = 0
    }
    
    # sum(coef) = 1 & coef_n >= 0
    if(sum_1) {
      Amat = cbind(rep(1,ncol(X)), diag(ncol(X)))
      bvec = c(1,rep(0,ncol(X)))
      meq = 1
    }
    
    
    
    solve.QP(Dmat = solve(chol(t(X) %*% X)), 
             factorized = T, 
             dvec = t(Y) %*% X, 
             Amat = Amat, 
             bvec = bvec, 
             meq = meq)
  }
 




```

```{r define_genes}



blood_TMM_long_scaled <- 
  blood_TMM_long %>%
  group_by(ensg_id) %>%
  mutate(scaled_tmm = tmm / max(tmm)) %>% 
  group_by(ensg_id, celltype) %>%
  mutate(CV = 100 * sd(tmm, na.rm = T) / mean(tmm, na.rm = T)) 

blood_TMM_long_scaled %>% 
  ggplot(aes(celltype, CV, fill = celltype)) +
  geom_violin(draw_quantiles = 0.5) + 
  stripped_theme + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  scale_fill_manual(values = blood_pal) 

blood_TMM_long_scaled_dist <- 
  blood_TMM_long_scaled %>%
  
  ungroup() %>%
  # filter(ensg_id %in% head(ensg_id, 100)) %>%
  filter(is.finite(tmm)) %>%
  group_by(ensg_id) %>% 
  mutate(min_CV = min(CV)) %>%
  ungroup() %>%
  filter(min_CV < 20) %>%
  select(individual, celltype, ensg_id, tmm) %>%
  spread(celltype, tmm) %>%
  group_by(ensg_id) %>% 
  do({
    g_data <- .
    saved_data <<- .
    
    g_data %>%
      select(-1, -2) %>%
      t() %>%
      dist() %>% 
      as.matrix() %>%
      as_tibble(rownames = "celltype")
    
  })
 
  
genes <- 
  c(blood_TMM_long_scaled_dist %>%
      ungroup() %>%
      gather(celltype2, dist, -1, -2) %>%
      filter(dist > 0) %>%
      group_by(celltype, celltype2) %>%
      top_n(20, dist) %>% 
      pull(ensg_id),
    
    blood_class %>% 
      filter(ts_score > 0) %>%
      separate_rows(enhanced_tissues, sep = ",") %>% 
      group_by(enhanced_tissues, specificity_category) %>% 
      top_n(20, ts_score) %>% 
      pull(ensg_id)) %>%
  unique()



length(genes)


```


```{r method1}

quad_data <- 
  blood_TMM_long %>%
  # filter(individual == "bd3") %>%
  
  group_by(ensg_id, individual) %>% 
  mutate(max_tmm = max(tmm), 
         min_tmm = min(tmm),
         sd_tmm = sd(tmm),
         fract_zero = length(which(tmm == 0)) / length(tmm),
         pbmc_tmm = tmm[which(celltype == "total_pbmcs")]) %>%
  group_by(ensg_id) %>% 
  mutate(pbmc_tmm_max = max(tmm[which(celltype == "total_pbmcs")])) %>%
  ungroup() %>%
  # filter(pbmc_tmm >= 1) %>% 
  mutate(scaled_tmm = tmm / pbmc_tmm_max) 



quad_res <-
  tibble(n_genes = 10:100) %>%
  group_by(n_genes) %>%
  do({
    n_genes <- .
    genes <- 
      c(blood_TMM_long_scaled_dist %>%
          ungroup() %>%
          gather(celltype2, dist, -1, -2) %>%
          filter(dist > 0) %>%
          group_by(celltype, celltype2) %>%
          top_n(n_genes, dist) %>% 
          pull(ensg_id),
        
        blood_class %>% 
          filter(ts_score > 0) %>%
          separate_rows(enhanced_tissues, sep = ",") %>% 
          group_by(enhanced_tissues, specificity_category) %>% 
          top_n(n_genes, ts_score) %>% 
          pull(ensg_id)) %>%
      unique()
    
    quad_data %>% 
      filter(ensg_id %in% genes) %>%
      # filter(ensg_id %in% sample(unique(ensg_id), 10000)) %>%
      #mutate(is_PBMC = celltype == "total_pbmcs") %>% 
      select(celltype, ensg_id, scaled_tmm, individual) %>%
      spread(celltype, scaled_tmm) %>%
      select(-ensg_id) %>% 
      group_by(individual) %>% 
      
      
      do({
        
        g_data <- .
        saved_data <<- g_data
        
        g_data_filt <- 
          g_data %>% 
          select(-1) %>%
          select_if(function(x) !all(is.na(x))) %>% 
          filter(complete.cases(.))
        
        Y <- 
          g_data_filt$total_pbmcs
        X <- 
          g_data_filt %>% 
          select(-total_pbmcs) %>%
          as.matrix()
        
        tibble(celltype = colnames(X), 
               fract = deconvolute_cells(X, Y)$solution) 
      }) %>% 
      group_by(celltype) %>% 
      mutate(mean_fract = mean(fract), 
             cv_frace = 100 * sd(fract) / mean_fract) %>% 
      ungroup()
  })
  
quad_res %>%
  ggplot(aes(n_genes, 100 * fract, color = celltype)) +
  geom_line(show.legend = F) + 
  stripped_theme + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  scale_color_manual(values = blood_pal) + 
  facet_wrap(~individual)

quad_res %>%
  filter(n_genes == 10) %>%
  mutate(celltype = factor(celltype, levels = unique(celltype[order(mean_fract)]))) %>% 
  {ggplot(., aes(celltype, fract, fill = celltype)) + 
      geom_col(show.legend = F) + 
      geom_text(aes(label = paste0(round(100*fract, 1), " %")),
                vjust = -0.5) +
      stripped_theme + 
      theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
      scale_fill_manual(values = blood_pal) + 
      facet_wrap(~individual)}


quad_res %>%
  filter(n_genes == 10) %>%
  mutate(celltype = factor(celltype, levels = unique(celltype[order(mean_fract)]))) %>% 
  # {ggplot(., aes(1, fract, fill = celltype)) + 
  #     geom_col(show.legend = F) + 
  #     geom_text(aes(label = paste0(round(100*fract, 1), " %")),
  #               vjust = -0.5) +
  #     stripped_theme + 
  #     theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  #     scale_fill_manual(values = blood_pal) + 
  #     facet_wrap(~individual)}

  # ggplot(aes("", n_genes, fill = spec_category)) +
  ggplot(aes("", fract, fill = celltype)) +
    geom_bar(stat = "identity",
             show.legend = F,
             color = "white",
             size = 1)+
    geom_text(aes(label = paste0(round(100*fract, 1), " %")),
              position = position_stack(vjust = 0.5),
              color = "black",
              size = 4)+
    # geom_text(aes(x = 1.5, y = n_genes, label = spec_category),
    #           position = position_stack(vjust = 0.5),
    #           color = "black",
    #           size = 4)+
    facet_wrap(~individual) +
    coord_polar("y", start = 0)+
    scale_fill_manual(values = blood_pal) +
    theme_void()


```

###Method 2 - ANOVA genes


```{r method2}



quad_data <-
  blood_TMM_long %>% 
  filter(!celltype %in% c("basophils", "neutrophils", "eosinophils")) %>%
  filter(ensg_id %in% anova_genes) %>%
  group_by(ensg_id) %>% 
  mutate(sd_tmm = sd(tmm, na.rm = T), 
         mean_tmm = mean(tmm, na.rm = T),
         mean_tmm_sd_scaled = tmm / sd_tmm,
         auto_tmm = (tmm - mean_tmm) / sd_tmm, 
         range_tmm = tmm / max(tmm)) %>%
  group_by(ensg_id, individual) %>% 
  mutate(pbmc_tmm = tmm[which(celltype == "total_pbmcs")],
         pbmc_scaled_tmm = tmm / pbmc_tmm) %>%
  ungroup() %>%
  filter(sd_tmm > 0) 
  
  
  
  
  

quad_res <-
  
  
  quad_data %>% 
  
  # mutate(scaled_tmm = tmm /10) %>%
  select(celltype, 
         ensg_id, 
         individual,
         value = pbmc_scaled_tmm) %>%
  group_by(ensg_id) %>%
  mutate(invalid = any(!is.finite(value))) %>%
  ungroup() %>%
  filter(!invalid) %>%
  select(-invalid) %>%
  
  spread(celltype, value) %>%
  gather(celltype, value, -1, -2) %>%
  
  group_by(celltype, ensg_id) %>%
  mutate(mean_val = mean(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(value = ifelse(celltype == "total_pbmcs", value, value)) %>%
  select(-mean_val) %>%
  spread(celltype, value) %>%
  select(-ensg_id) %>% 
  group_by(individual) %>% 
  
  
  do({
    
    g_data <- .
    saved_data <<- g_data
    
    g_data_filt <- 
      g_data %>% 
      select(-1) %>%
      select_if(function(x) !all(is.na(x))) %>% 
      filter(complete.cases(.))
    
    Y <- 
      g_data_filt$total_pbmcs
    X <- 
      g_data_filt %>% 
      select(-total_pbmcs) %>%
      as.matrix()
    
    tibble(celltype = colnames(X), 
           fract = deconvolute_cells(X, Y)$solution) 
  }) %>% 
  group_by(celltype) %>% 
  mutate(mean_fract = mean(fract), 
         cv_fract = 100 * sd(fract) / mean_fract) %>% 
  ungroup()
  


quad_res %>%
  mutate(celltype = factor(celltype, levels = unique(celltype[order(mean_fract)]))) %>% 
  {ggplot(., aes(celltype, fract, fill = celltype)) + 
      geom_col(show.legend = F) + 
      geom_text(aes(label = paste0(round(100*fract, 1), " %")),
                vjust = -0.5) +
      stripped_theme + 
      theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
      scale_fill_manual(values = blood_pal) + 
      facet_wrap(~individual)}


quad_res %>%
  mutate(celltype = factor(celltype, levels = unique(celltype[order(mean_fract)]))) %>% 
  # {ggplot(., aes(1, fract, fill = celltype)) + 
  #     geom_col(show.legend = F) + 
  #     geom_text(aes(label = paste0(round(100*fract, 1), " %")),
  #               vjust = -0.5) +
  #     stripped_theme + 
  #     theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  #     scale_fill_manual(values = blood_pal) + 
  #     facet_wrap(~individual)}

  # ggplot(aes("", n_genes, fill = spec_category)) +
  ggplot(aes("", fract, fill = celltype)) +
    geom_bar(stat = "identity",
             show.legend = F,
             color = "white",
             size = 1)+
    geom_text(aes(label = paste0(round(100*fract, 1), " %")),
              position = position_stack(vjust = 0.5),
              color = "black",
              size = 4)+
    # geom_text(aes(x = 1.5, y = n_genes, label = spec_category),
    #           position = position_stack(vjust = 0.5),
    #           color = "black",
    #           size = 4)+
    facet_wrap(~individual) +
    coord_polar("y", start = 0)+
    scale_fill_manual(values = blood_pal) +
    theme_void()


```

## Gene correlation

```{r}


id_translation_dict <-
  tibble(name = c('basophils', 
                  'eosinophils', 
                  'classical_monocytes', 
                  'intermediate_monocytes', 
                  'non_classical_monocytes', 
                  'mait', 
                  'gdT', 
                  'plasmacytoid_dc',
                  'myeloid_dc',
                  'naive_b',
                  'memory_b',
                  'nk',
                  'memory_cd4',
                  'naive_cd4',
                  'naive_cd8',
                  'memory_cd8',
                  'tregs',
                  'neutrophils'), 
         name2 = c('basophil',
                   'eosinophil',
                   'classical monocyte',
                   'intermediate monocyte',
                   'non-classical monocyte',
                   'MAIT T-cell',
                   'gdTCR',
                   'plasmacytoid DC',
                   'myeloid DC',
                   'naive B-cell',
                   'memory B-cell',
                   'NK-cell',
                   'memory CD4 T-cell',
                   'naive CD4 T-cell',
                   'naive CD8 T-cell',
                   'memory CD8 T-cell',
                   'T-reg',
                   'neutrophil'), 
         color = c('#F7BCA9',
                   '#F39B7F',
                   '#EE8778',
                   '#E64B35',
                   '#993223',
                   '#A4B0C8',
                   '#C3CADA',
                   '#007F6B',
                   '#32B39F',
                   '#7F348B',
                   '#4D1E73',
                   '#ad1d78',
                   '#697BA3',
                   '#2E4068',
                   '#243353',
                   '#4A6191',
                   '#121929',
                   '#A26754'))

blood_pal2 <- 
  id_translation_dict %$%
  set_names(color, name2)

plot_genes <- 
  
  blood_class %>%
  filter(!grepl(",", enhanced_tissues))  %>%
  filter(specificity_category == "Tissue enriched") %>%
  filter(!is.na(enhanced_tissues)) %>% 
  head(1000)
  

cor_data <- 
  blood_TMM_long %>%
  filter(ensg_id %in% plot_genes$ensg_id) %>%
  filter(celltype == "total_pbmcs") %>%
  group_by(ensg_id) %>%
  mutate(sd = sd(tmm, na.rm = T)) %>%
  ungroup() %>% 
  filter(sd > 0) %>%
  select(sample, ensg_id, tmm) %>% 
  spread(ensg_id, tmm) %>% 
  column_to_rownames("sample")

cor_res <- 
  cor_data %>%
  {log10( . + 1)} %>%
  cor(method = "pearson")

library(pheatmap)
cor_annotation <- 
  plot_genes %>% 
  
  filter(ensg_id %in% colnames(cor_res)) %>%
  select(1, 2, 6) %>%
  column_to_rownames("ensg_id")

cor_res %>% 
  pheatmap(show_rownames = F,
           show_colnames = F, 
           clustering_method = "ward.D2",
           annotation_row = cor_annotation, 
           annotation_colors = list(enhanced_tissues = blood_pal2),
           filename = "test3.pdf", 
           width = 10, height = 10)

cor_res %>% 
  {. ^ 2} %>%
  pheatmap(show_rownames = F,
           show_colnames = F, 
           clustering_method = "average",
           annotation_row = cor_annotation, 
           annotation_colors = list(enhanced_tissues = blood_pal2),
           filename = "test2 spear4.pdf", 
           width = 10, height = 10)

```

```{r}
library(energy)
require(pheatmap)

plot_genes <- 
  
  blood_class %>%
  filter(!grepl(",", enhanced_tissues))  %>%
  filter(specificity_category == "Tissue enriched") %>%
  filter(!is.na(enhanced_tissues)) %>% 
  head(100)
  

cor_data <- 
  blood_TMM_long %>%
  filter(ensg_id %in% plot_genes$ensg_id) %>%
  filter(celltype == "total_pbmcs") %>%
  group_by(ensg_id) %>%
  mutate(sd = sd(tmm, na.rm = T)) %>%
  ungroup() %>% 
  filter(sd > 0) %>%
  select(sample, ensg_id, tmm) %>% 
  mutate(tmm = log10(tmm + 1))

cor_anova_data <- 
  unique(cor_data$ensg_id) %>%
  combn(2) %>% 
  t() %>%
  as_tibble() %>% 
  left_join(cor_data,
            by = c("V1" = "ensg_id")) %>% 
  left_join(cor_data,
            by = c("V2" = "ensg_id", 
                   "sample"),
            suffix = c("1", "2"))



cor_dist_res <- 
  cor_anova_data %>%
  group_by(V1, V2) %>%
  do({
    g_data <- .
    saved_data <<- g_data
    
    g_data %$%
      DCOR(tmm1, tmm2) %>% 
      as_tibble()
    
  })

cor_annotation <- 
  plot_genes %>% 
  
  filter(ensg_id %in% c(cor_dist_res$V1, cor_dist_res$V2)) %>%
  select(1, 2, 6) %>%
  column_to_rownames("ensg_id")

cor_dist_res %>% 
  select(V1, V2, dCor) %>%
  bind_rows(tibble(V1 = .$V2, 
                   V2 = .$V1, 
                   dCor = .$dCor)) %>%
  bind_rows(tibble(V1 = unique(.$V1), 
                   V2 = unique(.$V1), 
                   dCor = 1)) %>%
  spread(V2, dCor) %>% 
  column_to_rownames("V1") %>%
  pheatmap(show_rownames = F,
           show_colnames = F, 
           clustering_method = "ward.D2",
           annotation_row = cor_annotation,
           annotation_colors = list(enhanced_tissues = blood_pal2),
           filename = "test3 cor dist.pdf", 
           width = 10, height = 10)




####


```

```{r}


require(propr)
require(pheatmap)

plot_genes <- 
  
  blood_class %>%
  filter(!grepl(",", enhanced_tissues))  %>%
  head(200)

propr_data <- 
  blood_TMM_long %>%
  filter(ensg_id %in% plot_genes$ensg_id) %>%
  filter(celltype == "total_pbmcs") %>%
  group_by(ensg_id) %>%
  mutate(sd = sd(tmm, na.rm = T)) %>%
  ungroup() %>% 
  filter(sd > 0) %>%
  select(sample, ensg_id, tmm) %>% 
  spread(ensg_id, tmm) %>%
  column_to_rownames("sample")
    


propr_res <- 
  propr(propr_data + 1, metric = "phs")

propr_res@matrix

propr_annotation <- 
  plot_genes %>% 
  
  filter(ensg_id %in% colnames(propr_res@matrix)) %>%
  select(1, 2, 6) %>%
  column_to_rownames("ensg_id")

propr_res@matrix %>%
  {log10(. + 1)} %>%
  pheatmap(show_rownames = F,
           show_colnames = F,
           clustering_method = "ward.D2",
           annotation_row = propr_annotation,
           annotation_colors = list(enhanced_tissues = c(blood_pal2, "NA" = "white")),
           # filename = "test propr.pdf",
           width = 10, height = 10)

require(umap)
require(patchwork)
propr_umap <- 
  propr_res@matrix %>%
  {log10(. + 1)} %>%
  umap(n_components = 2,
       n_epochs = 200,
       n_neighbors = 10)

umap_plot <- 
  propr_umap$layout %>% 
  as_tibble(rownames = "ensg_id") %>% 
  left_join(plot_genes, 
            by = "ensg_id") %>%
  mutate(enhanced_tissues = ifelse(is.na(enhanced_tissues), 
                                   "no", 
                                   enhanced_tissues)) %>%
  filter(enhanced_tissues != "no") %>%
            {ggplot(., aes(V1, V2, color = specificity_category)) + 
                geom_point() + 
                ggplot(., aes(V1, V2, color = enhanced_tissues)) + 
                geom_point() + 
                scale_color_manual(values = c(blood_pal2, "no" = "white"))}

ggsave("umap_plot2.pdf", umap_plot, 
           width = 20, height = 10)
```

